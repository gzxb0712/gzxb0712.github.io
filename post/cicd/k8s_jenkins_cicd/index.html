<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>k8s安装jenkins最佳实践 - Bill World</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="gzxb0712" /><meta name="description" content="注意下访问url： http://192.168.2.11:32001/jenkins http://jenkins.test.com/jenkins/ 参考博客 http://www.mydlq.club/article/47/ 目录[-] . 一、Kubernetes 部署 Jenkins . 1、NFS 存储卷创建 Jenkins 目录 . 2、创建 Jenkins 用于存储的 PV、PVC . 3" /><meta name="keywords" content="Mac, Github, Vue, React, Front End" />






<meta name="generator" content="Hugo 0.74.3 with theme even" />


<link rel="canonical" href="https://xiebiao.top/post/cicd/k8s_jenkins_cicd/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.651e6917abb0239242daa570c2bec9867267bbcd83646da5a850afe573347b44.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/reset-even.css">


<meta property="og:title" content="k8s安装jenkins最佳实践" />
<meta property="og:description" content="注意下访问url： http://192.168.2.11:32001/jenkins http://jenkins.test.com/jenkins/ 参考博客 http://www.mydlq.club/article/47/ 目录[-] . 一、Kubernetes 部署 Jenkins . 1、NFS 存储卷创建 Jenkins 目录 . 2、创建 Jenkins 用于存储的 PV、PVC . 3" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiebiao.top/post/cicd/k8s_jenkins_cicd/" />
<meta property="article:published_time" content="2020-07-05T19:01:30+00:00" />
<meta property="article:modified_time" content="2020-07-05T19:01:30+00:00" />
<meta itemprop="name" content="k8s安装jenkins最佳实践">
<meta itemprop="description" content="注意下访问url： http://192.168.2.11:32001/jenkins http://jenkins.test.com/jenkins/ 参考博客 http://www.mydlq.club/article/47/ 目录[-] . 一、Kubernetes 部署 Jenkins . 1、NFS 存储卷创建 Jenkins 目录 . 2、创建 Jenkins 用于存储的 PV、PVC . 3">
<meta itemprop="datePublished" content="2020-07-05T19:01:30+00:00" />
<meta itemprop="dateModified" content="2020-07-05T19:01:30+00:00" />
<meta itemprop="wordCount" content="16865">



<meta itemprop="keywords" content="jenkins,cicd," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="k8s安装jenkins最佳实践"/>
<meta name="twitter:description" content="注意下访问url： http://192.168.2.11:32001/jenkins http://jenkins.test.com/jenkins/ 参考博客 http://www.mydlq.club/article/47/ 目录[-] . 一、Kubernetes 部署 Jenkins . 1、NFS 存储卷创建 Jenkins 目录 . 2、创建 Jenkins 用于存储的 PV、PVC . 3"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Bill World</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Bill World</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">k8s安装jenkins最佳实践</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-07-05 19:01 </span>
        <div class="post-category">
            <a href="/categories/cicd/"> cicd </a>
            </div>
          <span class="more-meta"> 约 16865 字 </span>
          <span class="more-meta"> 预计阅读 34 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一kubernetes-部署-jenkins">一、Kubernetes 部署 Jenkins</a>
      <ul>
        <li><a href="#1nfs-存储卷创建-jenkins-目录">1、NFS 存储卷创建 Jenkins 目录</a></li>
        <li><a href="#2创建-jenkins-用于存储的-pvpvc">2、创建 Jenkins 用于存储的 PV、PVC</a></li>
        <li><a href="#3创建-serviceaccount--clusterrolebinding">3、创建 ServiceAccount &amp; ClusterRoleBinding</a></li>
        <li><a href="#4创建-service--deployment">4、创建 Service &amp; Deployment</a></li>
        <li><a href="#5获取-jenkins-生成的-token">5、获取 Jenkins 生成的 Token</a></li>
        <li><a href="#6启动-jenkins-进行初始化">6、启动 Jenkins 进行初始化</a></li>
      </ul>
    </li>
    <li><a href="#二jenkins-安装相关插件">二、Jenkins 安装相关插件</a></li>
    <li><a href="#三配置相关凭据">三、配置相关凭据</a>
      <ul>
        <li><a href="#1添加-git-认证凭据">1、添加 Git 认证凭据</a></li>
        <li><a href="#2添加-kubernetes-token-凭据">2、添加 Kubernetes Token 凭据</a></li>
        <li><a href="#3添加-docker-仓库认证凭据">3、添加 Docker 仓库认证凭据</a></li>
      </ul>
    </li>
    <li><a href="#四jenkins-配置-kubernetes-插件">四、Jenkins 配置 Kubernetes 插件</a>
      <ul>
        <li><a href="#1kubernetes-plugin-基本配置">1、Kubernetes Plugin 基本配置</a></li>
        <li><a href="#2kubernetes-插件-pod-模板配置">2、Kubernetes 插件 Pod 模板配置</a></li>
        <li><a href="#3kubernetes-插件-container-配置">3、Kubernetes 插件 Container 配置</a></li>
        <li><a href="#4container-存储挂载配置">4、Container 存储挂载配置</a></li>
      </ul>
    </li>
    <li><a href="#五创建相关文件">五、创建相关文件</a>
      <ul>
        <li><a href="#1新增-maven-配置文件">1、新增 Maven 配置文件</a></li>
        <li><a href="#2新增-dockerfile-文件">2、新增 Dockerfile 文件</a></li>
        <li><a href="#3新增-kubernetes-部署文件">3、新增 Kubernetes 部署文件</a></li>
      </ul>
    </li>
    <li><a href="#六如何写流水线脚本和使用插件">六、如何写流水线脚本和使用插件</a>
      <ul>
        <li><a href="#1脚本中设置全局超时时间">1、脚本中设置全局超时时间</a></li>
        <li><a href="#2脚本中使用-git-插件">2、脚本中使用 Git 插件</a></li>
        <li><a href="#3脚本中使用-kubernetes-插件">3、脚本中使用 Kubernetes 插件</a></li>
        <li><a href="#4脚本中使用-docker-镜像">4、脚本中使用 Docker 镜像</a></li>
        <li><a href="#5脚本中引入-jenkins-中预先存储的文件">5、脚本中引入 Jenkins 中预先存储的文件</a></li>
        <li><a href="#6脚本创建文件">6、脚本创建文件</a></li>
        <li><a href="#7脚本中使用-http-rrequest-插件">7、脚本中使用 Http Rrequest 插件</a></li>
        <li><a href="#8脚本中使用-kubernetes-cli-插件">8、脚本中使用 Kubernetes Cli 插件</a></li>
        <li><a href="#9脚本中操作字符串替换值">9、脚本中操作字符串替换值</a></li>
        <li><a href="#10脚本中读取-pomxml-参数">10、脚本中读取 pom.xml 参数</a></li>
        <li><a href="#11脚本中使用-docker-插件构建与推送镜像">11、脚本中使用 Docker 插件构建与推送镜像</a></li>
      </ul>
    </li>
    <li><a href="#七在-jenkins-创建模板任务">七、在 Jenkins 创建模板任务</a>
      <ul>
        <li><a href="#1创建-pipeline-任务">1、创建 Pipeline 任务</a></li>
        <li><a href="#2配置项目构建基本参数">2、配置项目构建基本参数</a></li>
        <li><a href="#3配置-git-变量">3、配置 Git 变量</a></li>
        <li><a href="#4配置-maven-变量">4、配置 Maven 变量</a></li>
        <li><a href="#5配置-docker-变量">5、配置 Docker 变量</a></li>
        <li><a href="#6配置-kubernetes-变量">6、配置 Kubernetes 变量</a></li>
        <li><a href="#7配置-http-变量">7、配置 HTTP 变量</a></li>
      </ul>
    </li>
    <li><a href="#八创建-pipeline-脚本">八、创建 Pipeline 脚本</a>
      <ul>
        <li><a href="#1脚本中使用-kubernetes-插件及设置超时时间">1、脚本中使用 Kubernetes 插件及设置超时时间</a></li>
        <li><a href="#2脚本中-git-拉取项目阶段">2、脚本中 Git 拉取项目阶段</a></li>
        <li><a href="#3脚本中-maven-编译项目阶段">3、脚本中 Maven 编译项目阶段</a></li>
        <li><a href="#4脚本中读取-pomxml-参数阶段">4、脚本中读取 pom.xml 参数阶段</a></li>
        <li><a href="#5脚本中-docker-镜像构建与推送模块">5、脚本中 Docker 镜像构建与推送模块</a></li>
        <li><a href="#6kubernetes-模块">6、Kubernetes 模块</a></li>
        <li><a href="#7http-健康检查模块">7、HTTP 健康检查模块</a></li>
        <li><a href="#8完整脚本">8、完整脚本</a></li>
      </ul>
    </li>
    <li><a href="#九创建任务从模板任务复制配置">九、创建任务从模板任务复制配置</a>
      <ul>
        <li><a href="#1创建新的-job-并复制模板项目配置">1、创建新的 Job 并复制模板项目配置</a></li>
        <li><a href="#2修改新建-job-的部分配置项">2、修改新建 Job 的部分配置项</a></li>
      </ul>
    </li>
    <li><a href="#十执行-pipeline-任务进行测试">十、执行 pipeline 任务进行测试</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>注意下访问url：
http://192.168.2.11:32001/jenkins
<a href="http://jenkins.test.com/jenkins/">http://jenkins.test.com/jenkins/</a></p>
<blockquote>
<p>参考博客<br>
<a href="http://www.mydlq.club/article/47/">http://www.mydlq.club/article/47/</a></p>
</blockquote>
<p><strong>目录[-]</strong></p>
<ul>
<li><a href="#wow0">. 一、Kubernetes 部署 Jenkins</a></li>
<li><a href="#wow1">. 1、NFS 存储卷创建 Jenkins 目录</a></li>
<li><a href="#wow2">. 2、创建 Jenkins 用于存储的 PV、PVC</a></li>
<li><a href="#wow3">. 3、创建 ServiceAccount &amp; ClusterRoleBinding</a></li>
<li><a href="#wow4">. 4、创建 Service &amp; Deployment</a></li>
<li><a href="#wow5">. 5、获取 Jenkins 生成的 Token</a></li>
<li><a href="#wow6">. 6、启动 Jenkins 进行初始化</a></li>
<li><a href="#wow7">. 二、Jenkins 安装相关插件</a></li>
<li><a href="#wow8">. 三、配置相关凭据</a></li>
<li><a href="#wow9">. 1、添加 Git 认证凭据</a></li>
<li><a href="#wow10">. 2、添加 Kubernetes Token 凭据</a></li>
<li><a href="#wow11">. 3、添加 Docker 仓库认证凭据</a></li>
<li><a href="#wow12">. 四、Jenkins 配置 Kubernetes 插件</a></li>
<li><a href="#wow13">. 1、Kubernetes Plugin 基本配置</a></li>
<li><a href="#wow14">. 2、Kubernetes 插件 Pod 模板配置</a></li>
<li><a href="#wow15">. 3、Kubernetes 插件 Container 配置</a></li>
<li><a href="#wow16">. 4、Container 存储挂载配置</a></li>
<li><a href="#wow17">. 五、创建相关文件</a></li>
<li><a href="#wow18">. 1、新增 Maven 配置文件</a></li>
<li><a href="#wow19">. 2、新增 Dockerfile 文件</a></li>
<li><a href="#wow20">. 3、新增 Kubernetes 部署文件</a></li>
<li><a href="#wow21">. 六、如何写流水线脚本和使用插件</a></li>
<li><a href="#wow22">. 1、脚本中设置全局超时时间</a></li>
<li><a href="#wow23">. 2、脚本中使用 Git 插件</a></li>
<li><a href="#wow24">. 3、脚本中使用 Kubernetes 插件</a></li>
<li><a href="#wow25">. 4、脚本中使用 Docker 镜像</a></li>
<li><a href="#wow26">. 5、脚本中引入 Jenkins 中预先存储的文件</a></li>
<li><a href="#wow27">. 6、脚本创建文件</a></li>
<li><a href="#wow28">. 7、脚本中使用 Http Rrequest 插件</a></li>
<li><a href="#wow29">. 8、脚本中使用 Kubernetes Cli 插件</a></li>
<li><a href="#wow30">. 9、脚本中操作字符串替换值</a></li>
<li><a href="#wow31">. 10、脚本中读取 pom.xml 参数</a></li>
<li><a href="#wow32">. 11、脚本中使用 Docker 插件构建与推送镜像</a></li>
<li><a href="#wow33">. 七、在 Jenkins 创建模板任务</a></li>
<li><a href="#wow34">. 1、创建 Pipeline 任务</a></li>
<li><a href="#wow35">. 2、配置项目构建基本参数</a></li>
<li><a href="#wow36">. 3、配置 Git 变量</a></li>
<li><a href="#wow37">. 4、配置 Maven 变量</a></li>
<li><a href="#wow38">. 5、配置 Docker 变量</a></li>
<li><a href="#wow39">. 6、配置 Kubernetes 变量</a></li>
<li><a href="#wow40">. 7、配置 HTTP 变量</a></li>
<li><a href="#wow41">. 八、创建 Pipeline 脚本</a></li>
<li><a href="#wow42">. 1、脚本中使用 Kubernetes 插件及设置超时时间</a></li>
<li><a href="#wow43">. 2、脚本中 Git 拉取项目阶段</a></li>
<li><a href="#wow44">. 3、脚本中 Maven 编译项目阶段</a></li>
<li><a href="#wow45">. 4、脚本中读取 pom.xml 参数阶段</a></li>
<li><a href="#wow46">. 5、脚本中 Docker 镜像构建与推送模块</a></li>
<li><a href="#wow47">. 6、Kubernetes 模块</a></li>
<li><a href="#wow48">. 7、HTTP 健康检查模块</a></li>
<li><a href="#wow49">. 8、完整脚本</a></li>
<li><a href="#wow50">. 九、创建任务从模板任务复制配置</a></li>
<li><a href="#wow51">. 1、创建新的 Job 并复制模板项目配置</a></li>
<li><a href="#wow52">. 2、修改新建 Job 的部分配置项</a></li>
<li><a href="#wow53">. 十、执行 pipeline 任务进行测试</a></li>
</ul>
<hr>
<p><strong>系统环境：</strong></p>
<ul>
<li>Jenkins 版本：2.199</li>
<li>Kubernetes 版本：1.15.3</li>
</ul>
<p><strong>参考地址：</strong></p>
<ul>
<li><a href="https://jenkins.io/zh/">Jenkins 官方网址</a></li>
<li><a href="https://github.com/jenkinsci">Jenkins Github 网址</a></li>
<li><a href="https://github.com/jenkinsci/kubernetes-plugin">Jenkins Kubernetes 插件 Github 网址</a></li>
<li>示例的配置与部署文件的 Github 地址：<a href="https://github.com/my-dlq/blog-example/tree/master/jenkins/jenkins-ci&amp;cd">https://github.com/my-dlq/blog-example/tree/master/jenkins/jenkins-ci&amp;cd</a></li>
</ul>
<p><strong>CI/CD 流程图:</strong></p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-diagram.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-diagram.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>整个流程：</strong></p>
<ul>
<li>(1)、介绍了如何在 Kubernetes 部署 Jenkins。</li>
<li>(2)、介绍 Jenkins 中需要安装什么相关插件。</li>
<li>(3)、配置凭据，例如 Docker 仓库凭据、K8S 连接凭据、Git 认证凭据。</li>
<li>(4)、在 Jenkins 中存储执行流水线过程中的脚本，例如 Docker 的 Dockerfile、Maven 的 Settings.xml。</li>
<li>(5)、简介描述了如何写 “脚本式” 的流水线脚本，以及脚本中如何使用各种常用插件。</li>
<li>(6)、创建一个用于当做模板的 Job，对其进行一些参数化构建变量配置，方便后续全部的 Job 通过复制该模板 Job 来新建。</li>
<li>(7)、写流水线脚本，将分为 Git、Maven、Docker、Kubectl、Http 等几个阶段。写完脚本后放置到上面创建模板 Job 的脚本框框中。</li>
<li>(8)、通过复制模板 Job 来新创建用于测试的项目 Job，并且修改其中从模板 Job 复制过来的变量的参数，将其改成适用于该测试项目的参数值。</li>
<li>(9)、执行上面创建的测试项目的 Job，观察它是否能够正常执行完整个脚本，并且结果为成功。</li>
</ul>
<h2 id="一kubernetes-部署-jenkins">一、Kubernetes 部署 Jenkins</h2>
<p>下面是以 NFS 为存储卷的示例，将在 NFS 存储卷上创建 Jenkins 目录，然后创建 NFS 类型的 PV、PVC。</p>
<h3 id="1nfs-存储卷创建-jenkins-目录">1、NFS 存储卷创建 Jenkins 目录</h3>
<p>进入 NFS Server 服务器，然后再其存储目录下创建 Jenkins 目录，并且确保目录对其它用户有读写权限。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ mkdir /nfs/data/jenkins

</code></pre></td></tr></table>
</div>
</div><h3 id="2创建-jenkins-用于存储的-pvpvc">2、创建 Jenkins 用于存储的 PV、PVC</h3>
<p>创建 Kubernetes 的 PV、PVC 资源，其中 PV 用于与 NFS 关联，需要设置 NFS Server 服务器地址和挂载的路径，修改占用空间大小。而 PVC 则是与应用关联，方便应用与 NFS 绑定挂载，下面是 PV、PVC 的资源对象 yaml 文件。</p>
<p><strong>jenkins-storage.yaml</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>PersistentVolume<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">capacity</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">storage</span><span class="p">:</span><span class="w"> </span>50Gi<span class="w">
</span><span class="w">  </span><span class="k">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- ReadWriteOnce<span class="w">
</span><span class="w">  </span><span class="k">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span>Retain<span class="w">
</span><span class="w">  </span><span class="k">mountOptions</span><span class="p">:</span><span class="w">         </span><span class="c">#NFS挂载选项</span><span class="w">
</span><span class="w">    </span>- hard<span class="w">
</span><span class="w">    </span>- nfsvers=<span class="m">4.1</span><span class="w">
</span><span class="w">  </span><span class="k">nfs</span><span class="p">:</span><span class="w">                  </span><span class="c">#NFS设置</span><span class="w">
</span><span class="w">    </span><span class="k">path</span><span class="p">:</span><span class="w"> </span>/nfs/data/jenkins<span class="w">
</span><span class="w">    </span><span class="k">server</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.2.11</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>PersistentVolumeClaim<span class="w">
</span><span class="w"></span><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- ReadWriteOnce<span class="w">
</span><span class="w">  </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">requests</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">storage</span><span class="p">:</span><span class="w"> </span>50Gi<span class="w">     </span><span class="c">#存储空间大小</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>将 PV 与 PVC 部署到 Kubernetes 中：</p>
<ul>
<li>-n：指定 namespace</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ kubectl apply -f jenkins-storage.yaml -n public

</code></pre></td></tr></table>
</div>
</div><h3 id="3创建-serviceaccount--clusterrolebinding">3、创建 ServiceAccount &amp; ClusterRoleBinding</h3>
<p>Kubernetes 集群一般情况下都默认开启了 RBAC 权限，所以需要创建一个角色和服务账户，设置角色拥有一定权限，然后将角色与 ServiceAccount 绑定，最后将 ServiceAccount 与 Jenkins 绑定，这样来赋予 Jenkins 一定的权限，使其能够执行一些需要权限才能进行的操作。这里为了方便，将 cluster-admin 绑定到 ServiceAccount 来保证 Jenkins 拥有足够的权限。</p>
<ul>
<li><strong>注意：</strong> 请修改下面的 Namespace 参数，改成部署的 Jenkins 所在的 Namespace。</li>
</ul>
<p><strong>jenkins-rbac.yaml</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ServiceAccount<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins-admin<span class="w">       </span><span class="c">#ServiceAccount名</span><span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>mydlqcloud<span class="w">     </span><span class="c">#指定namespace，一定要修改成你自己的namespace</span><span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ClusterRoleBinding<span class="w">
</span><span class="w"></span><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>rbac.authorization.k8s.io/v1<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins-admin<span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w"></span><span class="k">subjects</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">kind</span><span class="p">:</span><span class="w"> </span>ServiceAccount<span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins-admin<span class="w">
</span><span class="w">    </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>mydlqcloud<span class="w">
</span><span class="w"></span><span class="k">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ClusterRole<span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>cluster-admin<span class="w">
</span><span class="w">  </span><span class="k">apiGroup</span><span class="p">:</span><span class="w"> </span>rbac.authorization.k8s.io<span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>将 Jenkins 的 RBAC 部署到 Kubernetes 中：</p>
<ul>
<li>-n：指定 namespace</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ kubectl apply -f jenkins-rbac.yaml -n public

</code></pre></td></tr></table>
</div>
</div><h3 id="4创建-service--deployment">4、创建 Service &amp; Deployment</h3>
<p>在 Kubernetes 中部署服务需要部署文件，这里部署 Jenkins 需要创建 Service 与 Deployment 对象，其中两个对象需要做一些配置，如下：</p>
<ul>
<li>Service：Service 暴露两个接口 <code>8080</code> 与 <code>50000</code>，其中 8080 是 Jenkins API 和 UI 的端口，而 50000 则是供代理使用的端口。</li>
<li>Deployment： Deployment 中，需要设置容器安全策略为 <code>runAsUser: 0</code> 赋予容器以 <code>Root</code> 权限运行，并且暴露 <code>8080</code> 与 <code>50000</code> 两个端口与 Service 对应，而且还要注意的是，还要设置上之前创建的服务账户 “jenkins-admin”。</li>
</ul>
<p><strong>jenkins-deployment.yaml</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>NodePort<span class="w">
</span><span class="w">  </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>http<span class="w">
</span><span class="w">    </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">                      </span><span class="c">#服务端口</span><span class="w">
</span><span class="w">    </span><span class="k">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">    </span><span class="k">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">32001</span><span class="w">                 </span><span class="c">#NodePort方式暴露 Jenkins 端口</span><span class="w">
</span><span class="w">  </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>jnlp<span class="w">
</span><span class="w">    </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">50000</span><span class="w">                     </span><span class="c">#代理端口</span><span class="w">
</span><span class="w">    </span><span class="k">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">50000</span><span class="w">
</span><span class="w">    </span><span class="k">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">32002</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w">  </span><span class="k">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="k">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w">    </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">serviceAccountName</span><span class="p">:</span><span class="w"> </span>jenkins-admin<span class="w">
</span><span class="w">      </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">
</span><span class="w">        </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>jenkins/jenkins<span class="p">:</span><span class="m">2.199</span><span class="w">
</span><span class="w">        </span><span class="k">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">                      </span><span class="c">#设置以ROOT用户运行容器</span><span class="w">
</span><span class="w">          </span><span class="k">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">                  </span><span class="c">#拥有特权</span><span class="w">
</span><span class="w">        </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>http<span class="w">
</span><span class="w">          </span><span class="k">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>jnlp<span class="w">
</span><span class="w">          </span><span class="k">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">50000</span><span class="w">
</span><span class="w">        </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>2Gi<span class="w">
</span><span class="w">            </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2000m&#34;</span><span class="w">
</span><span class="w">          </span><span class="k">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>2Gi<span class="w">
</span><span class="w">            </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2000m&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>LIMITS_MEMORY<span class="w">
</span><span class="w">          </span><span class="k">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">resourceFieldRef</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="k">resource</span><span class="p">:</span><span class="w"> </span>limits.memory<span class="w">
</span><span class="w">              </span><span class="k">divisor</span><span class="p">:</span><span class="w"> </span>1Mi<span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;JAVA_OPTS&#34;</span><span class="w">                 </span><span class="c">#设置变量，指定时区和 jenkins slave 执行者设置</span><span class="w">
</span><span class="w">          </span><span class="k">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;
</span><span class="s2">                   -Xmx$(LIMITS_MEMORY)m
</span><span class="s2">                   -XshowSettings:vm
</span><span class="s2">                   -Dhudson.slaves.NodeProvisioner.initialDelay=0
</span><span class="s2">                   -Dhudson.slaves.NodeProvisioner.MARGIN=50
</span><span class="s2">                   -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85
</span><span class="s2">                   -Duser.timezone=Asia/Shanghai
</span><span class="s2">                 &#34;</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;JENKINS_OPTS&#34;</span><span class="w">
</span><span class="w">          </span><span class="k">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;--prefix=/jenkins&#34;</span><span class="w">         </span><span class="c">#设置路径前缀加上 Jenkins</span><span class="w">
</span><span class="w">        </span><span class="k">volumeMounts</span><span class="p">:</span><span class="w">                        </span><span class="c">#设置要挂在的目录</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>data<span class="w">
</span><span class="w">          </span><span class="k">mountPath</span><span class="p">:</span><span class="w"> </span>/var/jenkins_home<span class="w">
</span><span class="w">      </span><span class="k">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>data<span class="w">
</span><span class="w">        </span><span class="k">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">claimName</span><span class="p">:</span><span class="w"> </span>jenkins<span class="w">                 </span><span class="c">#设置PVC</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>参数说明：</strong></p>
<ul>
<li><strong>JAVA_OPTS：</strong> JVM 参数设置</li>
<li><strong>JENKINS_OPTS：</strong> Jenkins 参数设置</li>
<li><strong>其它参数：</strong> 默认情况下，Jenkins 生成代理是保守的。例如，如果队列中有两个构建，它不会立即生成两个执行器。它将生成一个执行器，并等待某个时间释放第一个执行器，然后再决定生成第二个执行器。Jenkins 确保它生成的每个执行器都得到了最大限度的利用。如果你想覆盖这个行为，并生成一个执行器为每个构建队列立即不等待，所以在 Jenkins 启动时候添加这些参数:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">-Dhudson.slaves.NodeProvisioner.initialDelay<span class="o">=</span><span class="m">0</span>
-Dhudson.slaves.NodeProvisioner.MARGIN<span class="o">=</span><span class="m">50</span>
-Dhudson.slaves.NodeProvisioner.MARGIN0<span class="o">=</span>0.85

</code></pre></td></tr></table>
</div>
</div><p>有了上面的部署文件后，再将 Jenkins 部署到 Kuberntes 中：</p>
<ul>
<li>-n：指定应用启动的 namespace</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ kubectl create -f jenkins-deployment.yaml -n mydlqcloud

</code></pre></td></tr></table>
</div>
</div><h3 id="5获取-jenkins-生成的-token">5、获取 Jenkins 生成的 Token</h3>
<p>在安装 Jenkins 时候，它默认生成一段随机字符串在控制台日志中，用于安装时验证。这里需要获取它输出在控制台中的日志信息，来获取 Token 字符串。</p>
<p><strong>查看 Jenkins Pod 启动日志</strong></p>
<ul>
<li>-n：指定应用启动的 namespace</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ kubectl log <span class="k">$(</span>kubectl get pods -n mydlqcloud <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> grep jenkins<span class="k">)</span> -n mydlqcloud

</code></pre></td></tr></table>
</div>
</div><p><strong>在日志中可以看到，默认给的token为：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">*************************************************************
Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:

96b19967a2aa4e7ab7d2ea5c6f55db8d

This may also be found at: /var/jenkins_home/secrets/initialAdminPassword
*************************************************************

</code></pre></td></tr></table>
</div>
</div><h3 id="6启动-jenkins-进行初始化">6、启动 Jenkins 进行初始化</h3>
<p>输入 Kubernetes 集群地址和 Jenkins Service 设置的 NodePort 端口号，访问 Jenkins UI 界面进行初始化，按以下步骤执行：</p>
<p><strong>进入Jenkins</strong></p>
<p>输入 Kubernetes 集群地址和上面设置的 <code>Nodeport</code> 方式的端口号 <code>32001</code>，然后输入上面获取的 <code>Token</code> 字符串。例如，本人 Kubernetes 集群 IP 为 <code>192.168.2.11</code> ，所以就可以访问地址 <code>http://192.168.2.11:32001/jenkins</code> 进入 Jenkins 初始化界面。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1002.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1002.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>安装插件</strong></p>
<p>安装插件，选择 <code>推荐安装</code> 方式进行安装即可，后续再安装需要的插件。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1003.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1003.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>设置用户名、密码</strong></p>
<p>在这里输入一个用户名、密码，方便后续登录，如果不设置可能下次登录需要使用之前日志中默认的 Token 串来登录。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1004.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1004.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>配置 Jenkins 地址</strong></p>
<p>配置 Jenkins URL 地址，来告知 Jenkins 自己的 URL，在发送邮件、触发钩子等可能用到。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1005.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1005.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>进入 Jenkins 界面</strong></p>
<p>到此 Jenkins 初始化就配置完成，成功进入 Jenkins 界面。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1006.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-1006.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h2 id="二jenkins-安装相关插件">二、Jenkins 安装相关插件</h2>
<p>Jenkins 中可以打开 <strong>系统管理-&gt;插件管理-&gt;可选插件</strong> 来安装下面的一些插件：</p>
<ul>
<li><strong>Git：</strong> Jenkins 安装中默认安装 Git 插件，所以不需要单独安装。利用 git 工具可以将 github、gitlab 等等的地址下载源码。</li>
<li><strong>Docker：</strong> Jenkins 安装中默认安装 Docker 插件，所以不需要单独安装。利用 Docker 插件可以设置 Docker 环境，运行 Docker 命令，配置远程 Docker 仓库凭据等。</li>
<li><strong>Kubernetes：</strong> Kubernetes 插件的目的是能够使用 Kubernetes 集群动态配置 Jenkins 代理（使用Kubernetes调度机制来优化负载），运行单个构建，等构建完成后删除该代理。这里我们需要用到这个插件来启动 Jenkins Slave 代理镜像，让代理执行 Jenkins 要执行的 Job。</li>
<li><strong>Kubernetes Cli：</strong> Kubernetes Cli 插件作用是在执行 Jenkins Job 时候提供 kubectl 与 Kubernetes 集群交互环境。可以在 Pipeline 或自由式项目中允许执行 kubectl 相关命令。它的主要作用是提供 kubectl 运行环境，当然也可以提供 helm 运行环境。</li>
<li><strong>Config File Provider：</strong> Config File Provider 插件作用就是提供在 Jenkins 中存储 properties、xml、json、settings.xml 等信息，可以在执行 Pipeline 过程中可以写入存储的配置。例如，存入一个 Maven 全局 Settings.xml 文件，在执行 Pipeline Job 时候引入该 Settings.xml ，这样 Maven 编译用的就是该全局的 Settings.xml。</li>
<li><strong>Pipeline Utility Steps：</strong> 这是一个操作文件的插件，例如读写 json、yaml、pom.xml、Properties 等等。在这里主要用这个插件读取 pom.xml 文件的参数设置，获取变量，方便构建 Docker 镜像。</li>
<li><strong>Git Parameter：</strong> 能够与 Git 插件结合使用，动态获取 Git 项目中分支信息，在 Jenkins Job 构建前提供分支选项，来让项目执行人员选择拉取对应分支的代码。</li>
</ul>
<h2 id="三配置相关凭据">三、配置相关凭据</h2>
<p>选择 <strong>凭据-&gt;系统-&gt;全局凭据-&gt;添加凭据</strong> 来新增 Git、Docker Hub、Kubernetes 等认证凭据。</p>
<h3 id="1添加-git-认证凭据">1、添加 Git 认证凭据</h3>
<p><strong>配置的参数值：</strong></p>
<ul>
<li>类型：Username with password</li>
<li>范围：全局</li>
<li>用户名（Git 用户名）： 略</li>
<li>密码（Git 密码）：略</li>
<li>ID：global-git-credential</li>
<li>描述：全局 Git 凭据</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-credential-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-credential-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="2添加-kubernetes-token-凭据">2、添加 Kubernetes Token 凭据</h3>
<p><strong>配置的参数值：</strong></p>
<ul>
<li>类型：Secret text</li>
<li>范围：全局</li>
<li>Secret（K8S Token 串）：略</li>
<li>ID：global-kubernetes-credential</li>
<li>描述：全局的 K8S Token</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-credential-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-credential-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="3添加-docker-仓库认证凭据">3、添加 Docker 仓库认证凭据</h3>
<p><strong>配置的参数值：</strong></p>
<ul>
<li>类型：Username with password</li>
<li>范围：全局</li>
<li>用户名（Docker 仓库用户名）：略</li>
<li>密码（Docker 仓库密码）：略</li>
<li>ID：docker-hub-credential</li>
<li>描述：Docker 仓库认证凭据</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-credential-3.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-credential-3.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h2 id="四jenkins-配置-kubernetes-插件">四、Jenkins 配置 Kubernetes 插件</h2>
<p>进入 <strong>系统管理-&gt;系统设置-&gt;云</strong> 中，点击 <strong>新增一个云</strong> 选项，来新建一个与 Kubernetes 的连接，然后按照下面各个配置项进行配置。</p>
<h3 id="1kubernetes-plugin-基本配置">1、Kubernetes Plugin 基本配置</h3>
<h4 id="1配置连接-kubernetes-参数">(1)、配置连接 Kubernetes 参数</h4>
<p>配置 Kubernetes API 地址，然后再选择 Kubernetes Token 凭据。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-connection-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-connection-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>注意：</strong> 如果你的 Jenkins 也是安装在 Kubernetes 环境中，那么可以直接使用 Kubernetes 集群内的 Kubernetes API 地址，如果 Jnekins 是在安装在正常物理机或者虚拟机环境中，那么使用集群外的 Kubernetes API 地址，两个地址如下：</p>
<ul>
<li>集群内地址：<a href="https://kubernetes.default.svc.cluster.local">https://kubernetes.default.svc.cluster.local</a></li>
<li>集群外地址：https://{Kubernetes 集群 IP}:6443</li>
</ul>
<p>然后点击连接测试，查看是否能成功连通 Kubernetes，如果返回结果 Successful 则代表连接成功，否则失败。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-connection-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-connection-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h4 id="2配置-jenkins-地址">(2)、配置 Jenkins 地址</h4>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-jenkins-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-jenkins-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>注意：</strong> 这里的 Jenkins 地址是供 Slave 节点连接 Jenkins Master 节点用的，所以这里需要配置 Jenkins Master 的 URL 地址。这里和上面一样，也是考虑 Jenkins 是部署在 Kubernetes 集群内还是集群外，两个地址如下：</p>
<ul>
<li>集群内地址：https://{Jenkins Pod 名称}.{Jenkins Pod 所在 Namespace}/{Jenkins 前缀}</li>
<li>集群外地址：https://{Kubernetes 集群 IP}:{Jenkins NodePort 端口}/{Jenkins 前缀}</li>
</ul>
<blockquote>
<p>如果 Jnekins 中配置了 /jenkins 前缀，则 URL 后面加上 /jenkins，否则不加，这个地址根据自己的 Jnekins 实际情况来判断。</p>
</blockquote>
<h3 id="2kubernetes-插件-pod-模板配置">2、Kubernetes 插件 Pod 模板配置</h3>
<h4 id="1配置-pod-名称和标签列表">(1)、配置 Pod 名称和标签列表</h4>
<p>配置 Pod 模板的名称和标签列表名，Pod 模板名可用于子模板继承，标签列表可用于 Jenkins Job 中指定，使用此 Pod 模板来执行任务。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-template-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-template-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h4 id="2配置-pod-的原始-yaml">(2)、配置 Pod 的原始 yaml</h4>
<p>在 Pod 的原始 yaml 配置中，加入一段配置，用于改变 Kubernetes Plugin 自带的 JNLP 镜像，并指定 RunAsUser=0 来使容器以 Root 身份执行任务，并设置 privileged=true 来让 Slave Pod 在 Kubernetes 中拥有特权。</p>
<blockquote>
<p>Jenkins Slave JNLP 镜像官方地址 <a href="https://hub.docker.com/r/jenkins/slave">https://hub.docker.com/r/jenkins/slave</a> 可以从中下载相关 JNLP 代理镜像。</p>
</blockquote>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-template-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-template-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p>yaml 内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>jenkins-slave<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="w">    </span><span class="k">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>jnlp<span class="w">
</span><span class="w">    </span><span class="k">tty</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="k">workingDir</span><span class="p">:</span><span class="w"> </span>/home/jenkins/agent<span class="w">
</span><span class="w">    </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>registry.cn-shanghai.aliyuncs.com/mydlq/jnlp-slave<span class="p">:</span><span class="m">3.35-5</span>-alpine<span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="3kubernetes-插件-container-配置">3、Kubernetes 插件 Container 配置</h3>
<p>将配置 Jenkins Slave 在 Kubernetes 中的 Pod 中所包含容器信息，这里镜像都可以从官方 Docker Hub 下载，由于网速原因，本人已经将其下载到 Aliyun 镜像仓库。</p>
<h4 id="1配置-maven-镜像">(1)、配置 Maven 镜像</h4>
<ul>
<li>名称：maven</li>
<li>Docker 镜像：registry.cn-shanghai.aliyuncs.com/mydlq/maven:3.6.0-jdk8-alpine</li>
<li>其它参数：默认值即可</li>
</ul>
<blockquote>
<p>Maven 镜像可以从官方 Docker Hub 下载，地址：<a href="https://hub.docker.com/_/maven">https://hub.docker.com/_/maven</a></p>
</blockquote>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h4 id="2配置-docker-in-docker-镜像">(2)、配置 Docker In Docker 镜像</h4>
<ul>
<li>名称：docker</li>
<li>Docker 镜像：registry.cn-shanghai.aliyuncs.com/mydlq/docker:18.06.3-dind</li>
<li>其它参数：默认值即可</li>
</ul>
<blockquote>
<p>Docker-IN-Docker 镜像可以从官方 Docker Hub 下载，地址：<a href="https://hub.docker.com/_/docker">https://hub.docker.com/_/docker</a></p>
</blockquote>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h4 id="3配置-kubectl-镜像">(3)、配置 Kubectl 镜像</h4>
<ul>
<li>名称：kubectl</li>
<li>Docker 镜像：registry.cn-shanghai.aliyuncs.com/mydlq/kubectl:1.15.3</li>
<li>其它参数：默认值即可</li>
</ul>
<blockquote>
<p>Kubectl 镜像可以从官方 Docker Hub 下载，地址：<a href="https://hub.docker.com/r/bitnami/kubectl">https://hub.docker.com/r/bitnami/kubectl</a></p>
</blockquote>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-3.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-3.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="4container-存储挂载配置">4、Container 存储挂载配置</h3>
<p>由于上面配置的 Maven、Docker 等都需要挂载存储，Maven 中是将中央仓库下载的 Jar 存储到共享目录，而 Docker 则是需要将宿主机的 Docker 配置挂载到 Docker In Docker 容器内部，所以我们要对挂载进行配置。</p>
<h4 id="1创建-maven-存储使用的-pvpvc">(1)、创建 Maven 存储使用的 PV、PVC</h4>
<p>提前在 NFS 卷中，创建用于存储 Maven 相关 Jar 的目录：</p>
<blockquote>
<p>创建的目录要确保其它用户有读写权限。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ mkdir /nfs/data/maven

</code></pre></td></tr></table>
</div>
</div><p>然后，Kubernetes 下再创建 Maven 的 PV、PVC 部署文件：</p>
<p><strong>maven-storage.yaml</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>PersistentVolume<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>maven<span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>maven<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">capacity</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">storage</span><span class="p">:</span><span class="w"> </span>100Gi<span class="w">
</span><span class="w">  </span><span class="k">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- ReadWriteOnce<span class="w">
</span><span class="w">  </span><span class="k">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span>Retain<span class="w">
</span><span class="w">  </span><span class="k">mountOptions</span><span class="p">:</span><span class="w">         </span><span class="c">#NFS挂在选项</span><span class="w">
</span><span class="w">    </span>- hard<span class="w">
</span><span class="w">    </span>- nfsvers=<span class="m">4.1</span><span class="w">
</span><span class="w">  </span><span class="k">nfs</span><span class="p">:</span><span class="w">                  </span><span class="c">#NFS设置</span><span class="w">
</span><span class="w">    </span><span class="k">path</span><span class="p">:</span><span class="w"> </span>/nfs/data/maven<span class="w">
</span><span class="w">    </span><span class="k">server</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.2.11</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>PersistentVolumeClaim<span class="w">
</span><span class="w"></span><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>maven<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">accessModes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- ReadWriteOnce<span class="w">
</span><span class="w">  </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">requests</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">storage</span><span class="p">:</span><span class="w"> </span>100Gi<span class="w">     </span><span class="c">#存储空间大小</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>maven<span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>部署 PV、PVC 到 Kubernetes 中：</p>
<ul>
<li>-n：指定 namespace</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ kubectl apply -f maven-storage.yaml -n public

</code></pre></td></tr></table>
</div>
</div><h4 id="2配置-maven-挂载">(2)、配置 Maven 挂载</h4>
<p>在卷选项中，选择添加卷，选择 <code>Persistent Volume Claim</code> 按如下添加配置：</p>
<ul>
<li>申明值（PVC 名称）：maven</li>
<li>挂在路径（容器内的目录）：/root/.m2</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-volume-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-volume-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h4 id="3配置-docker-挂载">(3)、配置 Docker 挂载</h4>
<p>Kubernetes 中 Pod 的容器是启动在各个节点上，每个节点就是一台宿主机，里面进行了很多 Docker 配置，所以我们这里将宿主机的 Docker 配置挂载进入 Docker 镜像。选择添加卷，选择 <code>Host Path Volume</code> 按如下添加配置：</p>
<p><strong>① 路径 /usr/bin/docker：</strong></p>
<ul>
<li>主机路径（宿主机目录）：/usr/bin/docker</li>
<li>挂载路径（容器内的目录）：/usr/bin/docker</li>
</ul>
<p><strong>② 路径 /var/run/docker.sock：</strong></p>
<ul>
<li>主机路径（宿主机目录）：/var/run/docker.sock</li>
<li>挂载路径（容器内的目录）：/var/run/docker.sock</li>
</ul>
<p><strong>③ 路径 /etc/docker：</strong></p>
<ul>
<li>主机路径（宿主机目录）：/etc/docker</li>
<li>挂载路径（容器内的目录）：/etc/docker</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-volume-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-kubernetes-plugin-pod-container-volume-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h2 id="五创建相关文件">五、创建相关文件</h2>
<p>之前安装了 <strong>Config File Provider</strong> 插件，该插件功能就是可以在 Jenkins 上存储一些配置文件，例如，我们经常使用到的 yaml、properties、Dockerfile、Maven 的 Settings.xml 等文件，都可以存储到 Jenkins 该插件中。</p>
<p>打开 <strong>系统管理-&gt;Managed files</strong> ，在其中新增几个文件：</p>
<ul>
<li><strong>Maven 配置文件：</strong> Maven 的 Settings.xml 配置文件。</li>
<li><strong>Dockerfile 文件：</strong> Dockerfile 脚本。</li>
<li><strong>Kubernetes 部署文件：</strong> 将应用部署到 kubernetes 的 Deployment 文件。</li>
</ul>
<h3 id="1新增-maven-配置文件">1、新增 Maven 配置文件</h3>
<p>选择 <strong>Add a new Config—&gt;Global Maven settings.xml</strong> 来新增一个 <strong>Maven</strong> 全局 <strong>Settings.xml</strong> 文件：</p>
<ul>
<li><strong>ID：</strong> global-maven-settings</li>
<li><strong>Name：</strong> MavenGlobalSettings</li>
<li><strong>Comment：</strong> 全局 Maven Settings.xml 文件</li>
<li><strong>Content：</strong> 内容如下↓：</li>
</ul>
<blockquote>
<p>为了加快 jar 包的下载速度，这里将仓库地址指向 aliyun Maven 仓库地址。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;settings</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/SETTINGS/1.0.0&#34;</span>
          <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
          <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&#34;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;pluginGroups&gt;</span>
  <span class="nt">&lt;/pluginGroups&gt;</span>

  <span class="nt">&lt;proxies&gt;</span>
  <span class="nt">&lt;/proxies&gt;</span>

  <span class="nt">&lt;servers&gt;</span>
  <span class="nt">&lt;/servers&gt;</span>

  <span class="nt">&lt;mirrors&gt;</span>
    <span class="c">&lt;!--Aliyun Maven--&gt;</span>
    <span class="nt">&lt;mirror&gt;</span>
        <span class="nt">&lt;id&gt;</span>alimaven<span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;name&gt;</span>aliyun maven<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;url&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;mirrorOf&gt;</span>central<span class="nt">&lt;/mirrorOf&gt;</span>
    <span class="nt">&lt;/mirror&gt;</span>
  <span class="nt">&lt;/mirrors&gt;</span>

  <span class="nt">&lt;profiles&gt;</span>
  <span class="nt">&lt;/profiles&gt;</span>

<span class="nt">&lt;/settings&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="2新增-dockerfile-文件">2、新增 Dockerfile 文件</h3>
<p>选择 <strong>Add a new Config—&gt;Custom file</strong> 来新增一个 <strong>Dockerfile</strong> 文件：</p>
<ul>
<li><strong>ID：</strong> global-dockerfile-file</li>
<li><strong>Name：</strong> Dockerfile</li>
<li><strong>Comment：</strong> 全局 Dockerfile 文件</li>
<li><strong>Content：</strong> 内容如下↓：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">FROM openjdk:8u222-jre-slim
VOLUME /tmp
ADD target/*.jar app.jar
RUN sh -c <span class="s1">&#39;touch /app.jar&#39;</span>
ENV <span class="nv">JVM_OPTS</span><span class="o">=</span><span class="s2">&#34;-Xss256k -Duser.timezone=Asia/Shanghai -Djava.security.egd=file:/dev/./urandom&#34;</span>
ENV <span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
ENV <span class="nv">APP_OPTS</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
ENTRYPOINT <span class="o">[</span> <span class="s2">&#34;sh&#34;</span>, <span class="s2">&#34;-c&#34;</span>, <span class="s2">&#34;java </span><span class="nv">$JVM_OPTS</span><span class="s2"> </span><span class="nv">$JAVA_OPTS</span><span class="s2"> -jar /app.jar </span><span class="nv">$APP_OPTS</span><span class="s2">&#34;</span> <span class="o">]</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="3新增-kubernetes-部署文件">3、新增 Kubernetes 部署文件</h3>
<p>选择 <strong>Add a new Config—&gt;Custom file</strong> 来新增一个 <strong>Kubernetes 部署文件</strong>：</p>
<ul>
<li><strong>ID：</strong> global-kubernetes-deployment</li>
<li><strong>Name：</strong> deployment.yaml</li>
<li><strong>Comment：</strong> 全局 Kubernetes 部署文件</li>
<li><strong>Content：</strong> 内容如下↓：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_NAME</span><span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_NAME</span><span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>NodePort<span class="w">
</span><span class="w">  </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>server<span class="w">          </span><span class="c">#服务端口</span><span class="w">
</span><span class="w">    </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">    </span><span class="k">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">  </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>management<span class="w">      </span><span class="c">#监控及监控检查的端口</span><span class="w">
</span><span class="w">    </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">8081</span><span class="w">
</span><span class="w">    </span><span class="k">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8081</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_NAME</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_NAME</span><span class="w">
</span><span class="w">  </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">app</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_NAME</span><span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">replicas</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_REPLICAS</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">app</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_NAME</span><span class="w">
</span><span class="w">  </span><span class="k">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">type</span><span class="p">:</span><span class="w"> </span>Recreate<span class="w">          </span><span class="c">#设置更新策略为删除策略</span><span class="w">
</span><span class="w">  </span><span class="k">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">app</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_NAME</span><span class="w">
</span><span class="w">    </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_NAME</span><span class="w">
</span><span class="w">        </span><span class="k">image</span><span class="p">:</span><span class="w"> </span><span class="c">#APP_IMAGE_NAME</span><span class="w">
</span><span class="w">        </span><span class="k">imagePullPolicy</span><span class="p">:</span><span class="w"> </span>Always<span class="w">
</span><span class="w">        </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">   </span><span class="c">#服务端口</span><span class="w">
</span><span class="w">          </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>server<span class="w">
</span><span class="w">        </span>- <span class="k">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8081</span><span class="w">   </span><span class="c">#监控及监控检查的端口</span><span class="w">
</span><span class="w">          </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>management<span class="w">
</span><span class="w">        </span><span class="k">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;update_uuid&#34;</span><span class="w">
</span><span class="w">          </span><span class="k">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;#APP_UUID&#34;</span><span class="w">    </span><span class="c">#生成的随机值，放置执行kubectl apply时能够执行</span><span class="w">
</span><span class="w">        </span><span class="k">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span>2000m<span class="w">
</span><span class="w">            </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>1024Mi<span class="w">
</span><span class="w">          </span><span class="k">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span>1000m<span class="w">
</span><span class="w">            </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>512Mi<span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>为了模板能够动态替换某些值，上面模板中设置了几个可替换的参数，用 <strong>#变量名称</strong> 来标记，后面我们在执行 Pipeline 时候将里面的 <strong>#xxx变量</strong> 标记替换掉，上面配置的变量有：</p>
<ul>
<li><strong>#APP_NAME：</strong> 应用名称。</li>
<li><strong>#APP_REPLICAS：</strong> 应用副本数。</li>
<li><strong>#APP_IMAGE_NAME：</strong> 镜像名称。</li>
<li><strong>#APP_UUID：</strong> 生成的随机值，因为后续 Kubectl 在执行命令时候，如果部署对象中的值没有一点变化的话，将不会执行 kubectl apply 命令，所以这里设置了一个随机值，以确保每次部署文件都不一致。</li>
</ul>
<p>并且还有一点就是要注意，设置更新策略为 Recreate（删除再创建） 策略，否则后面的健康检查阶段将不能正常检查更新后的项目。</p>
<blockquote>
<p>Kubernetes 默认为 RollingUpdate 策略，该策略为应用启动时，先将新实例启动，再删除旧的实例，就是因为这样，在后面健康检查阶段，健康检查 URL 地址还是未更新前的旧实例的 URL 地址，会导致健康检查不准确，所以必须改为 Recreate 策略，先删除旧实例，再创建新实例。</p>
</blockquote>
<h2 id="六如何写流水线脚本和使用插件">六、如何写流水线脚本和使用插件</h2>
<h3 id="1脚本中设置全局超时时间">1、脚本中设置全局超时时间</h3>
<p>设置任务超时时间，如果在规定时间内任务没有完成，则进行失败操作，格式如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">60</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;SECONDS&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 脚本
</span><span class="c1"></span><span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="2脚本中使用-git-插件">2、脚本中使用 Git 插件</h3>
<p>Git 插件方法使用格式，及其部分参数：</p>
<ul>
<li><strong>changelog：</strong> 是否检测变化日志</li>
<li><strong>url：</strong> Git 项目地址</li>
<li><strong>branch：</strong> Git 分支</li>
<li><strong>credentialsId：</strong> Jenkins 存的 Git 凭据 ID 值</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">git</span> <span class="nl">changelog:</span> <span class="kc">true</span><span class="o">,</span>
    <span class="nl">url:</span> <span class="s2">&#34;http://gitlab.xxxx/xxx.git&#34;</span>
    <span class="nl">branch:</span> <span class="s2">&#34;master&#34;</span><span class="o">,</span>
    <span class="nl">credentialsId:</span> <span class="s2">&#34;xxxx-xxxx-xxxx-xxxx&#34;</span><span class="o">,</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="3脚本中使用-kubernetes-插件">3、脚本中使用 Kubernetes 插件</h3>
<p>Kubernetes 插件中存在 PodTemplate 方法，在执行脚本时候，会自动在 Kubernetes 中创建 Pod Template 配置的 Slave Pod，在其中执行 podTemplate 代码块中的脚本。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;jnlp-agent&#34;</span>
<span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="n">label</span><span class="o">,</span><span class="nl">cloud:</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="o">){</span>
    <span class="n">node</span> <span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">print</span> <span class="s2">&#34;在 Slave Pod 中执行任务&#34;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>podTemplate 方法参数简介：</strong></p>
<ul>
<li><strong>cloud：</strong> 之前 Kuberntes 插件配置的 Cloud 名称</li>
<li><strong>label：</strong> 之前 Kuberntes 插件配置的 Cloud 中 Pod Template 里面的 Label 标签名称。</li>
</ul>
<h3 id="4脚本中使用-docker-镜像">4、脚本中使用 Docker 镜像</h3>
<p>在之前配置了 Kubernetes 插件的 Pod Template 配置中，配置了几个容器，每个容器中都有特定的功能的环境，例如：</p>
<ul>
<li>Maven 容器中能够执行 mvn 命令。</li>
<li>Kuberctl 容器能够执行 kubectl 命令。</li>
<li>Docker In Docker 容器中能够执行 Docker 命令。</li>
</ul>
<p>既然每个容器都能提供特定的环境，那么再执行执行 Pipleline 脚本时候，就可以在不同的镜像中使用不同的环境的命令：</p>
<ul>
<li><strong>Maven 镜像</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sh</span> <span class="err">&#34;</span><span class="n">mvn</span> <span class="n">install</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Docker In Docker 镜像</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">container</span><span class="o">(</span><span class="s1">&#39;docker&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sh</span> <span class="err">&#34;</span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="nl">xxxxx:</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">0</span> <span class="o">.</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Kubectl 镜像</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">container</span><span class="o">(</span><span class="s1">&#39;kubectl&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sh</span> <span class="s2">&#34;kubectl apply -f xxxx.yaml&#34;</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="5脚本中引入-jenkins-中预先存储的文件">5、脚本中引入 Jenkins 中预先存储的文件</h3>
<p>在之前的 <strong>系统设置-&gt;File Manager</strong> 中，存储了很多文件，例如：</p>
<ul>
<li>Docker 的镜像构建脚本文件 Dockerfile。</li>
<li>Maven 的全局设置文件 Settings.xml</li>
<li>Kubernetes 的部署文件 deployment.yaml</li>
</ul>
<p>在使用 Pipleline 脚本时候，我们需要将这些文件文本提取出来，创建在执行任务的流程中，创建这些文件可以使用 Config File Provider 插件提供的 configFileProvider 方法，李如意：</p>
<ul>
<li><strong>创建 settings.xml 文件</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;global-maven-settings&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;settings.xml&#34;</span><span class="o">)]){</span>
    <span class="n">sh</span> <span class="s2">&#34;cat settings.xml&#34;</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>创建 Dockerfile 文件</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;global-dockerfile-file&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;Dockerfile&#34;</span><span class="o">)]){</span>
    <span class="n">sh</span> <span class="s2">&#34;cat Dockerfile&#34;</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>创建 Dockerfile 文件</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;global-kubernetes-deployment&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;deployment.yaml&#34;</span><span class="o">)]){</span>
    <span class="n">sh</span> <span class="s2">&#34;cat deployment.yaml&#34;</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="6脚本创建文件">6、脚本创建文件</h3>
<p>在使用 Groovy 写 Pipleline 脚本时候，经常要将变量的文本生成文件，方便在执行流水线过程中操作文本文件使用，如何将文件转换为文件，可以使用 Pipeline Utility Steps 插件的 writeFile 方法，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">writeFile</span> <span class="nl">encoding:</span> <span class="s1">&#39;UTF-8&#39;</span><span class="o">,</span> <span class="nl">file:</span> <span class="s1">&#39;./test.txt&#39;</span><span class="o">,</span> <span class="nl">text:</span> <span class="s2">&#34;写入文件的文本内容&#34;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="7脚本中使用-http-rrequest-插件">7、脚本中使用 Http Rrequest 插件</h3>
<p>脚本中可以使用 HttpRequest 来对某一地址进行请求，这里简单使用 Get 请求地址，复杂的可以查看 Jenkins 插件的官网查看使用示例。</p>
<p>下面是使用 Http Request 的 Get 请求示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">result</span> <span class="o">=</span> <span class="n">httpRequest</span> <span class="s2">&#34;http:www.baidu.com&#34;</span>

<span class="k">if</span> <span class="o">(</span><span class="s2">&#34;${result.status}&#34;</span> <span class="o">==</span> <span class="s2">&#34;200&#34;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">print</span> <span class="s2">&#34;Http 请求成功&#34;</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="8脚本中使用-kubernetes-cli-插件">8、脚本中使用 Kubernetes Cli 插件</h3>
<p>在之前说过，在 kubectl 镜像中能够使用 kubectl 命令，不过由于执行 Kubectl 命令一般需要在镜像的 <strong>$HOME/.kube/</strong> 目录中存在连接 <strong>Kubernetes API</strong> 的 <strong>config</strong> 文件，使其 <strong>kubectl</strong> 命令有明确请求 <strong>kubernetes API</strong> 的地址和用户权限，不过将 <strong>config</strong> 文件挂入镜像内部是一件比较繁琐的事情。</p>
<p>好在 <strong>Jenkins</strong> 提供的 <strong>Kubectl Cli</strong> 插件，只要在其中配置连接 <strong>Kubernetes 的 Token</strong> 凭据，就能够在 <strong>Kubectl Cli</strong> 提供的 <strong>withKubeConfig</strong> 方法，拥有类似存在 <strong>config</strong> 一样的功能，在 <strong>kubectl</strong> 镜像中的 <strong>withKubeConfig</strong> 方法块内执行 <strong>kubectl</strong> 就可以操作配置的 <strong>Kubectl Cli</strong> 的凭据的 <strong>K8S</strong> 集群。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">container</span><span class="o">(</span><span class="s1">&#39;kubectl&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">withKubeConfig</span><span class="o">([</span><span class="nl">credentialsId:</span> <span class="s2">&#34;Kubernetes Token 凭据 ID&#34;</span><span class="o">,</span><span class="nl">serverUrl:</span> <span class="s2">&#34;https://kubernetes.default.svc.cluster.local&#34;</span><span class="o">])</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">&#34;kubectl get nodes&#34;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="9脚本中操作字符串替换值">9、脚本中操作字符串替换值</h3>
<p>在使用 Groovy 语法写 Pipleline 脚本时候，我们经常要替换先前设置好的一些文本的值，这里我们简单示例一下，如何替换字符串。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="c1">// 测试的字符串
</span><span class="c1"></span><span class="n">sourceStr</span> <span class="o">=</span> <span class="s2">&#34;这是要替换的值：#value1，这是要替换的值：#value2&#34;</span>
<span class="c1">// 替换#value1与#value2连个值
</span><span class="c1"></span><span class="n">afterStr</span> <span class="o">=</span> <span class="n">deploy</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#value1&#34;</span><span class="o">,</span><span class="s2">&#34;AAA&#34;</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#value2&#34;</span><span class="o">,</span><span class="s2">&#34;BBB&#34;</span><span class="o">)</span>
<span class="c1">// 输出替换后的字符串
</span><span class="c1"></span><span class="n">print</span> <span class="s2">&#34;${afterStr}&#34;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="10脚本中读取-pomxml-参数">10、脚本中读取 pom.xml 参数</h3>
<p>在执行 Java 项目的流水线时，我们经常要动态获取项目中的属性，很多属性都配置在项目的 pom.xml 中，还好 Pipeline Utility Steps 插件提供能够读取 pom.xml 的方法，示例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">stage</span><span class="o">(</span><span class="s1">&#39;读取pom.xml参数阶段&#39;</span><span class="o">){</span>
    <span class="c1">// 读取 Pom.xml 参数
</span><span class="c1"></span>    <span class="n">pom</span> <span class="o">=</span> <span class="n">readMavenPom</span> <span class="nl">file:</span> <span class="s1">&#39;./pom.xml&#39;</span>
    <span class="c1">// 输出读取的参数
</span><span class="c1"></span>    <span class="n">print</span> <span class="s2">&#34;${pom.artifactId}&#34;</span>
    <span class="n">print</span> <span class="o">=</span> <span class="s2">&#34;${pom.version}&#34;</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="11脚本中使用-docker-插件构建与推送镜像">11、脚本中使用 Docker 插件构建与推送镜像</h3>
<p>在流水线脚本中，我们一般不直接使用 Docker 命令，而是使用 Docker 插件提供的 docker.withRegistry(“”) 方法来构建与推送镜像，并且还能在方法中配置登录凭据信息，来让仓库验证权限，这点是非常方便的。使用示例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">&#34;http://xxxx Docker 仓库地址&#34;</span><span class="o">,</span> <span class="s2">&#34;Docker 仓库凭据 ID&#34;</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 构建 Docker 镜像
</span><span class="c1"></span>        <span class="kt">def</span> <span class="n">customImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">)</span>
        <span class="c1">// 推送 Docker 镜像
</span><span class="c1"></span>        <span class="n">customImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
    <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="七在-jenkins-创建模板任务">七、在 Jenkins 创建模板任务</h2>
<p>创建一个 Pipeline Job 来充当各个 Jenkins Job 的模板，方便后续创建 Job 时，直接复制模板项目，然后修改配置就能使用。所以这里我们创建一个模板 Pipeline Job，在 Job 配置中需要添加一些参数和环境变量，方便我们动态替换一些值。</p>
<h3 id="1创建-pipeline-任务">1、创建 Pipeline 任务</h3>
<ul>
<li><strong>任务名称：</strong> my-template</li>
<li><strong>任务类型：</strong> 流水线项目</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-job-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-job-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="2配置项目构建基本参数">2、配置项目构建基本参数</h3>
<p>配置同一时间一个 Job 只能构建一个，不允许多个并发构建。另外需要设置项目构建后，包的保留时间，以防止包过多且大占用大量空间（一个包很肯能占 10MB~200MB 大小）导致储不足。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-job-base-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-job-base-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="3配置-git-变量">3、配置 Git 变量</h3>
<p>在 Job 配置的 <strong>参数化构建过程</strong> 中，添加下面参数：</p>
<p><strong>Git 项目地址变量</strong></p>
<ul>
<li>变量名称：GIT_PROJECT_URL</li>
<li>类型：String</li>
<li>描述：项目 Git 地址</li>
<li>默认值：”<a href="https://xxxxxxxxxxxx%22">https://xxxxxxxxxxxx&rdquo;</a></li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-git-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-git-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>Git 分支变量</strong></p>
<ul>
<li>变量名称：GIT_BRANCH</li>
<li>类型：Git Parameter</li>
<li>描述：选择 Git 分支</li>
<li>默认值：master</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-git-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-git-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>Git 凭据变量</strong></p>
<ul>
<li>变量名称：GIT_CREADENTIAL</li>
<li>类型：Credentials</li>
<li>描述：Git 凭据</li>
<li>默认值：global-git-credential</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-git-3.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-git-3.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="4配置-maven-变量">4、配置 Maven 变量</h3>
<p><strong>Maven 构建命令变量</strong></p>
<ul>
<li>变量名称：MAVEN_BUILD_OPTION</li>
<li>类型：Choices</li>
<li>描述：要执行的执行 Maven 命令选择</li>
<li>可选值：[‘package’, ‘install’, ‘deploy’]</li>
<li>默认值：install</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-maven-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-maven-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="5配置-docker-变量">5、配置 Docker 变量</h3>
<p><strong>Docker 项目地址变量</strong></p>
<ul>
<li>变量名称：DOCKER_HUB_URL</li>
<li>类型：String</li>
<li>描述：Docker 仓库地址</li>
<li>默认值（默认 Docker 仓库地址）：”10.71.164.28:5000”</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-docker-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-docker-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>Docker 仓库项目组变量</strong></p>
<ul>
<li>变量名称：DOCKER_HUB_GROUP</li>
<li>类型：String</li>
<li>描述：Docker 仓库项目组名</li>
<li>默认值：””</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-docker-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-docker-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>Docker 仓库认证凭据变量</strong></p>
<ul>
<li>变量名称：DOCKER_HUB_CREADENTIAL</li>
<li>类型：Credentials</li>
<li>描述：Docker 仓库认证凭据</li>
<li>默认值：docker-hub-credential</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-docker-3.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-docker-3.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>Docker Dockerfile 文件 ID 变量</strong></p>
<ul>
<li>变量名称：DOCKER_DOCKERFILE_ID</li>
<li>类型：String</li>
<li>描述：存于 Jenkins “Managed files” 的 Dockerfile 文件的 ID</li>
<li>默认值：”global-dockerfile-file”</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-docker-4.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-docker-4.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="6配置-kubernetes-变量">6、配置 Kubernetes 变量</h3>
<p><strong>Kubernetes 认证凭据变量</strong></p>
<ul>
<li>变量名称：KUBERNETES_CREADENTIAL</li>
<li>类型：Credentials</li>
<li>描述：Kubernetes 认证 Token</li>
<li>默认值：global-kubernetes-credential</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-k8s-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-k8s-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>Kubernetes Namespace 变量</strong></p>
<ul>
<li>变量名称：KUBERNETES_NAMESPACE</li>
<li>类型：String</li>
<li>描述：Kubernetes 命名空间 Namespace</li>
<li>默认值：””</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-k8s-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-k8s-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>Kubernetes 应用实例副本数</strong></p>
<ul>
<li>变量名称：KUBERNETES_APP_REPLICAS</li>
<li>类型：String</li>
<li>描述：应用实例副本数</li>
<li>默认值：1</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-k8s-3.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-k8s-3.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>Kubernetes 应用部署 yaml 文件ID</strong></p>
<ul>
<li>变量名称：KUBERNETES_DEPLOYMENT_ID</li>
<li>类型：String</li>
<li>描述：存于 Jenkins “Managed files” 的 K8S 部署文件的 ID</li>
<li>默认值：”global-kubernetes-deployment”</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-k8s-4.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-k8s-4.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="7配置-http-变量">7、配置 HTTP 变量</h3>
<p><strong>HTTP 健康检查端口</strong></p>
<ul>
<li>变量名称：HTTP_REQUEST_PORT</li>
<li>类型：String</li>
<li>描述：Http Request 端口（健康检测端口）</li>
<li>默认值：8081</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-http-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-http-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>HTTP 健康检查地址</strong></p>
<ul>
<li>变量名称：HTTP_REQUEST_URL</li>
<li>类型：String</li>
<li>描述：Http Request 项目中的相对路径（健康检测路径）</li>
<li>默认值：/actuator/health</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-http-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-http-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>HTTP 健康检查次数</strong></p>
<ul>
<li>变量名称：HTTP_REQUEST_NUMBER</li>
<li>类型：Choices</li>
<li>描述：Http Request 请求次数</li>
<li>可选值：[‘10’, ‘5’, ‘10’, ‘15’, ‘20’, ‘25’, ‘30’]</li>
<li>默认值：10</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-http-3.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-http-3.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>HTTP 健康检查时间间隔</strong></p>
<ul>
<li>变量名称：HTTP_REQUEST_INTERVAL</li>
<li>类型：Choices</li>
<li>描述：Http Request 时间间隔</li>
<li>可选值：[‘10’, ‘5’, ‘15’, ‘20’, ‘25’, ‘30’]</li>
<li>默认值：10</li>
</ul>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-http-4.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-template-variate-http-4.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h2 id="八创建-pipeline-脚本">八、创建 Pipeline 脚本</h2>
<p>接下将使用 Groovy 语法创建一个为 SpringBoot 项目准备的 CI/CD 的脚本式的流水线脚本。其中，脚本中包含多个阶段，分别为 Git 拉取镜像，Maven 编译 Java 项目，Docker 构建与推送镜像，Kubectl 部署应用到 Kubernetes 中，最后使用 Http 请求进行健康检查，下面是各个阶段脚本及其介绍。</p>
<h3 id="1脚本中使用-kubernetes-插件及设置超时时间">1、脚本中使用 Kubernetes 插件及设置超时时间</h3>
<p>使用 Kubernetes 插件执行任务，并设置超时时间为 10 分钟，脚本如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="c1">// 设置超时时间 600 SECONDS，方法块内的方法执行超时，任务就标记为失败
</span><span class="c1"></span><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">600</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;SECONDS&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;jnlp-agent&#34;</span>

    <span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="n">label</span><span class="o">,</span><span class="nl">cloud:</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="o">){</span>
        <span class="n">node</span> <span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">print</span> <span class="s2">&#34;在 Slave Pod 中执行任务&#34;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="2脚本中-git-拉取项目阶段">2、脚本中 Git 拉取项目阶段</h3>
<p>接下来接着往整体的脚本中添加 Git 模块，其中需要引用上面配置的变量，将变量填入脚本中的方法，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">600</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;SECONDS&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;jnlp-agent&#34;</span>
    <span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="n">label</span><span class="o">,</span><span class="nl">cloud:</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="o">){</span>
        <span class="n">node</span> <span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Git阶段&#39;</span><span class="o">){</span>
                <span class="n">git</span> <span class="nl">changelog:</span> <span class="kc">true</span><span class="o">,</span>
                    <span class="nl">url:</span> <span class="s2">&#34;${params.GIT_PROJECT_URL}&#34;</span><span class="err">，</span>
                    <span class="nl">branch:</span> <span class="s2">&#34;${params.GIT_BRANCH}&#34;</span><span class="o">,</span>
                    <span class="nl">credentialsId:</span> <span class="s2">&#34;${params.GIT_CREADENTIAL}&#34;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>变量介绍：</strong></p>
<ul>
<li><strong>GIT_BRANCH：</strong> Git 项目分支变量。</li>
<li><strong>GIT_PROJECT_URL：</strong> Git 项目 URL 变量。</li>
<li><strong>GIT_CREADENTIAL：</strong> Git 凭据 ID 变量。</li>
</ul>
<h3 id="3脚本中-maven-编译项目阶段">3、脚本中 Maven 编译项目阶段</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">600</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;SECONDS&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;jnlp-agent&#34;</span>
    <span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="n">label</span><span class="o">,</span><span class="nl">cloud:</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="o">){</span>
        <span class="n">node</span> <span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Git阶段&#39;</span><span class="o">){</span>
                <span class="n">git</span> <span class="nl">changelog:</span> <span class="kc">true</span><span class="o">,</span>
                    <span class="nl">url:</span> <span class="s2">&#34;${params.GIT_PROJECT_URL}&#34;</span><span class="err">，</span>
                    <span class="nl">branch:</span> <span class="s2">&#34;${params.GIT_BRANCH}&#34;</span><span class="o">,</span>
                    <span class="nl">credentialsId:</span> <span class="s2">&#34;${params.GIT_CREADENTIAL}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Maven阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Maven 需要的 Settings.xml 文件
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;global-maven-settings&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;settings.xml&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 执行 Maven 命令构建项目，并且设置 Maven 配置为刚刚创建的 Settings.xml 文件
</span><span class="c1"></span>                        <span class="n">sh</span> <span class="s2">&#34;mvn -T 1C clean ${MAVEN_BUILD_OPTION} -Dmaven.test.skip=true --settings settings.xml&#34;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>变量介绍：</strong></p>
<ul>
<li><strong>MAVEN_BUILD_OPTION：</strong> Maven 执行的构建命令，package、install 或 deploy。</li>
<li><strong>global-maven-settings：</strong> 全局 Maven 的 Settings.xml 文件的 ID 值，这里是使用 configFileProvider 插件来创建该文件。</li>
</ul>
<h3 id="4脚本中读取-pomxml-参数阶段">4、脚本中读取 pom.xml 参数阶段</h3>
<p>这里使用 <code>Pipeline Utility Steps</code> 的 <code>readMavenPom</code> 方法读取项目的 <code>pom.xml</code> 文件，并设置 <code>appName</code> 与 <code>appVersion</code> 两个全局参数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">600</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;SECONDS&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;jnlp-agent&#34;</span>
    <span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="n">label</span><span class="o">,</span><span class="nl">cloud:</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="o">){</span>
        <span class="n">node</span> <span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Git阶段&#39;</span><span class="o">){</span>
                <span class="n">git</span> <span class="nl">changelog:</span> <span class="kc">true</span><span class="o">,</span>
                    <span class="nl">url:</span> <span class="s2">&#34;${params.GIT_PROJECT_URL}&#34;</span><span class="err">，</span>
                    <span class="nl">branch:</span> <span class="s2">&#34;${params.GIT_BRANCH}&#34;</span><span class="o">,</span>
                    <span class="nl">credentialsId:</span> <span class="s2">&#34;${params.GIT_CREADENTIAL}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Maven阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Maven 需要的 Settings.xml 文件
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;global-maven-settings&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;settings.xml&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 执行 Maven 命令构建项目
</span><span class="c1"></span>                        <span class="n">sh</span> <span class="s2">&#34;mvn -T 1C clean ${MAVEN_BUILD_OPTION} -Dmaven.test.skip=true --settings settings.xml&#34;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;读取pom.xml参数阶段&#39;</span><span class="o">){</span>
                <span class="c1">// 读取 Pom.xml 参数
</span><span class="c1"></span>                <span class="n">pom</span> <span class="o">=</span> <span class="n">readMavenPom</span> <span class="nl">file:</span> <span class="s1">&#39;./pom.xml&#39;</span>
                <span class="c1">// 设置 appName 和 appVersion 两个全局参数
</span><span class="c1"></span>                <span class="n">appName</span> <span class="o">=</span> <span class="s2">&#34;${pom.artifactId}&#34;</span>
                <span class="n">appVersion</span> <span class="o">=</span> <span class="s2">&#34;${pom.version}&#34;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>变量介绍：</strong></p>
<ul>
<li><strong>pom.artifactId：</strong> 从 pom.xml 文件中读取的 artifactId 参数值。</li>
<li><strong>pom.version：</strong> 从 pom.xml 文件中读取的 version 参数值。</li>
</ul>
<h3 id="5脚本中-docker-镜像构建与推送模块">5、脚本中 Docker 镜像构建与推送模块</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">600</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;SECONDS&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;jnlp-agent&#34;</span>
    <span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="n">label</span><span class="o">,</span><span class="nl">cloud:</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="o">){</span>
        <span class="n">node</span> <span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Git阶段&#39;</span><span class="o">){</span>
                <span class="n">git</span> <span class="nl">changelog:</span> <span class="kc">true</span><span class="o">,</span>
                    <span class="nl">url:</span> <span class="s2">&#34;${params.GIT_PROJECT_URL}&#34;</span><span class="err">，</span>
                    <span class="nl">branch:</span> <span class="s2">&#34;${params.GIT_BRANCH}&#34;</span><span class="o">,</span>
                    <span class="nl">credentialsId:</span> <span class="s2">&#34;${params.GIT_CREADENTIAL}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Maven阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Maven 需要的 Settings.xml 文件
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;global-maven-settings&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;settings.xml&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 执行 Maven 命令构建项目
</span><span class="c1"></span>                        <span class="n">sh</span> <span class="s2">&#34;mvn -T 1C clean ${MAVEN_BUILD_OPTION} -Dmaven.test.skip=true --settings settings.xml&#34;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;读取pom.xml参数阶段&#39;</span><span class="o">){</span>
                <span class="c1">// 读取 Pom.xml 参数
</span><span class="c1"></span>                <span class="n">pom</span> <span class="o">=</span> <span class="n">readMavenPom</span> <span class="nl">file:</span> <span class="s1">&#39;./pom.xml&#39;</span>
                <span class="c1">// 设置 appName 和 appVersion 两个全局参数
</span><span class="c1"></span>                <span class="n">appName</span> <span class="o">=</span> <span class="s2">&#34;${pom.artifactId}&#34;</span>
                <span class="n">appVersion</span> <span class="o">=</span> <span class="s2">&#34;${pom.version}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Docker阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;docker&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Dockerfile 文件，但只能在方法块内使用
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;${params.DOCKER_DOCKERFILE_ID}&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;Dockerfile&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 设置 Docker 镜像名称
</span><span class="c1"></span>                        <span class="n">dockerImageName</span> <span class="o">=</span> <span class="s2">&#34;${params.DOCKER_HUB_URL}/${params.DOCKER_HUB_GROUP}/${appName}:${appVersion}&#34;</span>
                        <span class="c1">// 判断 DOCKER_HUB_GROUP 是否为空，有些仓库是不设置仓库组的
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="s2">&#34;${params.DOCKER_HUB_GROUP}&#34;</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">dockerImageName</span> <span class="o">=</span> <span class="s2">&#34;${params.DOCKER_HUB_URL}/${appName}:${appVersion}&#34;</span>
                        <span class="o">}</span>
                        <span class="c1">// 提供 Docker 环境，使用 Docker 工具来进行 Docker 镜像构建与推送
</span><span class="c1"></span>                        <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">&#34;http://${params.DOCKER_HUB_URL}&#34;</span><span class="o">,</span> <span class="s2">&#34;${params.DOCKER_HUB_CREADENTIAL}&#34;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="kt">def</span> <span class="n">customImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">)</span>
                            <span class="n">customImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>变量介绍：</strong></p>
<ul>
<li><strong>DOCKER_DOCKERFILE_ID：</strong> Dockerfile 文件的 ID。</li>
<li><strong>DOCKER_HUB_URL：</strong> Docker 仓库 URL 地址。</li>
<li><strong>DOCKER_HUB_GROUP：</strong> Docker 仓库项目组名。</li>
<li><strong>DOCKER_HUB_CREADENTIAL：</strong> Docker 仓库认证凭据。</li>
<li><strong>appName：</strong> 从 pom.xml 中读取的应用名称。</li>
<li><strong>appVersion：</strong> 从 pom.xml 中读取的应用版本号。</li>
</ul>
<h3 id="6kubernetes-模块">6、Kubernetes 模块</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">600</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;SECONDS&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;jnlp-agent&#34;</span>
    <span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="n">label</span><span class="o">,</span><span class="nl">cloud:</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="o">){</span>
        <span class="n">node</span> <span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Git阶段&#39;</span><span class="o">){</span>
                <span class="n">git</span> <span class="nl">changelog:</span> <span class="kc">true</span><span class="o">,</span>
                    <span class="nl">url:</span> <span class="s2">&#34;${params.GIT_PROJECT_URL}&#34;</span><span class="err">，</span>
                    <span class="nl">branch:</span> <span class="s2">&#34;${params.GIT_BRANCH}&#34;</span><span class="o">,</span>
                    <span class="nl">credentialsId:</span> <span class="s2">&#34;${params.GIT_CREADENTIAL}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Maven阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Maven 需要的 Settings.xml 文件
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;global-maven-settings&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;settings.xml&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 执行 Maven 命令构建项目
</span><span class="c1"></span>                        <span class="n">sh</span> <span class="s2">&#34;mvn -T 1C clean ${MAVEN_BUILD_OPTION} -Dmaven.test.skip=true --settings settings.xml&#34;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;读取pom.xml参数阶段&#39;</span><span class="o">){</span>
                <span class="c1">// 读取 Pom.xml 参数
</span><span class="c1"></span>                <span class="n">pom</span> <span class="o">=</span> <span class="n">readMavenPom</span> <span class="nl">file:</span> <span class="s1">&#39;./pom.xml&#39;</span>
                <span class="c1">// 设置 appName 和 appVersion 两个全局参数
</span><span class="c1"></span>                <span class="n">appName</span> <span class="o">=</span> <span class="s2">&#34;${pom.artifactId}&#34;</span>
                <span class="n">appVersion</span> <span class="o">=</span> <span class="s2">&#34;${pom.version}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Docker阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;docker&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Dockerfile 文件，但只能在方法块内使用
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;${params.DOCKER_DOCKERFILE_ID}&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;Dockerfile&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 设置 Docker 镜像名称
</span><span class="c1"></span>                        <span class="n">dockerImageName</span> <span class="o">=</span> <span class="s2">&#34;${params.DOCKER_HUB_URL}/${params.DOCKER_HUB_GROUP}/${appName}:${appVersion}&#34;</span>
                        <span class="c1">// 判断 DOCKER_HUB_GROUP 是否为空，有些仓库是不设置仓库组的
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="s2">&#34;${params.DOCKER_HUB_GROUP}&#34;</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">dockerImageName</span> <span class="o">=</span> <span class="s2">&#34;${params.DOCKER_HUB_URL}/${appName}:${appVersion}&#34;</span>
                        <span class="o">}</span>
                        <span class="c1">// 提供 Docker 环境，使用 Docker 工具来进行 Docker 镜像构建与推送
</span><span class="c1"></span>                        <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">&#34;http://${params.DOCKER_HUB_URL}&#34;</span><span class="o">,</span> <span class="s2">&#34;${params.DOCKER_HUB_CREADENTIAL}&#34;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="kt">def</span> <span class="n">customImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">)</span>
                            <span class="n">customImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Kubernetes 阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;kubectl&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 使用 Kubectl Cli 插件的方法，提供 Kubernetes 环境，在其方法块内部能够执行 kubectl 命令
</span><span class="c1"></span>                    <span class="n">withKubeConfig</span><span class="o">([</span><span class="nl">credentialsId:</span> <span class="s2">&#34;${params.KUBERNETES_CREADENTIAL}&#34;</span><span class="o">,</span><span class="nl">serverUrl:</span> <span class="s2">&#34;https://kubernetes.default.svc.cluster.local&#34;</span><span class="o">])</span> <span class="o">{</span>
                        <span class="c1">// 使用 configFile 插件，创建 Kubernetes 部署文件 deployment.yaml
</span><span class="c1"></span>                        <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;${params.KUBERNETES_DEPLOYMENT_ID}&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;deployment.yaml&#34;</span><span class="o">)]){</span>
                            <span class="c1">// 读取 Kubernetes 部署文件
</span><span class="c1"></span>                            <span class="n">deploy</span> <span class="o">=</span> <span class="n">readFile</span> <span class="nl">encoding:</span> <span class="s2">&#34;UTF-8&#34;</span><span class="o">,</span> <span class="nl">file:</span> <span class="s2">&#34;deployment.yaml&#34;</span>
                            <span class="c1">// 替换部署文件中的变量，并将替换后的文本赋予 deployfile 变量
</span><span class="c1"></span>                            <span class="n">deployfile</span> <span class="o">=</span> <span class="n">deploy</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_NAME&#34;</span><span class="o">,</span><span class="s2">&#34;${appName}&#34;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_REPLICAS&#34;</span><span class="o">,</span><span class="s2">&#34;${params.KUBERNETES_APP_REPLICAS}&#34;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_IMAGE_NAME&#34;</span><span class="o">,</span><span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_UUID&#34;</span><span class="o">,(</span><span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100000</span><span class="o">)).</span><span class="na">toString</span><span class="o">())</span>
                            <span class="c1">// 生成新的 Kubernetes 部署文件，内容为 deployfile 变量中的文本，文件名称为 &#34;deploy.yaml&#34;
</span><span class="c1"></span>                            <span class="n">writeFile</span> <span class="nl">encoding:</span> <span class="s1">&#39;UTF-8&#39;</span><span class="o">,</span> <span class="nl">file:</span> <span class="s1">&#39;./deploy.yaml&#39;</span><span class="o">,</span> <span class="nl">text:</span> <span class="s2">&#34;${deployfile}&#34;</span>
                            <span class="c1">// 输出新创建的部署 yaml 文件内容
</span><span class="c1"></span>                            <span class="n">sh</span> <span class="s2">&#34;cat deploy.yaml&#34;</span>
                            <span class="c1">// 执行 Kuberctl 命令进行部署操作
</span><span class="c1"></span>                            <span class="n">sh</span> <span class="s2">&#34;kubectl apply -n ${params.KUBERNETES_NAMESPACE} -f deploy.yaml&#34;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>变量介绍：</strong></p>
<ul>
<li><strong>KUBERNETES_DEPLOYMENT_ID：</strong> Kubernetes 部署文件的 ID。</li>
<li><strong>KUBERNETES_CREADENTIAL：</strong> Kubernetes API 认证凭据。</li>
<li><strong>KUBERNETES_NAMESPACE：</strong> Kubernetes 部署应用的 Namespace。</li>
<li><strong>KUBERNETES_APP_REPLICAS：</strong> Kubernetes 部署应用的副本数。</li>
<li><strong>appName：</strong> 从 pom.xml 中读取的应用名称。</li>
<li><strong>dockerImageName：</strong> Docker 镜像名称。</li>
</ul>
<h3 id="7http-健康检查模块">7、HTTP 健康检查模块</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">600</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;SECONDS&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;jnlp-agent&#34;</span>
    <span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="n">label</span><span class="o">,</span><span class="nl">cloud:</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="o">){</span>
        <span class="n">node</span> <span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Git阶段&#39;</span><span class="o">){</span>
                <span class="n">git</span> <span class="nl">changelog:</span> <span class="kc">true</span><span class="o">,</span>
                    <span class="nl">url:</span> <span class="s2">&#34;${params.GIT_PROJECT_URL}&#34;</span><span class="err">，</span>
                    <span class="nl">branch:</span> <span class="s2">&#34;${params.GIT_BRANCH}&#34;</span><span class="o">,</span>
                    <span class="nl">credentialsId:</span> <span class="s2">&#34;${params.GIT_CREADENTIAL}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Maven阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Maven 需要的 Settings.xml 文件
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;global-maven-settings&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;settings.xml&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 执行 Maven 命令构建项目
</span><span class="c1"></span>                        <span class="n">sh</span> <span class="s2">&#34;mvn -T 1C clean ${MAVEN_BUILD_OPTION} -Dmaven.test.skip=true --settings settings.xml&#34;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;读取pom.xml参数阶段&#39;</span><span class="o">){</span>
                <span class="c1">// 读取 Pom.xml 参数
</span><span class="c1"></span>                <span class="n">pom</span> <span class="o">=</span> <span class="n">readMavenPom</span> <span class="nl">file:</span> <span class="s1">&#39;./pom.xml&#39;</span>
                <span class="c1">// 设置 appName 和 appVersion 两个全局参数
</span><span class="c1"></span>                <span class="n">appName</span> <span class="o">=</span> <span class="s2">&#34;${pom.artifactId}&#34;</span>
                <span class="n">appVersion</span> <span class="o">=</span> <span class="s2">&#34;${pom.version}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Docker阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;docker&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Dockerfile 文件，但只能在方法块内使用
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;${params.DOCKER_DOCKERFILE_ID}&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;Dockerfile&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 设置 Docker 镜像名称
</span><span class="c1"></span>                        <span class="n">dockerImageName</span> <span class="o">=</span> <span class="s2">&#34;${params.DOCKER_HUB_URL}/${params.DOCKER_HUB_GROUP}/${appName}:${appVersion}&#34;</span>
                        <span class="c1">// 判断 DOCKER_HUB_GROUP 是否为空，有些仓库是不设置仓库组的
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="s2">&#34;${params.DOCKER_HUB_GROUP}&#34;</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">dockerImageName</span> <span class="o">=</span> <span class="s2">&#34;${params.DOCKER_HUB_URL}/${appName}:${appVersion}&#34;</span>
                        <span class="o">}</span>
                        <span class="c1">// 提供 Docker 环境，使用 Docker 工具来进行 Docker 镜像构建与推送
</span><span class="c1"></span>                        <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">&#34;http://${params.DOCKER_HUB_URL}&#34;</span><span class="o">,</span> <span class="s2">&#34;${params.DOCKER_HUB_CREADENTIAL}&#34;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="kt">def</span> <span class="n">customImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">)</span>
                            <span class="n">customImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Kubernetes 阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;kubectl&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 使用 Kubectl Cli 插件的方法，提供 Kubernetes 环境，在其方法块内部能够执行 kubectl 命令
</span><span class="c1"></span>                    <span class="n">withKubeConfig</span><span class="o">([</span><span class="nl">credentialsId:</span> <span class="s2">&#34;${params.KUBERNETES_CREADENTIAL}&#34;</span><span class="o">,</span><span class="nl">serverUrl:</span> <span class="s2">&#34;https://kubernetes.default.svc.cluster.local&#34;</span><span class="o">])</span> <span class="o">{</span>
                        <span class="c1">// 使用 configFile 插件，创建 Kubernetes 部署文件 deployment.yaml
</span><span class="c1"></span>                        <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;${params.KUBERNETES_DEPLOYMENT_ID}&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;deployment.yaml&#34;</span><span class="o">)]){</span>
                            <span class="c1">// 读取 Kubernetes 部署文件
</span><span class="c1"></span>                            <span class="n">deploy</span> <span class="o">=</span> <span class="n">readFile</span> <span class="nl">encoding:</span> <span class="s2">&#34;UTF-8&#34;</span><span class="o">,</span> <span class="nl">file:</span> <span class="s2">&#34;deployment.yaml&#34;</span>
                            <span class="c1">// 替换部署文件中的变量，并将替换后的文本赋予 deployfile 变量
</span><span class="c1"></span>                            <span class="n">deployfile</span> <span class="o">=</span> <span class="n">deploy</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_NAME&#34;</span><span class="o">,</span><span class="s2">&#34;${appName}&#34;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_REPLICAS&#34;</span><span class="o">,</span><span class="s2">&#34;${params.KUBERNETES_APP_REPLICAS}&#34;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_IMAGE_NAME&#34;</span><span class="o">,</span><span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_UUID&#34;</span><span class="o">,(</span><span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100000</span><span class="o">)).</span><span class="na">toString</span><span class="o">())</span>
                            <span class="c1">// 生成新的 Kubernetes 部署文件，内容为 deployfile 变量中的文本，文件名称为 &#34;deploy.yaml&#34;
</span><span class="c1"></span>                            <span class="n">writeFile</span> <span class="nl">encoding:</span> <span class="s1">&#39;UTF-8&#39;</span><span class="o">,</span> <span class="nl">file:</span> <span class="s1">&#39;./deploy.yaml&#39;</span><span class="o">,</span> <span class="nl">text:</span> <span class="s2">&#34;${deployfile}&#34;</span>
                            <span class="c1">// 输出新创建的部署 yaml 文件内容
</span><span class="c1"></span>                            <span class="n">sh</span> <span class="s2">&#34;cat deploy.yaml&#34;</span>
                            <span class="c1">// 执行 Kuberctl 命令进行部署操作
</span><span class="c1"></span>                            <span class="n">sh</span> <span class="s2">&#34;kubectl apply -n ${params.KUBERNETES_NAMESPACE} -f deploy.yaml&#34;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;健康检查阶段&#39;</span><span class="o">){</span>
                <span class="c1">// 设置检测延迟时间 10s,10s 后再开始检测
</span><span class="c1"></span>                <span class="n">sleep</span> <span class="mi">10</span>
                <span class="c1">// 健康检查地址
</span><span class="c1"></span>                <span class="n">httpRequestUrl</span> <span class="o">=</span> <span class="s2">&#34;http://${appName}.${params.KUBERNETES_NAMESPACE}:${params.HTTP_REQUEST_PORT}${params.HTTP_REQUEST_URL}&#34;</span>
                <span class="c1">// 循环使用 httpRequest 请求，检测服务是否启动
</span><span class="c1"></span>                <span class="k">for</span><span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="s2">&#34;${params.HTTP_REQUEST_NUMBER}&#34;</span><span class="o">.</span><span class="na">toInteger</span><span class="o">();</span> <span class="n">n</span><span class="o">++){</span>
                    <span class="k">try</span><span class="o">{</span>
                        <span class="c1">// 输出请求信息和请求次数
</span><span class="c1"></span>                        <span class="n">print</span> <span class="s2">&#34;访问服务：${appName} n&#34;</span> <span class="o">+</span>
                              <span class="s2">&#34;访问地址：${httpRequestUrl} n&#34;</span> <span class="o">+</span>
                              <span class="s2">&#34;访问次数：${n}&#34;</span>
                        <span class="c1">// 如果非第一次检测，就睡眠一段时间，等待再次执行 httpRequest 请求
</span><span class="c1"></span>                        <span class="k">if</span><span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">){</span>
                            <span class="n">sleep</span> <span class="s2">&#34;${params.HTTP_REQUEST_INTERVAL}&#34;</span><span class="o">.</span><span class="na">toInteger</span><span class="o">()</span>
                        <span class="o">}</span>
                        <span class="c1">// 使用 HttpRequest 插件的 httpRequest 方法检测对应地址
</span><span class="c1"></span>                        <span class="n">result</span> <span class="o">=</span> <span class="n">httpRequest</span> <span class="s2">&#34;${httpRequestUrl}&#34;</span>
                        <span class="c1">// 判断是否返回 200
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="s2">&#34;${result.status}&#34;</span> <span class="o">==</span> <span class="s2">&#34;200&#34;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">print</span> <span class="s2">&#34;Http 请求成功，流水线结束&#34;</span>
                            <span class="k">break</span>
                        <span class="o">}</span>
                    <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
                        <span class="n">print</span> <span class="s2">&#34;监控检测失败，将在 ${params.HTTP_REQUEST_INTERVAL} 秒后将再次检测。&#34;</span>
                        <span class="c1">// 判断检测次数是否为最后一次检测，如果是最后一次检测，并且还失败了，就对整个 Jenkins 任务标记为失败
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="s2">&#34;${params.HTTP_REQUEST_NUMBER}&#34;</span><span class="o">.</span><span class="na">toInteger</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">currentBuild</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="s2">&#34;FAILURE&#34;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>变量介绍：</strong></p>
<ul>
<li><strong>HTTP_REQUEST_PORT：</strong> HTTP 健康检查端口。</li>
<li><strong>HTTP_REQUEST_URL：</strong> HTTP 健康检查 URL 地址。</li>
<li><strong>HTTP_REQUEST_NUMBER：</strong> HTTP 健康检查次数。</li>
<li><strong>HTTP_REQUEST_INTERVAL：</strong> HTTP 健康检查间隔。</li>
<li><strong>KUBERNETES_NAMESPACE：</strong> Kubernetes 的 Namespace。</li>
<li><strong>appName：</strong> 从 pom.xml 中读取的应用名称。</li>
</ul>
<h3 id="8完整脚本">8、完整脚本</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="kt">def</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&#34;jnlp-agent&#34;</span>
<span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">900</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">&#39;SECONDS&#39;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">podTemplate</span><span class="o">(</span><span class="nl">label:</span> <span class="n">label</span><span class="o">,</span><span class="nl">cloud:</span> <span class="s1">&#39;kubernetes&#39;</span> <span class="o">){</span>
        <span class="n">node</span> <span class="o">(</span><span class="n">label</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Git阶段&#39;</span><span class="o">){</span>
                <span class="c1">// 执行 Git 命令进行 Clone 项目
</span><span class="c1"></span>                <span class="n">git</span> <span class="nl">changelog:</span> <span class="kc">true</span><span class="o">,</span>
                    <span class="nl">branch:</span> <span class="s2">&#34;${params.GIT_BRANCH}&#34;</span><span class="o">,</span>
                    <span class="nl">credentialsId:</span> <span class="s2">&#34;${params.GIT_CREADENTIAL}&#34;</span><span class="o">,</span>
                    <span class="nl">url:</span> <span class="s2">&#34;${GIT_PROJECT_URL}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Maven阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;maven&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Maven 需要的 Settings.xml 文件
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;global-maven-settings&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;settings.xml&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 执行 Maven 命令构建项目，并且设置 Maven 配置为刚刚创建的 Settings.xml 文件
</span><span class="c1"></span>                        <span class="n">sh</span> <span class="s2">&#34;mvn -T 1C clean ${MAVEN_BUILD_OPTION} -Dmaven.test.skip=true --settings settings.xml&#34;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;读取pom.xml参数阶段&#39;</span><span class="o">){</span>
                <span class="c1">// 读取 Pom.xml 参数
</span><span class="c1"></span>                <span class="n">pom</span> <span class="o">=</span> <span class="n">readMavenPom</span> <span class="nl">file:</span> <span class="s1">&#39;./pom.xml&#39;</span>
                <span class="c1">// 设置 appName 和 appVersion 两个全局参数
</span><span class="c1"></span>                <span class="n">appName</span> <span class="o">=</span> <span class="s2">&#34;${pom.artifactId}&#34;</span>
                <span class="n">appVersion</span> <span class="o">=</span> <span class="s2">&#34;${pom.version}&#34;</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Docker阶段&#39;</span><span class="o">){</span>
                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;docker&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建 Dockerfile 文件，但只能在方法块内使用
</span><span class="c1"></span>                    <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;${params.DOCKER_DOCKERFILE_ID}&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;Dockerfile&#34;</span><span class="o">)]){</span>
                        <span class="c1">// 设置 Docker 镜像名称
</span><span class="c1"></span>                        <span class="n">dockerImageName</span> <span class="o">=</span> <span class="s2">&#34;${params.DOCKER_HUB_URL}/${params.DOCKER_HUB_GROUP}/${appName}:${appVersion}&#34;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="s2">&#34;${params.DOCKER_HUB_GROUP}&#34;</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">dockerImageName</span> <span class="o">=</span> <span class="s2">&#34;${params.DOCKER_HUB_URL}/${appName}:${appVersion}&#34;</span>
                        <span class="o">}</span>
                        <span class="c1">// 提供 Docker 环境，使用 Docker 工具来进行 Docker 镜像构建与推送
</span><span class="c1"></span>                        <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s2">&#34;http://${params.DOCKER_HUB_URL}&#34;</span><span class="o">,</span> <span class="s2">&#34;${params.DOCKER_HUB_CREADENTIAL}&#34;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="kt">def</span> <span class="n">customImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">)</span>
                            <span class="n">customImage</span><span class="o">.</span><span class="na">push</span><span class="o">()</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Kubernetes 阶段&#39;</span><span class="o">){</span>
                <span class="c1">// kubectl 镜像
</span><span class="c1"></span>                <span class="n">container</span><span class="o">(</span><span class="s1">&#39;kubectl&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 使用 Kubectl Cli 插件的方法，提供 Kubernetes 环境，在其方法块内部能够执行 kubectl 命令
</span><span class="c1"></span>                    <span class="n">withKubeConfig</span><span class="o">([</span><span class="nl">credentialsId:</span> <span class="s2">&#34;${params.KUBERNETES_CREADENTIAL}&#34;</span><span class="o">,</span><span class="nl">serverUrl:</span> <span class="s2">&#34;https://kubernetes.default.svc.cluster.local&#34;</span><span class="o">])</span> <span class="o">{</span>
                        <span class="c1">// 使用 configFile 插件，创建 Kubernetes 部署文件 deployment.yaml
</span><span class="c1"></span>                        <span class="n">configFileProvider</span><span class="o">([</span><span class="n">configFile</span><span class="o">(</span><span class="nl">fileId:</span> <span class="s2">&#34;${params.KUBERNETES_DEPLOYMENT_ID}&#34;</span><span class="o">,</span> <span class="nl">targetLocation:</span> <span class="s2">&#34;deployment.yaml&#34;</span><span class="o">)]){</span>
                            <span class="c1">// 读取 Kubernetes 部署文件
</span><span class="c1"></span>                            <span class="n">deploy</span> <span class="o">=</span> <span class="n">readFile</span> <span class="nl">encoding:</span> <span class="s2">&#34;UTF-8&#34;</span><span class="o">,</span> <span class="nl">file:</span> <span class="s2">&#34;deployment.yaml&#34;</span>
                            <span class="c1">// 替换部署文件中的变量，并将替换后的文本赋予 deployfile 变量
</span><span class="c1"></span>                            <span class="n">deployfile</span> <span class="o">=</span> <span class="n">deploy</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_NAME&#34;</span><span class="o">,</span><span class="s2">&#34;${appName}&#34;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_REPLICAS&#34;</span><span class="o">,</span><span class="s2">&#34;${params.KUBERNETES_APP_REPLICAS}&#34;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_IMAGE_NAME&#34;</span><span class="o">,</span><span class="s2">&#34;${dockerImageName}&#34;</span><span class="o">)</span>
                                           <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s2">&#34;#APP_UUID&#34;</span><span class="o">,(</span><span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">100000</span><span class="o">)).</span><span class="na">toString</span><span class="o">())</span>
                            <span class="c1">// 生成新的 Kubernetes 部署文件，内容为 deployfile 变量中的文本，文件名称为 &#34;deploy.yaml&#34;
</span><span class="c1"></span>                            <span class="n">writeFile</span> <span class="nl">encoding:</span> <span class="s1">&#39;UTF-8&#39;</span><span class="o">,</span> <span class="nl">file:</span> <span class="s1">&#39;./deploy.yaml&#39;</span><span class="o">,</span> <span class="nl">text:</span> <span class="s2">&#34;${deployfile}&#34;</span>
                            <span class="c1">// 输出新创建的部署 yaml 文件内容
</span><span class="c1"></span>                            <span class="n">sh</span> <span class="s2">&#34;cat deploy.yaml&#34;</span>
                            <span class="c1">// 执行 Kuberctl 命令进行部署操作
</span><span class="c1"></span>                            <span class="n">sh</span> <span class="s2">&#34;kubectl apply -n ${params.KUBERNETES_NAMESPACE} -f deploy.yaml&#34;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;应用启动检查&#39;</span><span class="o">){</span>
                <span class="c1">// 设置检测延迟时间 10s,10s 后再开始检测
</span><span class="c1"></span>                <span class="n">sleep</span> <span class="mi">10</span>
                <span class="c1">// 健康检查地址
</span><span class="c1"></span>                <span class="n">httpRequestUrl</span> <span class="o">=</span> <span class="s2">&#34;http://${appName}.${params.KUBERNETES_NAMESPACE}:${params.HTTP_REQUEST_PORT}${params.HTTP_REQUEST_URL}&#34;</span>
                <span class="c1">// 循环使用 httpRequest 请求，检测服务是否启动
</span><span class="c1"></span>                <span class="k">for</span><span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="s2">&#34;${params.HTTP_REQUEST_NUMBER}&#34;</span><span class="o">.</span><span class="na">toInteger</span><span class="o">();</span> <span class="n">n</span><span class="o">++){</span>
                    <span class="k">try</span><span class="o">{</span>
                        <span class="c1">// 输出请求信息和请求次数
</span><span class="c1"></span>                        <span class="n">print</span> <span class="s2">&#34;访问服务：${appName} n&#34;</span> <span class="o">+</span>
                              <span class="s2">&#34;访问地址：${httpRequestUrl} n&#34;</span> <span class="o">+</span>
                              <span class="s2">&#34;访问次数：${n}&#34;</span>
                        <span class="c1">// 如果非第一次检测，就睡眠一段时间，等待再次执行 httpRequest 请求
</span><span class="c1"></span>                        <span class="k">if</span><span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">){</span>
                            <span class="n">sleep</span> <span class="s2">&#34;${params.HTTP_REQUEST_INTERVAL}&#34;</span><span class="o">.</span><span class="na">toInteger</span><span class="o">()</span>
                        <span class="o">}</span>
                        <span class="c1">// 使用 HttpRequest 插件的 httpRequest 方法检测对应地址
</span><span class="c1"></span>                        <span class="n">result</span> <span class="o">=</span> <span class="n">httpRequest</span> <span class="s2">&#34;${httpRequestUrl}&#34;</span>
                        <span class="c1">// 判断是否返回 200
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="s2">&#34;${result.status}&#34;</span> <span class="o">==</span> <span class="s2">&#34;200&#34;</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">print</span> <span class="s2">&#34;Http 请求成功，流水线结束&#34;</span>
                            <span class="k">break</span>
                        <span class="o">}</span>
                    <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
                        <span class="n">print</span> <span class="s2">&#34;监控检测失败，将在 ${params.HTTP_REQUEST_INTERVAL} 秒后将再次检测。&#34;</span>
                        <span class="c1">// 判断检测次数是否为最后一次检测，如果是最后一次检测，并且还失败了，就对整个 Jenkins 任务标记为失败
</span><span class="c1"></span>                        <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="s2">&#34;${params.HTTP_REQUEST_NUMBER}&#34;</span><span class="o">.</span><span class="na">toInteger</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">currentBuild</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="s2">&#34;FAILURE&#34;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>将该流水线代码，配置到之前的模板 Job 的流水线脚本中，方便后续项目以此项目为模板。</p>
<h2 id="九创建任务从模板任务复制配置">九、创建任务从模板任务复制配置</h2>
<p>这里我们新创建一个测试的示例项目 Job，命名为 <strong>new-test</strong>，除了新建命名外，其它配置直接复制上面的模板 Job，然后修改配置中的默认的 Git 地址、Git 凭据、Kubernetes Namespace 等变量参数值。</p>
<h3 id="1创建新的-job-并复制模板项目配置">1、创建新的 Job 并复制模板项目配置</h3>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-test-job-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-test-job-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<h3 id="2修改新建-job-的部分配置项">2、修改新建 Job 的部分配置项</h3>
<p><strong>修改 Git 项目地址</strong></p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-test-job-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-test-job-2.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>修改 Git 凭据</strong></p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-test-job-3.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-test-job-3.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p><strong>修改 Kubernetes Namespace</strong></p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-test-job-4.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-test-job-4.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p>一般情况下就需要修改上面这些参数，其它默认即可，不过特殊项目特殊处理，例如，健康检查端口非 8081 就需要单独改端口变量配置，检查地址非 /actuator/health 就需要检查健康检查地址，Docker hub 凭据非默认设置就需要配置新的凭据等等，这些都需要根据项目的不同单独修改的。</p>
<h2 id="十执行-pipeline-任务进行测试">十、执行 pipeline 任务进行测试</h2>
<p>执行上面创建的 Pipeline Job，点击 Build with Parameters 查看配置的参数是否有误，没有错误就开始执行任务。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-check-2.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-check-2.png?x-oss-process=style/shuiyin" alt=""></a> <a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-check-1.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-check-1.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p>查看整个执行的各个节点，是否哪部都能够成功构建，如果出现错误，需要查看控制台输出的日志查找错误点，然后对脚本进行修改。</p>
<p><a href="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-check-3.png?x-oss-process=style/shuiyin"><img src="https://mydlq-club.oss-cn-beijing.aliyuncs.com/images/jenkins-kubernetes-ci&amp;cd-check-3.png?x-oss-process=style/shuiyin" alt=""></a></p>
<p>—END—</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">gzxb0712</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-07-05 19:01
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/gzxb0712/blog/blob/master/LICENSE">MIT</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/wechat.png">
        <span>微信佛系打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/alipay.jpg">
        <span>支付宝佛系打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/jenkins/">jenkins</a>
          <a href="/tags/cicd/">cicd</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/cloud/docker_all_ops/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">docker最佳实践总结</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/cicd/jenkins_metal_best_practice/">
            <span class="next-text nav-default">jenkins裸机安装最佳实践</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://www.cnblogs.com/gzxb0712" class="iconfont icon-cnblogs" title="cnblogs"></a>
      <a href="mailto:gzxb0712@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/gzxb0712" class="iconfont icon-github" title="github"></a>
      <a href="https://juejin.im/user/59aeb829f265da249960595a" class="iconfont icon-juejin" title="juejin"></a>
      <a href="https://www.v2ex.com/member/gzxb0712" class="iconfont icon-v2ex" title="v2ex"></a>
  <a href="https://xiebiao.top/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">gzxb0712</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-CN".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138883536-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>

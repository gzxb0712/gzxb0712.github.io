<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Redis 5.0 部署及使用 - Bill Technology</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="gzxb0712" /><meta name="description" content="一、简介 1.1 Redis是什么 Redis是一个开源的，使用ANSI C 编写，高性能的Key-Value的NoSQL数据库。 1.2 Redis特点 （1）基" /><meta name="keywords" content="Mac, Github, Vue, React, Front End" />






<meta name="generator" content="Hugo 0.93.0-DEV with theme even" />


<link rel="canonical" href="https://js.xiebiao.top/post/database/redis5_cluster_ops/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.32d4dc642fec98c34c80bebb9c784c50771712b4a8a25d9f4dd9cce3534b426e.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/reset-even.css">


<meta property="og:title" content="Redis 5.0 部署及使用" />
<meta property="og:description" content="一、简介 1.1 Redis是什么 Redis是一个开源的，使用ANSI C 编写，高性能的Key-Value的NoSQL数据库。 1.2 Redis特点 （1）基" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://js.xiebiao.top/post/database/redis5_cluster_ops/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-06-05T21:09:30+00:00" />
<meta property="article:modified_time" content="2020-06-05T21:09:30+00:00" />

<meta itemprop="name" content="Redis 5.0 部署及使用">
<meta itemprop="description" content="一、简介 1.1 Redis是什么 Redis是一个开源的，使用ANSI C 编写，高性能的Key-Value的NoSQL数据库。 1.2 Redis特点 （1）基"><meta itemprop="datePublished" content="2020-06-05T21:09:30+00:00" />
<meta itemprop="dateModified" content="2020-06-05T21:09:30+00:00" />
<meta itemprop="wordCount" content="11896">
<meta itemprop="keywords" content="Redis,database," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Redis 5.0 部署及使用"/>
<meta name="twitter:description" content="一、简介 1.1 Redis是什么 Redis是一个开源的，使用ANSI C 编写，高性能的Key-Value的NoSQL数据库。 1.2 Redis特点 （1）基"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Bill Technology</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Bill Technology</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Redis 5.0 部署及使用</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-06-05 21:09 </span>
        <div class="post-category">
            <a href="/categories/database/"> database </a>
            </div>
          <span class="more-meta"> 约 11896 字 </span>
          <span class="more-meta"> 预计阅读 24 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#11-redis是什么">1.1 Redis是什么</a></li>
    <li><a href="#12-redis特点">1.2 Redis特点</a>
      <ul>
        <li><a href="#13-数据模型重点">1.3 数据模型（重点）</a></li>
      </ul>
    </li>
    <li><a href="#14-redis作用">1.4 Redis作用</a>
      <ul>
        <li><a href="#1本质是数据库能存储数据">（1）本质是数据库，能存储数据。</a></li>
        <li><a href="#2缓存数据">（2）缓存数据。</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#11-说明">1.1 说明</a></li>
    <li><a href="#12-redis安装步骤">1.2 redis安装步骤</a></li>
    <li><a href="#13-redisconf常用配置说明">1.3 redis.conf常用配置说明</a></li>
    <li><a href="#14-redis启动方式">1.4 redis启动方式</a></li>
    <li><a href="#15-redis关闭">1.5 redis关闭</a></li>
  </ul>

  <ul>
    <li><a href="#31-rdb快照模式">3.1 RDB（快照模式）</a>
      <ul>
        <li><a href="#311-策略">3.1.1 策略</a></li>
        <li><a href="#312-优点">3.1.2 优点</a></li>
        <li><a href="#313-缺点">3.1.3 缺点</a></li>
      </ul>
    </li>
    <li><a href="#32-aof追加模式文本重演">3.2 AOF（追加模式、文本重演）</a>
      <ul>
        <li><a href="#321-写入机制">3.2.1 写入机制</a></li>
        <li><a href="#322-写入磁盘的策略">3.2.2 写入磁盘的策略</a></li>
        <li><a href="#323-重写机制">3.2.3 重写机制</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#41-redis集群简介">4.1 redis集群简介</a>
      <ul>
        <li><a href="#411-集群的概念">4.1.1 集群的概念</a></li>
      </ul>
    </li>
    <li><a href="#4-2-redis主从复制">4. 2 redis主从复制</a>
      <ul>
        <li><a href="#421-概念">4.2.1 概念</a></li>
        <li><a href="#422-特点">4.2.2 特点</a></li>
        <li><a href="#423-基于配置实现">4.2.3 基于配置实现</a></li>
      </ul>
    </li>
    <li><a href="#43-sentinel哨兵模式">4.3 Sentinel哨兵模式</a>
      <ul>
        <li><a href="#431-主从模式的缺陷">4.3.1 主从模式的缺陷</a></li>
        <li><a href="#432-哨兵的任务">4.3.2 哨兵的任务</a></li>
        <li><a href="#433-哨兵模式部署">4.3.3 哨兵模式部署</a></li>
        <li><a href="#434-测试">4.3.4 测试</a></li>
        <li><a href="#435-结论">4.3.5 结论</a></li>
        <li><a href="#436-注意事项">4.3.6 注意事项</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#51-哨兵模式的缺陷">5.1 哨兵模式的缺陷</a></li>
    <li><a href="#52-redis-cluster集群概念">5.2 Redis-cluster集群概念</a></li>
    <li><a href="#53-集群节点复制">5.3 集群节点复制</a></li>
    <li><a href="#54-故障转移">5.4 故障转移</a></li>
    <li><a href="#55-集群分片策略">5.5 集群分片策略</a></li>
    <li><a href="#56-集群redirect转向">5.6 集群redirect转向</a></li>
    <li><a href="#57-集群搭建">5.7 集群搭建</a>
      <ul>
        <li><a href="#571-准备工作">5.7.1 准备工作</a></li>
        <li><a href="#572-集群规划">5.7.2 集群规划</a></li>
        <li><a href="#573-启动每个节点redis服务">5.7.3 启动每个节点redis服务</a></li>
        <li><a href="#574-执行创建集群命令">5.7.4 执行创建集群命令</a></li>
        <li><a href="#575-查询集群信息">5.7.5 查询集群信息</a></li>
        <li><a href="#576-redis-cluster集群重新启动">5.7.6 redis cluster集群重新启动</a></li>
        <li><a href="#577-redis-cli集群命令帮助">5.7.7 redis-cli集群命令帮助</a></li>
      </ul>
    </li>
    <li><a href="#58-集群管理">5.8 集群管理</a>
      <ul>
        <li><a href="#581-添加新主节点">5.8.1 添加新主节点</a></li>
        <li><a href="#582-hash槽重新分配">5.8.2 hash槽重新分配</a></li>
        <li><a href="#582-添加新从节点">5.8.2 添加新从节点</a></li>
        <li><a href="#583-删除节点">5.8.3 删除节点</a></li>
        <li><a href="#584-集群常用命令">5.8.4 集群常用命令</a></li>
      </ul>
    </li>
    <li><a href="#59-注意事项">5.9 注意事项</a>
      <ul>
        <li><a href="#591-防火墙端口放行">5.9.1 防火墙端口放行</a></li>
        <li><a href="#592-登录节点问题">5.9.2 登录节点问题</a></li>
        <li><a href="#593-如何删除集群中无效的节点">5.9.3 如何删除集群中无效的节点</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="hint">
      <p>【注意】最后更新于 <span class="timeago" datetime="2020-06-05T21:09:30" title="June 5, 2020">June 5, 2020</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
    <div class="post-content">
      <!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h1 id="一简介">一、简介</h1>
<h2 id="11-redis是什么">1.1 Redis是什么</h2>
<p>Redis是一个开源的，使用ANSI C 编写，高性能的Key-Value的NoSQL数据库。</p>
<h2 id="12-redis特点">1.2 Redis特点</h2>
<p>（1）基于内存</p>
<p>（2）可持久化数据</p>
<p>（3）具有丰富的数据结构类型，适应非关系型数据的存储需求</p>
<p>（4）支持绝大多数主流开发语言，如C、C++、Java、Python、R、JavaScript等。</p>
<p>（5）支持集群模式，高效、稳定。</p>
<h3 id="13-数据模型重点">1.3 数据模型（重点）</h3>
<p>（1）键值对形式。</p>
<p>（2）Redis的数据结构类型，指的就是Redis值的结构类型。</p>
<h2 id="14-redis作用">1.4 Redis作用</h2>
<h3 id="1本质是数据库能存储数据">（1）本质是数据库，能存储数据。</h3>
<p>Redis能灵活处理非关系型数据的读、写问题，是对MySQL等关系型数据库的补充。</p>
<p>新浪微博就是使用Redis集群做数据库。</p>
<h3 id="2缓存数据">（2）缓存数据。</h3>
<p>所谓缓存，就是将数据加载到内存中后直接使用，而不是每次都通过IO流从磁盘上读取。好处：读写效率高。</p>
<p>而Redis则是将数据直接存储在内存中，只有当内存空间不足时，将部分数据持久化到磁盘上。</p>
<h1 id="二安装">二、安装</h1>
<h2 id="11-说明">1.1 说明</h2>
<p>Redis官方只提供了源码，并没有提供经过编译之后的安装包。
因此，安装Redis，要先编译、后安装。（即源码安装方式）</p>
<h2 id="12-redis安装步骤">1.2 redis安装步骤</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 安装步骤</span>
<span class="nb">cd</span> /usr/local/src
wget http://download.redis.io/releases/redis-5.0.4.tar.gz
tar -zxv -f redis-5.0.4.tar.gz
<span class="nb">cd</span> /usr/local/src/redis-5.0.4/
make <span class="nv">MALLOC</span><span class="o">=</span>libc <span class="o">(</span>或者直接make,不用./configure<span class="o">)</span>
make install <span class="o">(</span>安装到指定目录：make <span class="nv">PREFIX</span><span class="o">=</span>/usr/local/redis install，不指定的话默认安装到/usr/local/bin目录下，也可以执行该步骤，也就是安装<span class="o">)</span>

<span class="c1"># 不安装的话命令执行文件路径是：/usr/local/src/redis-5.0.4/src</span>

<span class="c1"># 配置文件：/usr/local/src/redis-5.0.4/redis.conf</span>

<span class="c1"># 优化配置，使用root账号操作</span>
<span class="c1"># vim /etc/sysctl.conf</span>
vm.overcommit_memory <span class="o">=</span> <span class="m">1</span>
net.core.somaxconn <span class="o">=</span> <span class="m">2048</span>
<span class="c1"># sysctl -p</span>

<span class="c1"># echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span>
<span class="c1"># vim /etc/rc.d/rc.local</span>
<span class="k">if</span> <span class="nb">test</span> -f /sys/kernel/mm/transparent_hugepage/enabled<span class="p">;</span> <span class="k">then</span>
   <span class="nb">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
<span class="k">fi</span>

<span class="k">if</span> <span class="nb">test</span> -f /sys/kernel/mm/transparent_hugepage/defrag<span class="p">;</span> <span class="k">then</span>
   <span class="nb">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag
<span class="k">fi</span>
<span class="c1"># chmod +x /etc/rc.d/rc.local</span>

<span class="c1"># vim /etc/security/limits.conf</span>
* soft nofile <span class="m">65535</span>
* hard nofile <span class="m">65535</span>

<span class="c1"># 启动</span>
<span class="o">[</span>sandu@bogon ~<span class="o">]</span><span class="c1"># ./src/redis-server ./redis.conf</span>
1270:C <span class="m">02</span> Aug <span class="m">2019</span> 16:27:19.274 <span class="c1"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
1270:C <span class="m">02</span> Aug <span class="m">2019</span> 16:27:19.275 <span class="c1"># Redis version=5.0.4, bits=64, commit=00000000, modified=0, pid=1270, just started</span>
1270:C <span class="m">02</span> Aug <span class="m">2019</span> 16:27:19.275 <span class="c1"># Configuration loaded</span>
                _._
           _.-<span class="sb">``</span>__ <span class="s1">&#39;&#39;</span>-._
      _.-<span class="sb">``</span>    <span class="sb">`</span>.  <span class="sb">`</span>_.  <span class="s1">&#39;&#39;</span>-._           Redis 5.0.4 <span class="o">(</span>00000000/0<span class="o">)</span> <span class="m">64</span> bit
  .-<span class="sb">``</span> .-<span class="sb">```</span>.  <span class="sb">```</span><span class="se">\/</span>    _.,_ <span class="s1">&#39;&#39;</span>-._
 <span class="o">(</span>    <span class="s1">&#39;      ,       .-`  | `,    )     Running in standalone mode
</span><span class="s1"> |`-._`-...-` __...-.``-._|&#39;</span><span class="sb">`</span> _.-<span class="s1">&#39;|     Port: 6379
</span><span class="s1"> |    `-._   `._    /     _.-&#39;</span>    <span class="p">|</span>     PID: <span class="m">1270</span>
  <span class="sb">`</span>-._    <span class="sb">`</span>-._  <span class="sb">`</span>-./  _.-<span class="s1">&#39;    _.-&#39;</span>
 <span class="p">|</span><span class="sb">`</span>-._<span class="sb">`</span>-._    <span class="sb">`</span>-.__.-<span class="s1">&#39;    _.-&#39;</span>_.-<span class="s1">&#39;|
</span><span class="s1"> |    `-._`-._        _.-&#39;</span>_.-<span class="s1">&#39;    |           http://redis.io
</span><span class="s1">  `-._    `-._`-.__.-&#39;</span>_.-<span class="s1">&#39;    _.-&#39;</span>
 <span class="p">|</span><span class="sb">`</span>-._<span class="sb">`</span>-._    <span class="sb">`</span>-.__.-<span class="s1">&#39;    _.-&#39;</span>_.-<span class="s1">&#39;|
</span><span class="s1"> |    `-._`-._        _.-&#39;</span>_.-<span class="s1">&#39;    |
</span><span class="s1">  `-._    `-._`-.__.-&#39;</span>_.-<span class="s1">&#39;    _.-&#39;</span>
      <span class="sb">`</span>-._    <span class="sb">`</span>-.__.-<span class="s1">&#39;    _.-&#39;</span>
          <span class="sb">`</span>-._        _.-<span class="s1">&#39;
</span><span class="s1">              `-.__.-&#39;</span>

1270:M <span class="m">02</span> Aug <span class="m">2019</span> 16:27:19.277 <span class="c1"># Server initialized</span>
1270:M <span class="m">02</span> Aug <span class="m">2019</span> 16:27:19.277 * Ready to accept connections

<span class="c1"># 使用自带的客户端连接，默认没有密码直接连接</span>
<span class="o">[</span>sandu@bogon ~<span class="o">]</span><span class="c1"># ./src/redis-cli</span>
127.0.0.1:6379&gt; ping <span class="c1"># 检测redis服务是否启动</span>
PONG
127.0.0.1:6379&gt; <span class="nb">set</span> a <span class="m">1111</span>
OK
127.0.0.1:6379&gt; get a
<span class="s2">&#34;1111&#34;</span>
127.0.0.1:6379&gt; quit <span class="c1"># 退出</span>

<span class="c1"># 密码连接</span>
<span class="c1"># redis-cli -h host  -p port -a password</span>
<span class="o">[</span>sandu@bogon ~<span class="o">]</span><span class="c1"># ./src/redis-cli</span>
127.0.0.1:6379&gt; auth foobar2000
OK
127.0.0.1:6379&gt; <span class="nb">set</span> b <span class="m">222222</span>
OK
127.0.0.1:6379&gt; get b
<span class="s2">&#34;222222&#34;</span>
127.0.0.1:6379&gt; <span class="nb">exit</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="13-redisconf常用配置说明">1.3 redis.conf常用配置说明</h2>
<ul>
<li>
<p>bind：允许访问该redis的主机</p>
</li>
<li>
<p>protected-mode：保护模式，默认开启。若设置外部网络连接redis服务，设置方式如下：</p>
<p>1、关闭protected-mode模式，此时外部网络可以直接访问</p>
<p>2、开启protected-mode保护模式，需配置bind ip或者设置访问密码，或者bind ip和密码都设置</p>
</li>
<li>
<p>requirepass：设置密码</p>
</li>
<li>
<p>databases：Redis默认有16个数据库，寻址角标从0开始。默认连接db0。客户端使用select命令，切换数据库</p>
</li>
<li>
<p>port ：指定redis的服务端口，默认6379.</p>
</li>
<li>
<p>daemonize：Redis默认关闭后台进程模式，改成yes，redis服务在后台启动。</p>
</li>
<li>
<p>loglevel ：日志等级</p>
</li>
<li>
<p>logfile：Redis日志输出目录，默认不输出日志到文件。</p>
</li>
<li>
<p>dbfilename：指定数据持久化的文件名</p>
</li>
<li>
<p>dir ：指定数据持久化的文件存放目录，也是集群node.con文件存放目录</p>
</li>
<li>
<p>cluster-enabled：是否启用集群</p>
</li>
<li>
<p>cluster-config-file：集群文件</p>
</li>
</ul>
<h2 id="14-redis启动方式">1.4 redis启动方式</h2>
<ol>
<li>直接启动</li>
</ol>
<p>进入redis根目录，执行命令，加上‘&amp;’号使redis以后台程序方式运行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"> ./src/redis-server <span class="p">&amp;</span>

</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>通过指定配置文件启动
可以为redis服务启动指定配置文件，例如配置为/etc/redis/6379.conf</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">./src/redis-server /etc/redis/6379.conf

</code></pre></td></tr></table>
</div>
</div><p>进入redis根目录，输入命令，如果更改了端口，使用<code>redis-cli</code>客户端连接时，也需要指定端口，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">redis-cli -p <span class="m">6380</span>
<span class="c1"># redis-cli -h host  -p port -a password</span>

</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>使用redis启动脚本设置开机自启动，有问题，只能启动和停止，不能查看状态，也不能重载，还有就是关闭的话貌似关不掉，不予考虑该脚本</li>
</ol>
<p>启动脚本 redis_init_script 位于位于Redis的 /utils/ 目录下，redis_init_script脚本代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="c1">#</span>
<span class="c1"># Simple Redis init.d script conceived to work on Linux systems</span>
<span class="c1"># as it does use of the /proc filesystem.</span>

<span class="c1"># chkconfig:   2345 90 10</span>

<span class="c1">### BEGIN INIT INFO</span>
<span class="c1"># Provides:     redis_6379</span>
<span class="c1"># Default-Start:        2 3 4 5</span>
<span class="c1"># Default-Stop:         0 1 6</span>
<span class="c1"># Short-Description:    Redis data structure server</span>
<span class="c1"># Description:          Redis data structure server. See https://redis.io</span>
<span class="c1">### END INIT INFO</span>

<span class="c1">#redis服务器监听的端口</span>
<span class="nv">REDISPORT</span><span class="o">=</span><span class="m">6379</span>

<span class="c1">#服务端所处位置</span>
<span class="nv">EXEC</span><span class="o">=</span>/usr/local/bin/redis-server

<span class="c1">#客户端位置</span>
<span class="nv">CLIEXEC</span><span class="o">=</span>/usr/local/bin/redis-cli

<span class="c1">#redis的PID文件位置,根据实际情况修改</span>
<span class="nv">PIDFILE</span><span class="o">=</span>/var/run/redis_<span class="si">${</span><span class="nv">REDISPORT</span><span class="si">}</span>.pid

<span class="c1">#redis的配置文件位置，需将${REDISPORT}修改为文件名</span>
<span class="nv">CONF</span><span class="o">=</span><span class="s2">&#34;/etc/redis/</span><span class="si">${</span><span class="nv">REDISPORT</span><span class="si">}</span><span class="s2">.conf&#34;</span>

<span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
    start<span class="o">)</span>
        <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$PIDFILE</span> <span class="o">]</span>
        <span class="k">then</span>
                <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$PIDFILE</span><span class="s2"> exists, process is already running or crashed&#34;</span>
        <span class="k">else</span>
                <span class="nb">echo</span> <span class="s2">&#34;Starting Redis server...&#34;</span>
                <span class="nv">$EXEC</span> <span class="nv">$CONF</span>
        <span class="k">fi</span>
        <span class="p">;;</span>
    stop<span class="o">)</span>
        <span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$PIDFILE</span> <span class="o">]</span>
        <span class="k">then</span>
                <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$PIDFILE</span><span class="s2"> does not exist, process is not running&#34;</span>
        <span class="k">else</span>
                <span class="nv">PID</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$PIDFILE</span><span class="k">)</span>
                <span class="nb">echo</span> <span class="s2">&#34;Stopping ...&#34;</span>
                <span class="nv">$CLIEXEC</span> -p <span class="nv">$REDISPORT</span> shutdown
                <span class="k">while</span> <span class="o">[</span> -x /proc/<span class="si">${</span><span class="nv">PID</span><span class="si">}</span> <span class="o">]</span>
                <span class="k">do</span>
                    <span class="nb">echo</span> <span class="s2">&#34;Waiting for Redis to shutdown ...&#34;</span>
                    sleep <span class="m">1</span>
                <span class="k">done</span>
                <span class="nb">echo</span> <span class="s2">&#34;Redis stopped&#34;</span>
        <span class="k">fi</span>
        <span class="p">;;</span>
    *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&#34;Please use start or stop as first argument&#34;</span>
        <span class="p">;;</span>
<span class="k">esac</span>

</code></pre></td></tr></table>
</div>
</div><p>将启动脚本复制到/etc/init.d目录下，本例将启动脚本命名为redisd（通常都以d结尾表示是后台自启动服务）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span>
cp redis_init_script /etc/init.d/redisd
chkconfig redisd on
service redisd start<span class="p">|</span>stop

</code></pre></td></tr></table>
</div>
</div><h2 id="15-redis关闭">1.5 redis关闭</h2>
<ol>
<li>第一种关闭方式</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 断电，非正常关闭，容易导致数据丢失</span>
ps -ef <span class="p">|</span> grep redis
<span class="nb">kill</span> -9 PID

</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>第二种关闭方式</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 正常关闭，数据保存</span>
redis-cli shutdown <span class="c1"># 关闭redis服务，通过客户端进行shutdown</span>

<span class="c1"># 如果redis设置了密码，则需要先用客户端登录，然后再进行shutdown</span>
redis-cli -a password
127.0.0.1:6379&gt; shutdown

<span class="c1"># 重新启动redis服务，使用客户端连接，会发现数据还在</span>

</code></pre></td></tr></table>
</div>
</div><h1 id="三持久化">三、持久化</h1>
<p>Redis持久化，就是将内存中的数据，永久保存到磁盘上。</p>
<p>Redis持久化有两种方式：RDB(Redis DB)、AOF(AppendOnlyFile)</p>
<p>Redis 可以同时使用 AOF 持久化和 RDB 持久化。 在这种情况下， 当 Redis 重启时， 它会优先使用 AOF 文件来还原数据集， 因为 AOF 文件保存的数据集通常比 RDB 文件所保存的数据集更完整。</p>
<h2 id="31-rdb快照模式">3.1 RDB（快照模式）</h2>
<p>在默认情况下，Redis 将数据库快照保存在名字为dump.rdb的二进制文件中，可以在redis.conf配置文件中修改持久化信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">save 900 1 表示在900秒内，至少更新了1条数据。Redis就将数据持久化到硬盘
save 300 10 表示在300内，至少更新了10条数据，Redis就会触发将数据持久化到硬盘
save 60 10000 表示60秒内，至少更新了10000条数据，Redis就会触发将数据持久化到硬盘

</code></pre></td></tr></table>
</div>
</div><h3 id="311-策略">3.1.1 策略</h3>
<ol>
<li>自动：BGSAVE</li>
</ol>
<p>按照配置文件中的条件满足就执行BGSAVE；</p>
<p>非阻塞，Redis服务正常接收处理客户端请求；</p>
<p>Redis会folk()一个新的子进程来创建RDB文件，子进程处理完后会向父进程发送一个信号，通知它处理完毕；</p>
<p>父进程用新的dump.rdb替代旧文件。</p>
<ol start="2">
<li>手动：SAVE</li>
</ol>
<p>客户端（redis-cli）发起SAVE命令；</p>
<p>阻塞Redis服务，无法响应客户端请求；</p>
<p>创建新的dump.rdb替代旧文件。</p>
<h3 id="312-优点">3.1.2 优点</h3>
<ul>
<li>
<p>执行效率高；</p>
</li>
<li>
<p>恢复大数据集速度较AOF快。</p>
</li>
</ul>
<h3 id="313-缺点">3.1.3 缺点</h3>
<ul>
<li>
<p>会丢失最近写入、修改的而未能持久化的数据；</p>
</li>
<li>
<p>folk过程非常耗时，会造成毫秒级不能响应客户端请求。</p>
</li>
</ul>
<h2 id="32-aof追加模式文本重演">3.2 AOF（追加模式、文本重演）</h2>
<p>AOF默认关闭，需要在配置文件中手动开启。</p>
<p>记录所有的写操作命令，在服务启动的时候使用这些命令就可以还原数据库。</p>
<p>Append only file，采用追加的方式保存，默认文件appendonly.aof。</p>
<h3 id="321-写入机制">3.2.1 写入机制</h3>
<p>AOF机制，添加了一个内存缓冲区(buffer)：</p>
<ol>
<li>将内容写入缓冲区</li>
<li>当缓冲区被填满、或者用户手动执行fsync、或者系统根据指定的<strong>写入磁盘策略</strong>自动调用fdatasync命令，才将缓冲区里的内容真正写入磁盘里</li>
<li>在缓冲区里的内容未写入磁盘之前，可能会丢失</li>
</ol>
<h3 id="322-写入磁盘的策略">3.2.2 写入磁盘的策略</h3>
<p>appendfsync选项，这个选项的值可以是always、everysec或者no</p>
<ul>
<li>always：服务器每写入一个命令，就调用一次fdatasync，将缓冲区里面的命令写入到硬盘。这种模式下，服务器出现故障，也不会丢失任何已经成功执行的命令数据</li>
<li>everysec（默认）：服务器每一秒重调用一次fdatasync，将缓冲区里面的命令写入到硬盘。这种模式下，服务器出现故障，最多只丢失一秒钟内的执行的命令数据</li>
<li>no：服务器不主动调用fdatasync，由操作系统决定何时将缓冲区里面的命令写入到硬盘。这种模式下，服务器遭遇意外停机时，丢失命令的数量是不确定的，no 选项并不能给服务器性能带来多大的提升，而且也会增加系统奔溃时数据丢失的数量。</li>
</ul>
<p>运行速度：always的速度慢，everysec和no都很快</p>
<h3 id="323-重写机制">3.2.3 重写机制</h3>
<p>AOF文件过大，合并重复的操作，AOF会使用尽可能少的命令来记录</p>
<ol>
<li>重写过程</li>
</ol>
<p>（1）folk一个子进程负责重写AOF文件</p>
<p>（2）子进程会创建一个临时文件写入AOF信息</p>
<p>（3）父进程会开辟一个内存缓冲区接收新的写命令</p>
<p>（4）子进程重写完成后，父进程会获得一个信号，将父进程接收到的新的写操作由子进程写入到临时文件中</p>
<p>（5）新文件替代旧文件</p>
<p><strong>重写的本质：就是将操作同一个键的命令，合并。从而减小AOF文件的体积</strong></p>
<ol start="2">
<li>重写触发机制</li>
</ol>
<p>　（1）手动：</p>
<p>　客户端向服务器发送BGREWRITEAOF命令</p>
<p>　（2）自动：</p>
<p>　配置文件中的选项，自动执行BGREWRITEAOF命令</p>
<ul>
<li>auto-aof-rewrite-min-size ：触发AOF重写所需的最小体积：只要在AOF文件的体积大于等于size时，才会考虑是否需要进行AOF重写，这个选项用于避免对体积过小的AOF文件进行重写</li>
<li>auto-aof-rewrite-percentage ：指定触发重写所需的AOF文件体积百分比：当AOF文件的体积大于auto-aof-rewrite-min-size指定的体积，并且超过上一次重写之后的AOF文件体积的percent %时，就会触发AOF重写。（如果服务器刚刚启动不久，还没有进行过AOF重写，那么使用服务器启动时载入的AOF文件的体积来作为基准值）。将这个值设置为0表示关闭自动AOF重写。</li>
</ul>
<ol start="3">
<li>优点</li>
</ol>
<ul>
<li>
<p>写入机制，默认fysnc（手工同步）每秒执行，性能很好不阻塞服务，最多丢失一秒的数据；</p>
</li>
<li>
<p>重写机制，优化AOF文件；</p>
</li>
<li>
<p>如果误操作了（FLUSHALL等），只要AOF未被重写，停止服务移除AOF文件尾部FLUSHALL命令，重启Redis，可以将数据集恢复到FLUSHALL 执行之前的状态。</p>
</li>
</ul>
<ol start="4">
<li>缺点</li>
</ol>
<ul>
<li>
<p>相同数据集，AOF文件体积较RDB大了很多；</p>
</li>
<li>
<p>恢复数据库速度较RDB慢（文本，命令重演）</p>
</li>
</ul>
<h1 id="四集群">四、集群</h1>
<h2 id="41-redis集群简介">4.1 redis集群简介</h2>
<h3 id="411-集群的概念">4.1.1 集群的概念</h3>
<p>　　所谓的集群，就是通过添加服务器的数量，提供相同的服务，从而让服务器达到一个稳定、高效的状态。</p>
<h4 id="4111-使用redis集群的必要性">4.1.1.1 使用redis集群的必要性</h4>
<p>　　问题：我们已经部署好了redis，并且能启动一个redis，实现数据的读写，为什么还要学习redis集群？</p>
<p>　　答：（1）单个redis存在不稳定性。当redis服务宕机了，就没有可用的服务了。</p>
<p>　　　　（2）单个redis的读写能力是有限的。</p>
<p>　　总结：redis集群是为了强化redis的读写能力。</p>
<h4 id="4112-如何学习redis集群">4.1.1.2 如何学习redis集群</h4>
<p>说明：（1）redis集群中，每一个redis称之为一个节点。</p>
<p>　　　 （2）redis集群中，有两种类型的节点：主节点(master)、从节点(slave)。</p>
<p>　　　 （3）redis集群，是基于redis主从复制实现。</p>
<p>所以，学习redis集群，就是从学习redis主从复制模型开始的。</p>
<h2 id="4-2-redis主从复制">4. 2 redis主从复制</h2>
<h3 id="421-概念">4.2.1 概念</h3>
<p>　　主从复制模型中，有多个redis节点。</p>
<p>　　其中，<strong>有且仅有</strong>一个为主节点Master。从节点Slave可以有多个。</p>
<p>　　只要网络连接正常，Master会一直将自己的数据更新同步给Slaves，保持主从同步。</p>
<h3 id="422-特点">4.2.2 特点</h3>
<p>　　（1）主节点Master<strong>可读、可写.</strong></p>
<p>　　（2）从节点Slave只读。（read-only）</p>
<p>　　因此，主从模型可以提高<strong>读的能力</strong>，在一定程度上缓解了写的能力。因为能写仍然只有Master节点一个，可以将读的操作全部移交到从节点上，变相提高了写能力。</p>
<h3 id="423-基于配置实现">4.2.3 基于配置实现</h3>
<ol>
<li>需求</li>
</ol>
<ul>
<li>主节点：6380</li>
<li>从节点：6381、6382</li>
</ul>
<ol start="2">
<li>配置步骤</li>
</ol>
<p>（1）在/usr/local目录下，创建一个/redis/master-slave目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-b" data-lang="b"><span class="c">mkdir </span><span class="nb">-</span><span class="c">p /usr/local/redis/master</span><span class="nb">-</span><span class="c">slave
</span><span class="c">
</span></code></pre></td></tr></table>
</div>
</div><p>（2）在master-slave目录下，创建三个子目录6380、6381、6382</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mkdir <span class="m">6380</span> <span class="m">6381</span> <span class="m">6382</span>

</code></pre></td></tr></table>
</div>
</div><p>（3）依次拷贝redis解压目录下的redis.conf配置文件，到这三个子目录中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cp /usr/local/src/redis-5.0.4/redis.conf 6380/
cp /usr/local/src/redis-5.0.4/redis.conf 6381/
cp /usr/local/src/redis-5.0.4/redis.conf 6382/

</code></pre></td></tr></table>
</div>
</div><p>（4）进入6380目录，修改redis.conf，将port端口修改成6380即可</p>
<p>（5）进入6381目录，修改redis.conf，将port端口改成6381，同时指定开启主从复制</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">#     主节点ip 主节点端口
replicaof 127.0.0.1 6380

</code></pre></td></tr></table>
</div>
</div><p>（6）进入6382目录，修改redis.conf，将port端口改成6382，同时指定开启主从复制</p>
<ol start="3">
<li>测试</li>
</ol>
<p>（1）打开三个shell窗口，在每一个窗口中，启动一个redis节点。查看日志输出。（不要改成后台模式启动，看不到日志，不直观）</p>
<p>（2）另外再打开三个shell窗口，在每一个窗口中，登陆一个redis节点</p>
<p>（3）在主节点6380上，进行读写操作，操作成功</p>
<p>（4）在从节点6381上，读操作执行成功，并且成功从6380上同步了数据；写操作执行失败。（从节点，只能读，不能写）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 写操作执行失败提示</span>
<span class="o">(</span>error<span class="o">)</span> READONLY You can<span class="err">&#39;</span>t write against a <span class="nb">read</span> only replica.

</code></pre></td></tr></table>
</div>
</div><h2 id="43-sentinel哨兵模式">4.3 Sentinel哨兵模式</h2>
<h3 id="431-主从模式的缺陷">4.3.1 主从模式的缺陷</h3>
<p>当主节点宕机了，整个集群就没有可写的节点了。</p>
<p>问：由于从节点上备份了主节点的所有数据，那在主节点宕机的情况下，如果能够将从节点变成一个主节点，是不是就可以解决这个问题了呢？</p>
<p>答：是的，这个就是Sentinel哨兵的作用。</p>
<h3 id="432-哨兵的任务">4.3.2 哨兵的任务</h3>
<p>Redis 的 Sentinel 系统用于管理多个 Redis 服务器（instance）， 该系统执行以下三个任务：</p>
<ol>
<li>
<p>监控（Monitoring）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</p>
</li>
<li>
<p>提醒（Notification）： 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</p>
</li>
<li>
<p>自动故障迁移（Automatic failover）： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会进行选举，将其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</p>
</li>
</ol>
<h4 id="4321-监控monitoring">4.3.2.1 监控（Monitoring）</h4>
<p>　　（1）Sentinel可以监控任意多个Master和该Master下的Slaves。（即多个主从模式）</p>
<p>　　（2）同一个哨兵下的、不同主从模型，彼此之间相互独立。</p>
<p>　　（3）Sentinel会不断检查Master和Slaves是否正常。</p>
<h4 id="4321-自动故障切换automatic-failover">4.3.2.1 自动故障切换（Automatic failover）</h4>
<p>监控同一个Master的Sentinel会自动连接，组成一个分布式的Sentinel网络，互相通信并交换彼此关于被监视服务器的信息。</p>
<p>疑问：为什么要使用sentinel网络呢？</p>
<p>答：当只有一个sentinel的时候，如果这个sentinel挂掉了，那么就无法实现自动故障切换了。</p>
<p>　　在sentinel网络中，只要还有一个sentinel活着，就可以实现故障切换。</p>
<h4 id="4322-故障切换的过程">4.3.2.2 故障切换的过程</h4>
<p>（1）投票（半数原则）</p>
<p>　　当任何一个Sentinel发现被监控的Master下线时，会通知其它的Sentinel开会，投票确定该Master是否下线（半数以上，所以sentinel通常配奇数个）。</p>
<p>（2）选举</p>
<p>　　当Sentinel确定Master下线后，会在所有的Slaves中，选举一个新的节点，升级成Master节点。</p>
<p>　　其它Slaves节点，转为该节点的从节点。</p>
<p>（3）原Master重新上线</p>
<p>　　当原Master节点重新上线后，自动转为当前Master节点的从节点。</p>
<h3 id="433-哨兵模式部署">4.3.3 哨兵模式部署</h3>
<h4 id="4331-需求">4.3.3.1 需求</h4>
<p>前提：已经存在一个正在运行的主从模式。</p>
<p>另外，配置三个Sentinel实例，监控同一个Master节点</p>
<h4 id="4332-配置sentinel">4.3.3.2 配置Sentinel</h4>
<p>（1）在/usr/local目录下，创建/redis/sentinels/目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /usr/local/redis
mkdir sentinels

</code></pre></td></tr></table>
</div>
</div><p>（2）在sentinels目录下，依次创建s1、s2、s3三个子目录中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> sentinels
mkdir s1 s2 s3

</code></pre></td></tr></table>
</div>
</div><p>（3）依次拷贝redis解压目录下的sentinel.conf文件，到这三个子目录中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cp /usr/local/src/redis-5.0.4/sentinel.conf s1/
cp /usr/local/src/redis-5.0.4/sentinel.conf s2/
cp /usr/local/src/redis-5.0.4/sentinel.conf s3/

</code></pre></td></tr></table>
</div>
</div><p>（4）依次修改s1、s2、s3子目录中的sentinel.conf文件，修改端口，并指定要监控的主节点。（从节点不需要指定，sentinel会自动识别）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># s1 哨兵配置</span>
port <span class="m">26379</span>
sentinel monitor mymaster 127.0.0.1 <span class="m">6380</span> <span class="m">2</span>

<span class="c1"># mymaster为主节点别名，127.0.0.1为主节点IP，6380为主节点端口，2为触发故障切换的最少哨兵数量</span>

<span class="c1"># s2 哨兵配置</span>
port <span class="m">26380</span>
sentinel monitor mymaster 127.0.0.1 <span class="m">6380</span> <span class="m">2</span>

<span class="c1"># s3 哨兵配置</span>
port <span class="m">26381</span>
sentinel monitor mymaster 127.0.0.1 <span class="m">6380</span> <span class="m">2</span>

</code></pre></td></tr></table>
</div>
</div><p>（5）再打开三个shell窗口，在每一个窗口中，启动一个哨兵实例，并观察日志输出</p>
<hr>
<p>进入redis的安装目录，/usr/local/bin/，也可以不用进，因为前面的那个目录在环境变量中。</p>
<p>对于用redis-server启动哨兵的方式如下：</p>
<p>核心日志输出：</p>
<h3 id="434-测试">4.3.4 测试</h3>
<p>（1）先关闭6380节点（kill掉）。发现，确实重新指定了一个主节点</p>
<p>（2）再次上线6380节点。发现，6380节点成为了新的主节点的从节点。</p>
<h3 id="435-结论">4.3.5 结论</h3>
<p>　　Sentinel哨兵模式，确实能实现自动故障切换。提供稳定的服务。</p>
<h3 id="436-注意事项">4.3.6 注意事项</h3>
<p>如果哨兵和redis节点不在同一台服务器上，注意IP绑定的问题。</p>
<p>（1）主从模型，所有的节点，使用ip绑定</p>
<p>（2）所有的哨兵，也都使用ip去绑定主机</p>
<p>（3）所有的哨兵，都是通过主节点的ip，去监控主从模型</p>
<h1 id="五-redis-cluster集群">五、 Redis-cluster集群</h1>
<h2 id="51-哨兵模式的缺陷">5.1 哨兵模式的缺陷</h2>
<p>在哨兵模式中，仍然只有一个Master节点。当并发写请求较大时，哨兵模式并不能缓解写压力。</p>
<p>我们知道只有主节点才具有写能力，那如果在一个集群中，能够配置多个主节点，是不是就可以缓解写压力了呢？</p>
<p>答：是的。这个就是redis-cluster集群模式。</p>
<h2 id="52-redis-cluster集群概念">5.2 Redis-cluster集群概念</h2>
<p>（1）由多个Redis服务器组成的分布式网络服务集群；</p>
<p>（2）集群之中有多个Master主节点，每一个主节点都可读可写；</p>
<p>（3）节点之间会互相通信，两两相连；</p>
<p>（4）Redis集群无中心节点。</p>
<h2 id="53-集群节点复制">5.3 集群节点复制</h2>
<p>在Redis-Cluster集群中，可以给每一个主节点添加从节点，主节点和从节点直接遵循主从模型的特性。</p>
<p>当用户需要处理更多读请求的时候，添加从节点可以扩展系统的读性能。</p>
<h2 id="54-故障转移">5.4 故障转移</h2>
<p>Redis集群的主节点内置了类似Redis Sentinel的节点故障检测和自动故障转移功能，当集群中的某个主节点下线时，集群中的其他在线主节点会注意到这一点，并对已下线的主节点进行故障转移。</p>
<p>集群进行故障转移的方法和Redis Sentinel进行故障转移的方法基本一样，不同的是，在集群里面，故障转移是由集群中其他在线的主节点负责进行的，所以集群不必另外使用Redis Sentinel。</p>
<h2 id="55-集群分片策略">5.5 集群分片策略</h2>
<p>Redis-cluster分片策略，是用来解决key存储位置的。</p>
<p>集群将整个数据库分为16384个槽位slot，所有key-value数据都存储在这些slot中的某一个上。一个slot槽位可以存放多个数据，key的槽位计算公式为：slot_number=crc16(key)%16384，其中crc16为16位的循环冗余校验和函数。</p>
<p>集群中的每个主节点都可以处理0个至16383个槽，当16384个槽都有某个节点在负责处理时，集群进入上线状态，并开始处理客户端发送的数据命令请求。</p>
<h2 id="56-集群redirect转向">5.6 集群redirect转向</h2>
<p>由于Redis集群无中心节点，请求会随机发给任意主节点；</p>
<p>主节点只会处理自己负责槽位的命令请求，其它槽位的命令请求，该主节点会返回客户端一个转向错误；</p>
<p>客户端根据错误中包含的地址和端口重新向正确的负责的主节点发起命令请求。</p>
<h2 id="57-集群搭建">5.7 集群搭建</h2>
<h3 id="571-准备工作">5.7.1 准备工作</h3>
<p>redis5.0版本之后可以直接使用<code>redis-cli</code>命令创建集群，不使用<code>redis-trib.rb</code>命令了。</p>
<h3 id="572-集群规划">5.7.2 集群规划</h3>
<p>（1）Redis集群最少需要6个节点，3主3从，可以分布在一台或者多台主机上。</p>
<p>真集群：6台主机，每台主机的redis服务使用的IP不同，端口号随意，一样不一样都可以</p>
<p>假集群，一台主机，redis服务使用的IP相同，端口号不同</p>
<p>本例子是在一台主机上创建假集群，不同的端口表示不同的redis节点，如下：</p>
<p>主节点：127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003</p>
<p>从节点：127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006</p>
<p>后期新加的主节点：127.0.0.1:7007</p>
<p>后期新家的从节点：127.0.0.1:7008</p>
<p>（2）在/usr/local/src/redis-5.0.4/下创建cluster目录，其下创建7001、7002…7006目录，如下：</p>
<p>（3）将redis解压路径下的配置文件redis.conf，依次拷贝到每个700X目录内，并修改每个700X目录下的redis.conf配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># cd /usr/local/src/redis-5.0.4/cluster</span>
<span class="c1"># mkdir {7001,7002,7003,7004,7005,7006}</span>
<span class="c1"># mkdir -p /var/log/redis/{7001,7002,7003,7004,7005,7006}</span>

<span class="c1"># redis.conf文件示例</span>
<span class="nb">bind</span> 127.0.0.1
port <span class="m">7001</span>
daemonize yes
pidfile /var/run/redis_7001.pid
dir <span class="s2">&#34;./&#34;</span> <span class="c1"># node.conf文件保存路径</span>
logfile <span class="s2">&#34;/var/log/redis/7001/redis.log&#34;</span>
appendonly yes
appendfsync always
cluster-enabled yes
cluster-config-file nodes-7001.conf <span class="c1"># 该文件中包含集群信息</span>

<span class="c1"># 其他配置文件类似，把端口号修改一下就行了</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="573-启动每个节点redis服务">5.7.3 启动每个节点redis服务</h3>
<p>批量启动脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># vim s/usr/local/src/redis-5.0.4/cluster/ctart_cluster.sh</span>
<span class="c1">#!/bin/bash</span>

<span class="nb">cd</span> ./7001 <span class="o">&amp;&amp;</span> /usr/local/src/redis-5.0.4/src/redis-server ./redis.conf
<span class="nb">cd</span> ../7002 <span class="o">&amp;&amp;</span> /usr/local/src/redis-5.0.4/src/redis-server ./redis.conf
<span class="nb">cd</span> ../7003 <span class="o">&amp;&amp;</span> /usr/local/src/redis-5.0.4/src/redis-server ./redis.conf
<span class="nb">cd</span> ../7004 <span class="o">&amp;&amp;</span> /usr/local/src/redis-5.0.4/src/redis-server ./redis.conf
<span class="nb">cd</span> ../7005 <span class="o">&amp;&amp;</span> /usr/local/src/redis-5.0.4/src/redis-server ./redis.conf
<span class="nb">cd</span> ../7006 <span class="o">&amp;&amp;</span> /usr/local/src/redis-5.0.4/src/redis-server ./redis.conf
<span class="nb">cd</span> ..

<span class="c1"># chmod +x start_cluster.sh</span>

</code></pre></td></tr></table>
</div>
</div><p>注意：一定要进入700X目录中启动，因为它会自动在当前目录中创建cluster-config，即nodes.conf。因为你在哪个目录下执行这个命令，则node.conf文件就会在该目录下创建。</p>
<p>但是若是在配置文件中配置<code>dir</code>为其他目录，则该文件会创建在<code>dir</code>指定目录下</p>
<p>或者把redis-server程序文件依次拷贝到每个700x目录下，然后使用不同目录的redis-server程序文件启动</p>
<p>关闭脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># vim /usr/local/src/redis-5.0.4/cluster/shutdown_cluster.sh</span>
<span class="c1">#!/bin/bash</span>

pgrep redis-server <span class="p">|</span> xargs -exec <span class="nb">kill</span> -9

<span class="c1"># chmod +x shutdown_cluster.sh</span>

</code></pre></td></tr></table>
</div>
</div><p>执行启动脚本批量启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># ./start_cluster.sh</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="574-执行创建集群命令">5.7.4 执行创建集群命令</h3>
<p>进入到redis源码存放目录/usr/local/src/redis-5.0.4/src下，把redis-cli文件拷贝到/usr/local/bin/目录下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span>  /usr/local/src/redis-5.0.4/cluster
/usr/local/src/redis-5.0.4/src/redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006 --cluster-replicas <span class="m">1</span>

<span class="c1"># --cluster-replicas 1  表示主从配置比，1表示的是1:1，前三个是主，后三个是从</span>
<span class="c1"># 若配置文件中设置的密码，则还需要加上-a passwod</span>

......
Can I <span class="nb">set</span> the above configuration? <span class="o">(</span><span class="nb">type</span> <span class="s1">&#39;yes&#39;</span> to accept<span class="o">)</span>: yes
......
<span class="o">[</span>OK<span class="o">]</span> All nodes agree about slots configuration.
&gt;&gt;&gt; Check <span class="k">for</span> open slots...
&gt;&gt;&gt; Check slots coverage...
<span class="o">[</span>OK<span class="o">]</span> All <span class="m">16384</span> slots covered.

</code></pre></td></tr></table>
</div>
</div><h3 id="575-查询集群信息">5.7.5 查询集群信息</h3>
<p>注意：查询集群信息需要加上<code>-c</code>参数</p>
<p>或者直接执行命令查询，如下面所示；或者登陆到其中一个集群节点，使用命令<code>cluster nodes</code>进行查询</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># /usr/local/src/redis-5.0.4/src/redis-cli -c -h 127.0.0.1 -p 7001 cluster nodes</span>
7d388cc31df969d3e1715ce9644318bfd48317b1 127.0.0.1:7004@17004 slave 59b6597448b668a355d85dcc7a0623bc36263e5f <span class="m">0</span> <span class="m">1564918712465</span> <span class="m">4</span> connected
bbe8b7035bfd31c47bec7d612acc112cd2869368 127.0.0.1:7003@17003 master - <span class="m">0</span> <span class="m">1564918714483</span> <span class="m">3</span> connected 10923-16383
456921ae96af71d8183101f798cf5ceda4b0381e 127.0.0.1:7005@17005 slave bbe8b7035bfd31c47bec7d612acc112cd2869368 <span class="m">0</span> <span class="m">1564918713000</span> <span class="m">5</span> connected
5612ffbb0407dbda50828b505a16b39ede51168b 127.0.0.1:7006@17006 slave 4dad696ede24995a57c5fd790faa95c72c187a22 <span class="m">0</span> <span class="m">1564918713474</span> <span class="m">6</span> connected
4dad696ede24995a57c5fd790faa95c72c187a22 127.0.0.1:7001@17001 myself,master - <span class="m">0</span> <span class="m">1564918713000</span> <span class="m">1</span> connected 0-5460
59b6597448b668a355d85dcc7a0623bc36263e5f 127.0.0.1:7002@17002 master - <span class="m">0</span> <span class="m">1564918712000</span> <span class="m">2</span> connected 5461-10922

</code></pre></td></tr></table>
</div>
</div><p>参数说明：</p>
<ul>
<li>-c：表示以集群方式连接惹redis</li>
<li>-h：指定IP地址</li>
<li>-p：指定端口</li>
<li>cluster nodes：查询集群节点信息</li>
<li>cluster info：查询集群状态信息</li>
</ul>
<p>其他查询方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># /usr/local/src/redis-5.0.4/src/redis-cli --cluster check 127.0.0.1:7001</span>
127.0.0.1:7001 <span class="o">(</span>4dad696e...<span class="o">)</span> -&gt; <span class="m">0</span> keys <span class="p">|</span> <span class="m">5461</span> slots <span class="p">|</span> <span class="m">1</span> slaves.
127.0.0.1:7003 <span class="o">(</span>bbe8b703...<span class="o">)</span> -&gt; <span class="m">0</span> keys <span class="p">|</span> <span class="m">5461</span> slots <span class="p">|</span> <span class="m">1</span> slaves.
127.0.0.1:7002 <span class="o">(</span>59b65974...<span class="o">)</span> -&gt; <span class="m">0</span> keys <span class="p">|</span> <span class="m">5462</span> slots <span class="p">|</span> <span class="m">1</span> slaves.
<span class="o">[</span>OK<span class="o">]</span> <span class="m">0</span> keys in <span class="m">3</span> masters.
0.00 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check <span class="o">(</span>using node 127.0.0.1:7001<span class="o">)</span>
M: 4dad696ede24995a57c5fd790faa95c72c187a22 127.0.0.1:7001
   slots:<span class="o">[</span>0-5460<span class="o">]</span> <span class="o">(</span><span class="m">5461</span> slots<span class="o">)</span> master
   <span class="m">1</span> additional replica<span class="o">(</span>s<span class="o">)</span>
S: 7d388cc31df969d3e1715ce9644318bfd48317b1 127.0.0.1:7004
   slots: <span class="o">(</span><span class="m">0</span> slots<span class="o">)</span> slave
   replicates 59b6597448b668a355d85dcc7a0623bc36263e5f
M: bbe8b7035bfd31c47bec7d612acc112cd2869368 127.0.0.1:7003
   slots:<span class="o">[</span>10923-16383<span class="o">]</span> <span class="o">(</span><span class="m">5461</span> slots<span class="o">)</span> master
   <span class="m">1</span> additional replica<span class="o">(</span>s<span class="o">)</span>
S: 456921ae96af71d8183101f798cf5ceda4b0381e 127.0.0.1:7005
   slots: <span class="o">(</span><span class="m">0</span> slots<span class="o">)</span> slave
   replicates bbe8b7035bfd31c47bec7d612acc112cd2869368
S: 5612ffbb0407dbda50828b505a16b39ede51168b 127.0.0.1:7006
   slots: <span class="o">(</span><span class="m">0</span> slots<span class="o">)</span> slave
   replicates 4dad696ede24995a57c5fd790faa95c72c187a22
M: 59b6597448b668a355d85dcc7a0623bc36263e5f 127.0.0.1:7002
   slots:<span class="o">[</span>5461-10922<span class="o">]</span> <span class="o">(</span><span class="m">5462</span> slots<span class="o">)</span> master
   <span class="m">1</span> additional replica<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>OK<span class="o">]</span> All nodes agree about slots configuration.
&gt;&gt;&gt; Check <span class="k">for</span> open slots...
&gt;&gt;&gt; Check slots coverage...
<span class="o">[</span>OK<span class="o">]</span> All <span class="m">16384</span> slots covered.

<span class="c1"># /usr/local/src/redis-5.0.4/src/redis-cli --cluster info 127.0.0.1:7001</span>
127.0.0.1:7001 <span class="o">(</span>4dad696e...<span class="o">)</span> -&gt; <span class="m">0</span> keys <span class="p">|</span> <span class="m">5461</span> slots <span class="p">|</span> <span class="m">1</span> slaves.
127.0.0.1:7003 <span class="o">(</span>bbe8b703...<span class="o">)</span> -&gt; <span class="m">0</span> keys <span class="p">|</span> <span class="m">5461</span> slots <span class="p">|</span> <span class="m">1</span> slaves.
127.0.0.1:7002 <span class="o">(</span>59b65974...<span class="o">)</span> -&gt; <span class="m">0</span> keys <span class="p">|</span> <span class="m">5462</span> slots <span class="p">|</span> <span class="m">1</span> slaves.
<span class="o">[</span>OK<span class="o">]</span> <span class="m">0</span> keys in <span class="m">3</span> masters.
0.00 keys per slot on average.

</code></pre></td></tr></table>
</div>
</div><h3 id="576-redis-cluster集群重新启动">5.7.6 redis cluster集群重新启动</h3>
<p>因为集群已经创建过了，若是关机等原因关闭了redis服务，则只需要执行批量启动脚本即可，就会自动开启集群，因为有node.conf文件的存在</p>
<h3 id="577-redis-cli集群命令帮助">5.7.7 redis-cli集群命令帮助</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># /usr/local/src/redis-5.0.4/src/redis-cli --cluster help</span>
Cluster Manager Commands:
  create         host1:port1 ... hostN:portN
                 --cluster-replicas &lt;arg&gt;
  check          host:port
                 --cluster-search-multiple-owners
  info           host:port
  fix            host:port
                 --cluster-search-multiple-owners
  reshard        host:port
                 --cluster-from &lt;arg&gt;
                 --cluster-to &lt;arg&gt;
                 --cluster-slots &lt;arg&gt;
                 --cluster-yes
                 --cluster-timeout &lt;arg&gt;
                 --cluster-pipeline &lt;arg&gt;
                 --cluster-replace
  rebalance      host:port
                 --cluster-weight &lt;<span class="nv">node1</span><span class="o">=</span>w1...nodeN<span class="o">=</span>wN&gt;
                 --cluster-use-empty-masters
                 --cluster-timeout &lt;arg&gt;
                 --cluster-simulate
                 --cluster-pipeline &lt;arg&gt;
                 --cluster-threshold &lt;arg&gt;
                 --cluster-replace
  add-node       new_host:new_port existing_host:existing_port
                 --cluster-slave
                 --cluster-master-id &lt;arg&gt;
  del-node       host:port node_id
  call           host:port <span class="nb">command</span> arg arg .. arg
  set-timeout    host:port milliseconds
  import         host:port
                 --cluster-from &lt;arg&gt;
                 --cluster-copy
                 --cluster-replace
  <span class="nb">help</span>

For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.

</code></pre></td></tr></table>
</div>
</div><h2 id="58-集群管理">5.8 集群管理</h2>
<h3 id="581-添加新主节点">5.8.1 添加新主节点</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">redis-cli --cluster add-node new_host:new_port existing_host:existing_port --cluster-master-id node_id

</code></pre></td></tr></table>
</div>
</div><h3 id="582-hash槽重新分配">5.8.2 hash槽重新分配</h3>
<p>添加完新节点后，需要对新添加的主节点进行hash槽重新分配，这样该主节点才能存储数据，redis共有16384个槽。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">redis-cli --cluster reshard host:port --cluster-from node_id --cluster-to node_id --cluster-slots &lt;args&gt; --cluster-yes

</code></pre></td></tr></table>
</div>
</div><h3 id="582-添加新从节点">5.8.2 添加新从节点</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">redis-cli --cluster add-node new_host:new_port existing_host:existing_port --cluster-slave --cluster-master-id node_id

</code></pre></td></tr></table>
</div>
</div><h3 id="583-删除节点">5.8.3 删除节点</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">redis-cli --cluster  del-node host:port node_id

</code></pre></td></tr></table>
</div>
</div><h3 id="584-集群常用命令">5.8.4 集群常用命令</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 创建集群</span>
redis-cli --cluster create host1:port1 ... hostN:portN --cluster-replicas &lt;arg&gt;
<span class="c1"># 例子</span>
redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006 --cluster-replicas <span class="m">1</span>
<span class="c1"># 例子说明</span>
host1:port1 ... hostN:portN表示的是要添加的集群的节点IP和端口，
--cluster-replicas &lt;arg&gt;表示的是主从节点比例，参数1表示前三个是主节点，后三个是从节点
也就是说7001,7002,7003端口对应的节点是主节点，7004,7005,7006对应的节点是从节点

<span class="c1"># 查询集群节点信息</span>
redis-cli -c -p <span class="m">7001</span> cluster nodes
7d388cc31df969d3e1715ce9644318bfd48317b1 127.0.0.1:7004@17004 slave 59b6597448b668a355d85dcc7a0623bc36263e5f <span class="m">0</span> <span class="m">1564923261350</span> <span class="m">4</span> connected
bbe8b7035bfd31c47bec7d612acc112cd2869368 127.0.0.1:7003@17003 master - <span class="m">0</span> <span class="m">1564923263366</span> <span class="m">3</span> connected 10923-16383
456921ae96af71d8183101f798cf5ceda4b0381e 127.0.0.1:7005@17005 slave bbe8b7035bfd31c47bec7d612acc112cd2869368 <span class="m">0</span> <span class="m">1564923262000</span> <span class="m">5</span> connected
5612ffbb0407dbda50828b505a16b39ede51168b 127.0.0.1:7006@17006 slave 4dad696ede24995a57c5fd790faa95c72c187a22 <span class="m">0</span> <span class="m">1564923260000</span> <span class="m">6</span> connected
4dad696ede24995a57c5fd790faa95c72c187a22 127.0.0.1:7001@17001 myself,master - <span class="m">0</span> <span class="m">1564923263000</span> <span class="m">1</span> connected 0-5460
59b6597448b668a355d85dcc7a0623bc36263e5f 127.0.0.1:7002@17002 master - <span class="m">0</span> <span class="m">1564923262358</span> <span class="m">2</span> connected 5461-10922

<span class="c1"># 说明：以下的操作均是以上面这个为参数示例</span>

<span class="c1"># 给集群添加一个新主节点</span>
redis-cli --cluster add-node new_host:new_port existing_host:existing_port --cluster-master-id node_id
<span class="c1"># 例子</span>
redis-cli --cluster add-node 127.0.0.1:7007 127.0.0.1:7003 --cluster-master-id bbe8b7035bfd31c47bec7d612acc112cd2869368
<span class="c1"># 例子说明</span>
new_host:new_port为要新添加的主节点IP和端口，此处是127.0.0.1:7007
existing_host:existing_port表示的是已存在的最后一个主节点的IP和端口，这个可以从上述的节点信息中查看到，根据slots槽数，7003端口对应的节点槽数是10923-16383，16383表示的是最后的槽数
--cluster-master-id表示的是最后一个主节点的节点id，表示的是新添加的主节点要在这个节点后面

<span class="c1"># 再次查看集群信息</span>
redis-cli -c -p <span class="m">7001</span> cluster nodes
7d388cc31df969d3e1715ce9644318bfd48317b1 127.0.0.1:7004@17004 slave 59b6597448b668a355d85dcc7a0623bc36263e5f <span class="m">0</span> <span class="m">1564923261350</span> <span class="m">4</span> connected
bbe8b7035bfd31c47bec7d612acc112cd2869368 127.0.0.1:7003@17003 master - <span class="m">0</span> <span class="m">1564923263366</span> <span class="m">3</span> connected 10923-16383
7020c8df9423686727783c60bd2f0e367634ba84 127.0.0.1:7007@17007 master - <span class="m">0</span> <span class="m">1564923260344</span> <span class="m">0</span> connected
456921ae96af71d8183101f798cf5ceda4b0381e 127.0.0.1:7005@17005 slave bbe8b7035bfd31c47bec7d612acc112cd2869368 <span class="m">0</span> <span class="m">1564923262000</span> <span class="m">5</span> connected
5612ffbb0407dbda50828b505a16b39ede51168b 127.0.0.1:7006@17006 slave 4dad696ede24995a57c5fd790faa95c72c187a22 <span class="m">0</span> <span class="m">1564923260000</span> <span class="m">6</span> connected
4dad696ede24995a57c5fd790faa95c72c187a22 127.0.0.1:7001@17001 myself,master - <span class="m">0</span> <span class="m">1564923263000</span> <span class="m">1</span> connected 0-5460
59b6597448b668a355d85dcc7a0623bc36263e5f 127.0.0.1:7002@17002 master - <span class="m">0</span> <span class="m">1564923262358</span> <span class="m">2</span> connected 5461-10922
<span class="c1"># 会发现7007端口对应的节点已经加入到集群中，是主节点，但是没有从节点，也没有分配槽数</span>

<span class="c1"># 给新添加的主节点分配slots槽数</span>
redis-cli --cluster reshard host:port --cluster-from node_id --cluster-to node_id --cluster-slots <span class="m">500</span> --cluster-yes
<span class="c1"># 例子</span>
redis-cli --cluster reshard 127.0.0.1:7007 --cluster-from 4dad696ede24995a57c5fd790faa95c72c187a22 --cluster-to 7020c8df9423686727783c60bd2f0e367634ba84 --cluster-slots <span class="m">500</span>
<span class="c1"># 例子说明</span>
host:port表示的是新添加的那个主节点IP和端口，此处表示的是127.0.0.1:7007
--cluster-from node_id表示的是集群第一个主节点的节点id，这个可以现有集群的slots槽数分配看出，此处表示的是7001端口对应的节点
--cluster-to node_id表示的是集群最后一个主节点的节点id,也就是新添加的那个主节点id,此处表示的是7007端口对应的节点
--cluster-slots 500表示的是给新主节点分配多少，此处500表示是分配从0-499个slots槽数，若不加上这个会让手动输入
--cluster-yes表示的是自动应答为yes,若不加上这个会让手动输入yes,表示同意此次分配

<span class="c1"># 再次查看集群信息</span>
/redis-cli -c -p <span class="m">7001</span> cluster nodes                                         7d388cc31df969d3e1715ce9644318bfd48317b1 127.0.0.1:7004@17004 slave 59b6597448b668a355d85dcc7a0623bc36263e5f <span class="m">0</span> <span class="m">1564924042000</span> <span class="m">4</span> connected
bbe8b7035bfd31c47bec7d612acc112cd2869368 127.0.0.1:7003@17003 master - <span class="m">0</span> <span class="m">1564924042157</span> <span class="m">3</span> connected 10923-16383
7020c8df9423686727783c60bd2f0e367634ba84 127.0.0.1:7007@17007 master - <span class="m">0</span> <span class="m">1564924040140</span> <span class="m">7</span> connected 0-499
456921ae96af71d8183101f798cf5ceda4b0381e 127.0.0.1:7005@17005 slave bbe8b7035bfd31c47bec7d612acc112cd2869368 <span class="m">0</span> <span class="m">1564924040000</span> <span class="m">5</span> connected
5612ffbb0407dbda50828b505a16b39ede51168b 127.0.0.1:7006@17006 slave 4dad696ede24995a57c5fd790faa95c72c187a22 <span class="m">0</span> <span class="m">1564924041149</span> <span class="m">6</span> connected
4dad696ede24995a57c5fd790faa95c72c187a22 127.0.0.1:7001@17001 myself,master - <span class="m">0</span> <span class="m">1564924040000</span> <span class="m">1</span> connected 500-5460
59b6597448b668a355d85dcc7a0623bc36263e5f 127.0.0.1:7002@17002 master - <span class="m">0</span> <span class="m">1564924043166</span> <span class="m">2</span> connected 5461-10922
<span class="c1"># 会发现7007端口对应的主节点已经有slots槽数了，并且是从0开始的</span>

<span class="c1"># 给集群中某个主节点再添加一个从节点</span>
redis-cli --cluster add-node new_host:new_port existing_host:existing_port --cluster-slave --cluster-master-id node_id
<span class="c1"># 例子</span>
redis-cli --cluster add-node 127.0.0.1:7007 127.0.0.1:7008 --cluster-slave --cluster-master-id 7020c8df9423686727783c60bd2f0e367634ba84
<span class="c1"># 例子说明</span>
new_host:new_port表示的是要添加的那个从节点的IP和端口，此处表示的是127.0.0.1:7008
existing_host:existing_port表示的是要给哪个主节点添加从节点，此处表示的是127.0.0.1:7007
--cluster-slave表示的是要添加从节点，否则则是添加主节点了
--cluster-master-id node_id表示要给哪个主节点添加从节点的该主节点节点id

<span class="c1"># 再次查看集群信息</span>
redis-cli -c -p <span class="m">7001</span> cluster nodes                                         7020c8df9423686727783c60bd2f0e367634ba84 127.0.0.1:7007@17007 master - <span class="m">0</span> <span class="m">1564924845000</span> <span class="m">7</span> connected 0-499
4dad696ede24995a57c5fd790faa95c72c187a22 127.0.0.1:7001@17001 myself,master - <span class="m">0</span> <span class="m">1564924843000</span> <span class="m">1</span> connected 500-5460
5612ffbb0407dbda50828b505a16b39ede51168b 127.0.0.1:7006@17006 slave 4dad696ede24995a57c5fd790faa95c72c187a22 <span class="m">0</span> <span class="m">1564924845214</span> <span class="m">6</span> connected
7d388cc31df969d3e1715ce9644318bfd48317b1 127.0.0.1:7004@17004 slave 59b6597448b668a355d85dcc7a0623bc36263e5f <span class="m">0</span> <span class="m">1564924843195</span> <span class="m">4</span> connected
bbe8b7035bfd31c47bec7d612acc112cd2869368 127.0.0.1:7003@17003 master - <span class="m">0</span> <span class="m">1564924844205</span> <span class="m">3</span> connected 10923-16383
456921ae96af71d8183101f798cf5ceda4b0381e 127.0.0.1:7005@17005 slave bbe8b7035bfd31c47bec7d612acc112cd2869368 <span class="m">0</span> <span class="m">1564924845000</span> <span class="m">5</span> connected
415db07121ba946b202bca98e15cbdffc60bc18a 127.0.0.1:7008@17008 slave 7020c8df9423686727783c60bd2f0e367634ba84 <span class="m">0</span> <span class="m">1564924846224</span> <span class="m">7</span> connected
c3e04f0e8710c25d59703374a224ee8bec776e43 :0@0 master,fail,noaddr - <span class="m">1564924804548</span> <span class="m">1564924802833</span> <span class="m">0</span> disconnected
59b6597448b668a355d85dcc7a0623bc36263e5f 127.0.0.1:7002@17002 master - <span class="m">0</span> <span class="m">1564924844000</span> <span class="m">2</span> connected 5461-10922
<span class="c1"># 会发现7008端口对应的节点已经是7007端口对应的从节点</span>

<span class="c1"># 从集群中删除一个从节点</span>
redis-cli --cluster  del-node host:port node_id
<span class="c1"># 例子</span>
redis-cli --cluster del-node 127.0.0.1:7008 415db07121ba946b202bca98e15cbdffc60bc18a
<span class="c1"># 例子说明</span>
host:port表示的是要删除的那个节点的IP和端口，此处是127.0.0.1:7008
node_id表示的是删除的那个节点的节点id

<span class="c1"># 其他命令有待补充</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="59-注意事项">5.9 注意事项</h2>
<h3 id="591-防火墙端口放行">5.9.1 防火墙端口放行</h3>
<p>若是允许Redis集群被外网用户访问，除了需要修改配置文件外，还需要修改防火墙，开放集群中reids节点的端口。</p>
<p>说明：如果要开放一个范围的端口，可以使用冒号来分割，即： 7001:7004，表示开放7001-7004之间所有的端口</p>
<h3 id="592-登录节点问题">5.9.2 登录节点问题</h3>
<p>若是登录的是集群中的节点，需要加上<code>-c</code>参数；否则不用加该参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 登录集群节点的命令</span>
redis-cli -c -h ip -p port -a password

<span class="c1"># 登录一般节点或者从节点的命令</span>
redis-cli -h ip -p port -a password

</code></pre></td></tr></table>
</div>
</div><h3 id="593-如何删除集群中无效的节点">5.9.3 如何删除集群中无效的节点</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">redis-cli -c -p <span class="m">7001</span> cluster nodes
7020c8df9423686727783c60bd2f0e367634ba84 127.0.0.1:7007@17007 master - <span class="m">0</span> <span class="m">1564925352648</span> <span class="m">7</span> connected 0-499
4dad696ede24995a57c5fd790faa95c72c187a22 127.0.0.1:7001@17001 myself,master - <span class="m">0</span> <span class="m">1564925349000</span> <span class="m">1</span> connected 500-5460
5612ffbb0407dbda50828b505a16b39ede51168b 127.0.0.1:7006@17006 slave 4dad696ede24995a57c5fd790faa95c72c187a22 <span class="m">0</span> <span class="m">1564925351000</span> <span class="m">6</span> connected
7d388cc31df969d3e1715ce9644318bfd48317b1 127.0.0.1:7004@17004 slave 59b6597448b668a355d85dcc7a0623bc36263e5f <span class="m">0</span> <span class="m">1564925354665</span> <span class="m">4</span> connected
bbe8b7035bfd31c47bec7d612acc112cd2869368 127.0.0.1:7003@17003 master - <span class="m">0</span> <span class="m">1564925353657</span> <span class="m">3</span> connected 10923-16383
456921ae96af71d8183101f798cf5ceda4b0381e 127.0.0.1:7005@17005 slave bbe8b7035bfd31c47bec7d612acc112cd2869368 <span class="m">0</span> <span class="m">1564925349000</span> <span class="m">5</span> connected
c3e04f0e8710c25d59703374a224ee8bec776e43 :0@0 master,fail,noaddr - <span class="m">1564924804548</span> <span class="m">1564924802833</span> <span class="m">0</span> disconnected
59b6597448b668a355d85dcc7a0623bc36263e5f 127.0.0.1:7002@17002 master - <span class="m">0</span> <span class="m">1564925352000</span> <span class="m">2</span> connected 5461-10922

<span class="c1"># 如上集群中有一个无效的节点信息，要如何删除，这个还不知道咋操作。</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">gzxb0712</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-06-05 21:09
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/gzxb0712/blog/blob/master/LICENSE">MIT</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/wechat.png">
        <span>微信佛系打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/alipay.jpg">
        <span>支付宝佛系打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/Redis/">Redis</a>
          <a href="/tags/database/">database</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/database/tidb_install_ops/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">TiDB 4.0 安装</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/database/mysql8_install_ops/">
            <span class="next-text nav-default">MySQL 8.0 部署及使用</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://www.cnblogs.com/gzxb0712" class="iconfont icon-cnblogs" title="cnblogs"></a>
      <a href="mailto:gzxb0712@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/gzxb0712" class="iconfont icon-github" title="github"></a>
      <a href="https://juejin.im/user/59aeb829f265da249960595a" class="iconfont icon-juejin" title="juejin"></a>
      <a href="https://www.v2ex.com/member/gzxb0712" class="iconfont icon-v2ex" title="v2ex"></a>
  <a href="https://js.xiebiao.top/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2019 - 
    2022
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">gzxb0712</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-CN".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>



<script type="text/javascript" src="/js/main.min.2517c0eb67172a0bae917de4af59b10ca2531411a009d4c0b82f5685259e5771.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138883536-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>

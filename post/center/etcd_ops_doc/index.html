<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>etcd 入门指引 - Bill World</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="gzxb0712" /><meta name="description" content="背景：近期 k8s 应用中 etcd 的功能存在一些困惑，对其进行来单独的学习，能更深入理解 k8s 中的的一些特性。 一、概述 1.1 etcd 简介 etcd 是 CoreOS 团队于 2013 年 6月发起的开源项" /><meta name="keywords" content="Mac, Github, Vue, React, Front End" />






<meta name="generator" content="Hugo 0.76.3 with theme even" />


<link rel="canonical" href="https://xiebiao.top/post/center/etcd_ops_doc/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.651e6917abb0239242daa570c2bec9867267bbcd83646da5a850afe573347b44.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/reset-even.css">


<meta property="og:title" content="etcd 入门指引" />
<meta property="og:description" content="背景：近期 k8s 应用中 etcd 的功能存在一些困惑，对其进行来单独的学习，能更深入理解 k8s 中的的一些特性。 一、概述 1.1 etcd 简介 etcd 是 CoreOS 团队于 2013 年 6月发起的开源项" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiebiao.top/post/center/etcd_ops_doc/" />
<meta property="article:published_time" content="2020-03-28T22:03:30+00:00" />
<meta property="article:modified_time" content="2020-03-28T22:03:30+00:00" />
<meta itemprop="name" content="etcd 入门指引">
<meta itemprop="description" content="背景：近期 k8s 应用中 etcd 的功能存在一些困惑，对其进行来单独的学习，能更深入理解 k8s 中的的一些特性。 一、概述 1.1 etcd 简介 etcd 是 CoreOS 团队于 2013 年 6月发起的开源项">
<meta itemprop="datePublished" content="2020-03-28T22:03:30+00:00" />
<meta itemprop="dateModified" content="2020-03-28T22:03:30+00:00" />
<meta itemprop="wordCount" content="5736">



<meta itemprop="keywords" content="etcd,center," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="etcd 入门指引"/>
<meta name="twitter:description" content="背景：近期 k8s 应用中 etcd 的功能存在一些困惑，对其进行来单独的学习，能更深入理解 k8s 中的的一些特性。 一、概述 1.1 etcd 简介 etcd 是 CoreOS 团队于 2013 年 6月发起的开源项"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Bill World</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Bill World</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">etcd 入门指引</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-03-28 22:03 </span>
        <div class="post-category">
            <a href="/categories/center/"> center </a>
            </div>
          <span class="more-meta">  </span>
          <span class="more-meta">  </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> %!(EXTRA string=<span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span>) </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title"></h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一概述">一、概述</a>
      <ul>
        <li><a href="#11-etcd-简介">1.1 etcd 简介</a></li>
        <li><a href="#12-发展历史">1.2 发展历史</a></li>
        <li><a href="#13-etcd-的特点">1.3 etcd 的特点</a></li>
        <li><a href="#14-概念术语">1.4 概念术语</a></li>
        <li><a href="#15-数据读写顺序">1.5 数据读写顺序</a></li>
        <li><a href="#16-leader-选举">1.6 leader 选举</a></li>
        <li><a href="#17-判断数据是否写入">1.7 判断数据是否写入</a></li>
      </ul>
    </li>
    <li><a href="#二etcd-架构及解析">二、etcd 架构及解析</a>
      <ul>
        <li><a href="#21-架构图">2.1 架构图</a></li>
        <li><a href="#22-架构解析">2.2 架构解析</a></li>
      </ul>
    </li>
    <li><a href="#三应用场景">三、应用场景</a>
      <ul>
        <li><a href="#31-服务注册与发现">3.1 服务注册与发现</a></li>
        <li><a href="#32-消息发布与订阅">3.2 消息发布与订阅</a></li>
      </ul>
    </li>
    <li><a href="#33-负载均衡">3.3 负载均衡</a>
      <ul>
        <li><a href="#34-分部署通知与协调">3.4 分部署通知与协调</a></li>
        <li><a href="#35-分布式锁">3.5 分布式锁</a></li>
        <li><a href="#36-分布式队列">3.6 分布式队列</a></li>
        <li><a href="#37-集群与监控与-leader-选举">3.7 集群与监控与 Leader 选举</a></li>
      </ul>
    </li>
    <li><a href="#四安装部署">四、安装部署</a>
      <ul>
        <li><a href="#41-单机部署">4.1 单机部署</a></li>
        <li><a href="#42-集群部署">4.2 集群部署</a></li>
      </ul>
    </li>
    <li><a href="#五简单使用">五、简单使用</a>
      <ul>
        <li><a href="#51-增加">5.1 增加</a></li>
        <li><a href="#52-删除">5.2 删除</a></li>
        <li><a href="#53-更新">5.3 更新</a></li>
        <li><a href="#54-查询">5.4 查询</a></li>
        <li><a href="#55-watch">5.5 watch</a></li>
        <li><a href="#56-备份">5.6 备份</a></li>
        <li><a href="#57-member">5.7 member</a></li>
        <li><a href="#示例">示例</a></li>
      </ul>
    </li>
    <li><a href="#六总结">六、总结</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p><strong>背景</strong>：近期 k8s 应用中 etcd 的功能存在一些困惑，对其进行来单独的学习，能更深入理解 k8s 中的的一些特性。</p>
<h2 id="一概述">一、概述</h2>
<h3 id="11-etcd-简介">1.1 etcd 简介</h3>
<p>etcd 是 CoreOS 团队于 2013 年 6月发起的开源项目，它的目标是构建一个高可用的分布式键值(key-value)数据库。etcd 内部采用<code>raft</code> 协议作为一致性算法，etcd 基于 Go 语言实现。</p>
<h3 id="12-发展历史">1.2 发展历史</h3>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-9.png" alt=""></p>
<h3 id="13-etcd-的特点">1.3 etcd 的特点</h3>
<ul>
<li>
<p><strong>简单</strong>：安装配置简单，而且提供了HTTP API进行交互，使用也很简单</p>
</li>
<li>
<p><strong>安全</strong>：支持SSL证书验证</p>
</li>
<li>
<p><strong>快速</strong>：根据官方提供的benchmark数据，单实例支持每秒2k+读操作</p>
</li>
<li>
<p><strong>可靠</strong>：采用raft算法，实现分布式系统数据的可用性和一致性</p>
</li>
</ul>
<h3 id="14-概念术语">1.4 概念术语</h3>
<ul>
<li>
<p><strong>Raft</strong>：etcd所采用的保证分布式系统强一致性的算法。</p>
</li>
<li>
<p><strong>Node</strong>：一个Raft状态机实例。</p>
</li>
<li>
<p><strong>Member</strong>：一个etcd实例。它管理着一个Node，并且可以为客户端请求提供服务。</p>
</li>
<li>
<p><strong>Cluster</strong>：由多个Member构成可以协同工作的etcd集群。</p>
</li>
<li>
<p><strong>Peer</strong>：对同一个etcd集群中另外一个Member的称呼。</p>
</li>
<li>
<p><strong>Client</strong>：向etcd集群发送HTTP请求的客户端。</p>
</li>
<li>
<p><strong>WAL</strong>：预写式日志，etcd用于持久化存储的日志格式。</p>
</li>
<li>
<p><strong>snapshot</strong>：etcd防止WAL文件过多而设置的快照，存储etcd数据状态。</p>
</li>
<li>
<p><strong>Proxy</strong>：etcd的一种模式，为etcd集群提供反向代理服务。</p>
</li>
<li>
<p><strong>Leader</strong>：Raft算法中通过竞选而产生的处理所有数据提交的节点。</p>
</li>
<li>
<p><strong>Follower</strong>：竞选失败的节点作为Raft中的从属节点，为算法提供强一致性保证。</p>
</li>
<li>
<p><strong>Candidate</strong>：当Follower超过一定时间接收不到Leader的心跳时转变为Candidate开始竞选。</p>
</li>
<li>
<p><strong>Term</strong>：某个节点成为Leader到下一次竞选时间，称为一个Term。</p>
</li>
<li>
<p><strong>Index</strong>：数据项编号。Raft中通过Term和Index来定位数据。</p>
</li>
</ul>
<h3 id="15-数据读写顺序">1.5 数据读写顺序</h3>
<p>为了保证数据的强一致性，etcd 集群中所有的数据流向都是一个方向，从 Leader （主节点）流向 Follower，也就是所有 Follower 的数据必须与 Leader 保持一致，如果不一致会被覆盖。</p>
<p>用户对于 etcd 集群所有节点进行读写</p>
<ul>
<li>
<p><strong>读取</strong>：由于集群所有节点数据是强一致性的，读取可以从集群中随便哪个节点进行读取数据</p>
</li>
<li>
<p><strong>写入</strong>：etcd 集群有 leader，如果写入往 leader 写入，可以直接写入，然后然后Leader节点会把写入分发给所有 Follower，如果往 follower 写入，然后Leader节点会把写入分发给所有 Follower</p>
</li>
</ul>
<h3 id="16-leader-选举">1.6 leader 选举</h3>
<p>假设三个节点的集群，三个节点上均运行 Timer（每个 Timer 持续时间是随机的），Raft算法使用随机 Timer 来初始化 Leader 选举流程，第一个节点率先完成了 Timer，随后它就会向其他两个节点发送成为 Leader 的请求，其他节点接收到请求后会以投票回应然后第一个节点被选举为 Leader。</p>
<p>成为 Leader 后，该节点会以固定时间间隔向其他节点发送通知，确保自己仍是Leader。有些情况下当 Follower 们收不到 Leader 的通知后，比如说 Leader 节点宕机或者失去了连接，其他节点会重复之前选举过程选举出新的 Leader。</p>
<h3 id="17-判断数据是否写入">1.7 判断数据是否写入</h3>
<p>etcd 认为写入请求被 Leader 节点处理并分发给了多数节点后，就是一个成功的写入。那么多少节点如何判定呢，假设总结点数是 N，那么多数节点 <code>Quorum=N/2+1</code> 。关于如何确定 etcd 集群应该有多少个节点的问题，上图的左侧的图表给出了集群中节点总数(Instances)对应的 Quorum 数量，用 Instances 减去 Quorom 就是集群中容错节点（允许出故障的节点）的数量。</p>
<p>所以在集群中推荐的最少节点数量是3个，因为1和2个节点的容错节点数都是0，一旦有一个节点宕掉整个集群就不能正常工作了。</p>
<h2 id="二etcd-架构及解析">二、etcd 架构及解析</h2>
<h3 id="21-架构图">2.1 架构图</h3>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-1.png" alt=""></p>
<h3 id="22-架构解析">2.2 架构解析</h3>
<p>从 etcd 的架构图中我们可以看到，etcd 主要分为四个部分。</p>
<ul>
<li>
<p>HTTP Server：用于处理用户发送的 API 请求以及其它 etcd 节点的同步与心跳信息请求。</p>
</li>
<li>
<p>Store：用于处理 etcd 支持的各类功能的事务，包括数据索引、节点状态变更、监控与反馈、事件处理与执行等等，是 etcd 对用户提供的大多数 API 功能的具体实现。</p>
</li>
<li>
<p>Raft：Raft 强一致性算法的具体实现，是 etcd 的核心。</p>
</li>
<li>
<p>WAL：Write Ahead Log（预写式日志），是 etcd 的数据存储方式。除了在内存中存有所有数据的状态以及节点的索引以外，etcd 就通过 WAL 进行持久化存储。WAL 中，所有的数据提交前都会事先记录日志。</p>
</li>
<li>
<p>Snapshot 是为了防止数据过多而进行的状态快照；</p>
</li>
<li>
<p>Entry 表示存储的具体日志内容。</p>
</li>
</ul>
<p>通常，一个用户的请求发送过来，会经由 HTTP Server 转发给 Store 进行具体的事务处理，如果涉及到节点的修改，则交给 Raft 模块进行状态的变更、日志的记录，然后再同步给别的 etcd 节点以确认数据提交，最后进行数据的提交，再次同步。</p>
<h2 id="三应用场景">三、应用场景</h2>
<h3 id="31-服务注册与发现">3.1 服务注册与发现</h3>
<p>etcd 可以用于服务的注册与发现</p>
<ul>
<li>前后端业务注册发现</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-2.png" alt=""></p>
<p>中间价已经后端服务在 etcd 中注册，前端和中间价可以很轻松的从 etcd 中发现相关服务器然后服务器之间根据调用关系相关绑定调用</p>
<ul>
<li>多组后端服务器注册发现</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-3.png" alt="">
后端多个无状态相同副本的 app 可以同事注册到 etcd 中，前端可以通过 haproxy 从etcd 中获取到后端的 ip 和端口组，然后进行请求转发，可以用来故障转移屏蔽后端端口已经后端多组app实例。</p>
<h3 id="32-消息发布与订阅">3.2 消息发布与订阅</h3>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-4.png" alt=""></p>
<p>etcd 可以充当消息中间件，生产者可以往 etcd 中注册 topic 并发送消息，消费者从etcd 中订阅 topic，来获取生产者发送至 etcd 中的消息。</p>
<h2 id="33-负载均衡">3.3 负载均衡</h2>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-5.png" alt=""></p>
<p>后端多组相同的服务提供者可以经自己服务注册到 etcd 中，etcd 并且会与注册的服务进行监控检查，服务请求这首先从 etcd 中获取到可用的服务提供者真正的 ip:port，然后对此多组服务发送请求，etcd 在其中充当了负载均衡的功能</p>
<h3 id="34-分部署通知与协调">3.4 分部署通知与协调</h3>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-6.png" alt=""></p>
<ul>
<li>
<p>当 etcd watch 服务发现丢失，会通知服务检查</p>
</li>
<li>
<p>控制器向 etcd 发送启动服务，etcd通知服务进行相应操作</p>
</li>
<li>
<p>当服务完成 work 会讲状态更新至 etcd，etcd 对应会通知用户</p>
</li>
</ul>
<h3 id="35-分布式锁">3.5 分布式锁</h3>
<p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt=""></p>
<p>当有多个竞争者 node 节点，etcd 作为总控，在分布式集群中与一个节点成功分配 lock</p>
<h3 id="36-分布式队列">3.6 分布式队列</h3>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-7.png" alt=""></p>
<p>有对个 node，etcd 根据每个 node 来创建对应 node 的队列，根据不同的队列可以在etcd 中找到对应的 competitor</p>
<h3 id="37-集群与监控与-leader-选举">3.7 集群与监控与 Leader 选举</h3>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-8.png" alt=""></p>
<p>etcd 可以根据 raft 算法在多个 node 节点来选举出 leader。</p>
<h2 id="四安装部署">四、安装部署</h2>
<h3 id="41-单机部署">4.1 单机部署</h3>
<p>可以使用二进制或源码下载安装，但是危害需要自己写配置文件，如何要启动需要自己写服务启动文件，推荐使用 yum 安装方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">hostnamectl set-hostname etcd-1wget http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpmrpm -ivh epel-release-latest-7.noarch.rpm# yum 仓库中的etcd版本为3.3.11，如果需要最新版本的etcd可以进行二进制安装yum -y install etcdsystemctl enable etcd
</code></pre></td></tr></table>
</div>
</div><p>可以查看 yum 安装的 etcd 的有效配置文件，根据自己的需求来修改数据存储目录，已经监听端口 url/etcd 的名称等</p>
<ul>
<li>
<p>etcd 默认将数据存放到当前路径的 <code>default.etcd/</code>  目录下</p>
</li>
<li>
<p>在 <code>http://localhost:2380</code>  和集群中其他节点通信</p>
</li>
<li>
<p>在 <code>http://localhost:2379</code>  提供 HTTP API 服务，供客户端交互</p>
</li>
<li>
<p>该节点的名称默认为 <code>default</code></p>
</li>
<li>
<p>heartbeat 为 100ms，后面会说明这个配置的作用</p>
</li>
<li>
<p>election 为 1000ms，后面会说明这个配置的作用</p>
</li>
<li>
<p>snapshot count 为 10000，后面会说明这个配置的作用</p>
</li>
<li>
<p>集群和每个节点都会生成一个 uuid</p>
</li>
<li>
<p>启动的时候，会运行 raft，选举出 leader</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@VM_0_8_centos tmp]# grep -Ev &#34;^#|^$&#34; /etc/etcd/etcd.confETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;ETCD_LISTEN_CLIENT_URLS=&#34;http://localhost:2379&#34;ETCD_NAME=&#34;default&#34;ETCD_ADVERTISE_CLIENT_URLS=&#34;http://localhost:2379&#34;[root@VM_0_8_centos tmp]# systemctl status etcd
</code></pre></td></tr></table>
</div>
</div><h3 id="42-集群部署">4.2 集群部署</h3>
<p>集群部署最好部署奇数位，此能达到最好的集群容错</p>
<h4 id="421-主机信息">4.2.1 主机信息</h4>
<p><img src="https://cdn.jsdelivr.net/gh/gzxb0712/img/blog/etcd-10.png" alt=""></p>
<h4 id="422-host-配置">4.2.2 host 配置</h4>
<p>在此示例用三个节点来部署 etcd 集群，各节点修改 hosts</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">cat &gt;&gt; /etc/hosts &lt;&lt; EOF172.16.0.8 etcd-0-8172.16.0.14 etcd-0-14172.16.0.17 etcd-0-17EOF
</code></pre></td></tr></table>
</div>
</div><h4 id="423-etcd-安装">4.2.3 etcd 安装</h4>
<p>三个节点均安装 etcd</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">wget http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpmrpm -ivh epel-release-latest-7.noarch.rpmyum -y install etcdsystemctl enable etcdmkdir -p /data/app/etcd/chown etcd:etcd /data/app/etcd/
</code></pre></td></tr></table>
</div>
</div><h4 id="424-etcd-配置">4.2.4 etcd 配置</h4>
<ul>
<li>etcd默认配置文件(略)</li>
</ul>
<blockquote>
<p><strong>etcd-0-8配置：</strong></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@etcd-server ~]# hostnamectl set-hostname etcd-0-8[root@etcd-0-8 ~]# egrep &#34;^#|^$&#34; /etc/etcd/etcd.conf -vETCD_DATA_DIR=&#34;/data/app/etcd/&#34;ETCD_LISTEN_PEER_URLS=&#34;http://172.16.0.8:2380&#34;ETCD_LISTEN_CLIENT_URLS=&#34;http://127.0.0.1:2379,http://172.16.0.8:2379&#34;ETCD_NAME=&#34;etcd-0-8&#34;ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;http://172.16.0.8:2380&#34;ETCD_ADVERTISE_CLIENT_URLS=&#34;http://127.0.0.1:2379,http://172.16.0.8:2379&#34;ETCD_INITIAL_CLUSTER=&#34;etcd-0-8=http://172.16.0.8:2380,etcd-0-17=http://172.16.0.17:2380,etcd-0-14=http://172.16.0.14:2380&#34;ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-token&#34;ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>etcd-0-14配置：</strong></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@etcd-server ~]# hostnamectl set-hostname etcd-0-14[root@etcd-server ~]# mkdir -p /data/app/etcd/[root@etcd-0.14 ~]# egrep &#34;^#|^$&#34; /etc/etcd/etcd.conf -vETCD_DATA_DIR=&#34;/data/app/etcd/&#34;ETCD_LISTEN_PEER_URLS=&#34;http://172.16.0.14:2380&#34;ETCD_LISTEN_CLIENT_URLS=&#34;http://127.0.0.1:2379,http://172.16.0.14:2379&#34;ETCD_NAME=&#34;etcd-0-14&#34;ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;http://172.16.0.14:2380&#34;ETCD_ADVERTISE_CLIENT_URLS=&#34;http://127.0.0.1:2379,http://172.16.0.14:2379&#34;ETCD_INITIAL_CLUSTER=&#34;etcd-0-8=http://172.16.0.8:2380,etcd-0-17=http://172.16.0.17:2380,etcd-0-14=http://172.16.0.14:2380&#34;ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-token&#34;ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>etcd-0-7配置:</strong></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@etcd-server ~]# hostnamectl set-hostname etcd-0-17[root@etcd-server ~]# mkdir -p /data/app/etcd/[root@etcd-0-17 ~]# egrep &#34;^#|^$&#34; /etc/etcd/etcd.conf -vETCD_DATA_DIR=&#34;/data/app/etcd/&#34;ETCD_LISTEN_PEER_URLS=&#34;http://172.16.0.17:2380&#34;ETCD_LISTEN_CLIENT_URLS=&#34;http://127.0.0.1:2379,http://172.16.0.17:2379&#34;ETCD_NAME=&#34;etcd-0-17&#34;ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;http://172.16.0.17:2380&#34;ETCD_ADVERTISE_CLIENT_URLS=&#34;http://127.0.0.1:2379,http://172.16.0.17:2379&#34;ETCD_INITIAL_CLUSTER=&#34;etcd-0-8=http://172.16.0.8:2380,etcd-0-17=http://172.16.0.17:2380,etcd-0-14=http://172.16.0.14:2380&#34;ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-token&#34;ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</code></pre></td></tr></table>
</div>
</div><p>配置完成后启动服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">systemctl start etcd
</code></pre></td></tr></table>
</div>
</div><h4 id="425-查看集群状态">4.2.5 查看集群状态</h4>
<ul>
<li>查看 etcd 状态</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@etcd-0-8 default.etcd]# systemctl status etcd● etcd.service - Etcd Server   Loaded: loaded (/usr/lib/systemd/system/etcd.service; enabled; vendor preset: disabled)   Active: active (running) since 二 2019-12-03 15:55:28 CST; 8s ago Main PID: 24510 (etcd)   CGroup: /system.slice/etcd.service           └─24510 /usr/bin/etcd --name=etcd-0-8 --data-dir=/data/app/etcd/ --listen-client-urls=http://172.16.0.8:237912月 03 15:55:28 etcd-0-8 etcd[24510]: set the initial cluster version to 3.012月 03 15:55:28 etcd-0-8 etcd[24510]: enabled capabilities for version 3.012月 03 15:55:30 etcd-0-8 etcd[24510]: peer 56e0b6dad4c53d42 became active12月 03 15:55:30 etcd-0-8 etcd[24510]: established a TCP streaming connection with peer 56e0b6dad4c53d42 (stream Message reader)12月 03 15:55:30 etcd-0-8 etcd[24510]: established a TCP streaming connection with peer 56e0b6dad4c53d42 (stream Message writer)12月 03 15:55:30 etcd-0-8 etcd[24510]: established a TCP streaming connection with peer 56e0b6dad4c53d42 (stream MsgApp v2 reader)12月 03 15:55:30 etcd-0-8 etcd[24510]: established a TCP streaming connection with peer 56e0b6dad4c53d42 (stream MsgApp v2 writer)12月 03 15:55:32 etcd-0-8 etcd[24510]: updating the cluster version from 3.0 to 3.312月 03 15:55:32 etcd-0-8 etcd[24510]: updated the cluster version from 3.0 to 3.312月 03 15:55:32 etcd-0-8 etcd[24510]: enabled capabilities for version 3.3
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>查看端口监听(如果未在本地监听环回地址，那么在本地使用etcdctl不能正常连入进去)</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@etcd-0-8 default.etcd]# netstat -lntup |grep etcdtcp        0      0 172.16.0.8:2379         0.0.0.0:*               LISTEN      25167/etcdtcp        0      0 127.0.0.1:2379          0.0.0.0:*               LISTEN      25167/etcdtcp        0      0 172.16.0.8:2380         0.0.0.0:*               LISTEN      25167/etcd
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>查看集群状态(可以看到etcd-0-17)</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@etcd-0-8 default.etcd]# etcdctl member list2d2e457c6a1a76cb: name=etcd-0-8 peerURLs=http://172.16.0.8:2380 clientURLs=http://127.0.0.1:2379,http://172.16.0.8:2379 isLeader=false56e0b6dad4c53d42: name=etcd-0-14 peerURLs=http://172.16.0.14:2380 clientURLs=http://127.0.0.1:2379,http://172.16.0.14:2379 isLeader=trued2d2e9fc758e6790: name=etcd-0-17 peerURLs=http://172.16.0.17:2380 clientURLs=http://127.0.0.1:2379,http://172.16.0.17:2379 isLeader=false[root@etcd-0-8 ~]# etcdctl cluster-healthmember 2d2e457c6a1a76cb is healthy: got healthy result from http://127.0.0.1:2379member 56e0b6dad4c53d42 is healthy: got healthy result from http://127.0.0.1:2379member d2d2e9fc758e6790 is healthy: got healthy result from http://127.0.0.1:2379cluster is healthy
</code></pre></td></tr></table>
</div>
</div><h2 id="五简单使用">五、简单使用</h2>
<h3 id="51-增加">5.1 增加</h3>
<ul>
<li>set</li>
</ul>
<p>指定某个键的值。例如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl set /testdir/testkey &#34;Hello world&#34;Hello world
</code></pre></td></tr></table>
</div>
</div><p>支持的选项包括：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--ttl &#39;0&#39; 该键值的超时时间(单位为秒)，不配置(默认为0)则永不超时--swap-with-value value 若该键现在的值是value，则进行设置操作--swap-with-index &#39;0&#39;   若该键现在的索引值是指定索引，则进行设置操作
</code></pre></td></tr></table>
</div>
</div><ul>
<li>mk</li>
</ul>
<p>如果给定的键不存在，则创建一个新的键值。例如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl mk /testdir/testkey &#34;Hello world&#34;Hello world
</code></pre></td></tr></table>
</div>
</div><p>当键存在的时候，执行该命令会报错，例如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl mk /testdir/testkey &#34;Hello world&#34;Error:  105: Key already exists (/testdir/testkey) [8]
</code></pre></td></tr></table>
</div>
</div><p>支持的选项为:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--ttl &#39;0&#39;  超时时间(单位为秒），不配置(默认为 0)。则永不超时
</code></pre></td></tr></table>
</div>
</div><ul>
<li>mkdir</li>
</ul>
<p>如果给定的键目录不存在，则创建一个新的键目录。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl mkdir testdir2
</code></pre></td></tr></table>
</div>
</div><p>支持的选项为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--ttl &#39;0&#39; 超时时间(单位为秒)，不配置(默认为0)则永不超时。
</code></pre></td></tr></table>
</div>
</div><ul>
<li>setdir</li>
</ul>
<p>创建一个键目录。如果目录不存在就创建，如果目录存在更新目录TTL。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl setdir testdir3
</code></pre></td></tr></table>
</div>
</div><p>支持的选项为:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--ttl &#39;0&#39; 超时时间(单位为秒)，不配置(默认为0)则永不超时。
</code></pre></td></tr></table>
</div>
</div><h3 id="52-删除">5.2 删除</h3>
<ul>
<li>rm</li>
</ul>
<p>删除某个键值。例如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl rm /testdir/testkeyPrevNode.Value: Hello
</code></pre></td></tr></table>
</div>
</div><p>当键不存在时，则会报错。例如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl rm /testdir/testkeyError:  100: Key not found (/testdir/testkey) [7]
</code></pre></td></tr></table>
</div>
</div><p>支持的选项为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--dir 如果键是个空目录或者键值对则删除--recursive 删除目录和所有子键--with-value  检查现有的值是否匹配--with-index &#39;0&#39;检查现有的index是否匹配
</code></pre></td></tr></table>
</div>
</div><ul>
<li>rmdir</li>
</ul>
<p>删除一个空目录，或者键值对。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl setdir dir1$ etcdctl rmdir dir1
</code></pre></td></tr></table>
</div>
</div><p>若目录不空，会报错:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl set /dir/testkey hihi$ etcdctl rmdir /dirError:  108: Directory not empty (/dir) [17]
</code></pre></td></tr></table>
</div>
</div><h3 id="53-更新">5.3 更新</h3>
<ul>
<li>update</li>
</ul>
<p>当键存在时，更新值内容。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl update /testdir/testkey &#34;Hello&#34;Hello
</code></pre></td></tr></table>
</div>
</div><p>当键不存在时，则会报错。例如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl update /testdir/testkey2 &#34;Hello&#34;Error:  100: Key not found (/testdir/testkey2) [6]
</code></pre></td></tr></table>
</div>
</div><p>支持的选项为:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--ttl &#39;0&#39; 超时时间(单位为秒)，不配置(默认为 0)则永不超时。
</code></pre></td></tr></table>
</div>
</div><ul>
<li>updatedir</li>
</ul>
<p>更新一个已经存在的目录。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl updatedir testdir2
</code></pre></td></tr></table>
</div>
</div><p>支持的选项为:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--ttl &#39;0&#39; 超时时间(单位为秒)，不配置(默认为0)则永不超时。
</code></pre></td></tr></table>
</div>
</div><h3 id="54-查询">5.4 查询</h3>
<ul>
<li>get</li>
</ul>
<p>获取指定键的值。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl get /testdir/testkeyHello world
</code></pre></td></tr></table>
</div>
</div><p>当键不存在时，则会报错。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl get /testdir/testkey2Error:  100: Key not found (/testdir/testkey2) [5]
</code></pre></td></tr></table>
</div>
</div><p>支持的选项为:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--sort 对结果进行排序--consistent 将请求发给主节点，保证获取内容的一致性。
</code></pre></td></tr></table>
</div>
</div><ul>
<li>ls</li>
</ul>
<p>列出目录(默认为根目录)下的键或者子目录，默认不显示子目录中内容。</p>
<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl ls/testdir/testdir2/dir$ etcdctl ls dir/dir/testkey
</code></pre></td></tr></table>
</div>
</div><p>支持的选项包括:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--sort 将输出结果排序--recursive 如果目录下有子目录，则递归输出其中的内容-p 对于输出为目录，在最后添加/进行区分
</code></pre></td></tr></table>
</div>
</div><h3 id="55-watch">5.5 watch</h3>
<ul>
<li>watch</li>
</ul>
<p>监测一个键值的变化，一旦键值发生更新，就会输出最新的值并退出。
例如:用户更新testkey键值为Hello watch。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl get /testdir/testkeyHello world$ etcdctl set /testdir/testkey &#34;Hello watch&#34;Hello watch$ etcdctl watch testdir/testkeyHello watch
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>复制代码支持的选项包括:</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--forever  一直监测直到用户按CTRL+C退出--after-index &#39;0&#39; 在指定index之前一直监测--recursive 返回所有的键值和子键值
</code></pre></td></tr></table>
</div>
</div><ul>
<li>exec-watch</li>
</ul>
<p>监测一个键值的变化，一旦键值发生更新，就执行给定命令。
例如：用户更新testkey键值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl exec-watch testdir/testkey -- sh -c &#39;ls&#39;config    Documentation  etcd  etcdctl  README-etcdctl.md  README.md  READMEv2-etcdctl.md
</code></pre></td></tr></table>
</div>
</div><p>支持的选项包括:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--after-index &#39;0&#39; 在指定 index 之前一直监测--recursive 返回所有的键值和子键值
</code></pre></td></tr></table>
</div>
</div><h3 id="56-备份">5.6 备份</h3>
<p>备份etcd的数据。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl backup --data-dir /var/lib/etcd  --backup-dir /home/etcd_backup
</code></pre></td></tr></table>
</div>
</div><p>支持的选项包括:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--data-dir  etcd的数据目录--backup-dir 备份到指定路径
</code></pre></td></tr></table>
</div>
</div><h3 id="57-member">5.7 member</h3>
<p>通过<code>list</code> 、<code>add</code> 、<code>remove</code> 命令列出、添加、删除 etcd 实例到 etcd 集群中。</p>
<p>查看集群中存在的节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl member list8e9e05c52164694d: name=dev-master-01 peerURLs=http://localhost:2380 clientURLs=http://localhost:2379 isLeader=true
</code></pre></td></tr></table>
</div>
</div><p>删除集群中存在的节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl member remove 8e9e05c52164694dRemoved member 8e9e05c52164694d from cluster
</code></pre></td></tr></table>
</div>
</div><p>向集群中新加节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ etcdctl member add etcd3 http://192.168.1.100:2380Added member named etcd3 with ID 8e9e05c52164694d to cluster
</code></pre></td></tr></table>
</div>
</div><h3 id="示例">示例</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 设置一个key值[root@etcd-0-8 ~]# etcdctl set /msg &#34;hello k8s&#34;hello k8s# 获取key的值[root@etcd-0-8 ~]# etcdctl get /msghello k8s# 获取key值的详细信息[root@etcd-0-8 ~]# etcdctl -o extended get /msgKey: /msgCreated-Index: 12Modified-Index: 12TTL: 0Index: 12hello k8s# 获取不存在的key回报错[root@etcd-0-8 ~]# etcdctl get /xxzxError:  100: Key not found (/xxzx) [12]# 设置key的ttl，过期后会被自动删除[root@etcd-0-8 ~]# etcdctl set /testkey &#34;tmp key test&#34; --ttl 5tmp key test[root@etcd-0-8 ~]# etcdctl get /testkeyError:  100: Key not found (/testkey) [14]# key 替换操作[root@etcd-0-8 ~]# etcdctl get /msghello k8s[root@etcd-0-8 ~]# etcdctl set --swap-with-value &#34;hello k8s&#34; /msg &#34;goodbye&#34;goodbye[root@etcd-0-8 ~]# etcdctl get /msggoodbye# mk 仅当key不存在时创建(set对同一个key会覆盖)[root@etcd-0-8 ~]# etcdctl get /msggoodbye[root@etcd-0-8 ~]# etcdctl mk /msg &#34;mktest&#34;Error:  105: Key already exists (/msg) [18][root@etcd-0-8 ~]# etcdctl mk /msg1 &#34;mktest&#34;mktest# 创建自排序的key[root@etcd-0-8 ~]# etcdctl mk --in-order /queue s1s1[root@etcd-0-8 ~]# etcdctl mk --in-order /queue s2s2[root@etcd-0-8 ~]# etcdctl ls --sort /queue/queue/00000000000000000021/queue/00000000000000000022[root@etcd-0-8 ~]# etcdctl get /queue/00000000000000000021s1# 更新key值[root@etcd-0-8 ~]# etcdctl update /msg1 &#34;update test&#34;update test[root@etcd-0-8 ~]# etcdctl get /msg1update test# 更新key的ttl及值[root@etcd-0-8 ~]# etcdctl update --ttl 5 /msg &#34;aaa&#34;aaa# 创建目录[root@etcd-0-8 ~]# etcdctl mkdir /testdir# 删除空目录[root@etcd-0-8 ~]# etcdctl mkdir /test1[root@etcd-0-8 ~]# etcdctl rmdir /test1# 删除非空目录[root@etcd-0-8 ~]# etcdctl get /testdir/testdir: is a directory[root@etcd-0-8 ~]#[root@etcd-0-8 ~]# etcdctl rm --recursive /testdir# 列出目录内容[root@etcd-0-8 ~]# etcdctl ls //tmp/msg1/queue[root@etcd-0-8 ~]# etcdctl ls /tmp/tmp/a/tmp/b# 递归列出目录的内容[root@etcd-0-8 ~]# etcdctl ls --recursive //msg1/queue/queue/00000000000000000021/queue/00000000000000000022/tmp/tmp/b/tmp/a# 监听key，当key发生改变的时候打印出变化[root@etcd-0-8 ~]# etcdctl watch /msg1xxx[root@VM_0_17_centos ~]# etcdctl update /msg1 &#34;xxx&#34;xxx# 监听某个目录，当目录中任何 node 改变的时候，都会打印出来[root@etcd-0-8 ~]# etcdctl watch --recursive /[update] /msg1xxx[root@VM_0_17_centos ~]# etcdctl update /msg1 &#34;xxx&#34;xxx# 一直监听，除非 `CTL + C` 导致退出监听[root@etcd-0-8 ~]# etcdctl watch --forever /# 监听目录，当发生变化时执行一条命令[root@etcd-0-8 ~]# etcdctl exec-watch --recursive / -- sh -c &#34;echo change&#34;change# backup[root@etcd-0-14 ~]# etcdctl backup --data-dir /data/app/etcd --backup-dir /root/etcd_backup2019-12-04 10:25:16.113237 I | ignoring EntryConfChange raft entry2019-12-04 10:25:16.113268 I | ignoring EntryConfChange raft entry2019-12-04 10:25:16.113272 I | ignoring EntryConfChange raft entry2019-12-04 10:25:16.113293 I | ignoring member attribute update on /0/members/2d2e457c6a1a76cb/attributes2019-12-04 10:25:16.113299 I | ignoring member attribute update on /0/members/d2d2e9fc758e6790/attributes2019-12-04 10:25:16.113305 I | ignoring member attribute update on /0/members/56e0b6dad4c53d42/attributes2019-12-04 10:25:16.113310 I | ignoring member attribute update on /0/members/56e0b6dad4c53d42/attributes2019-12-04 10:25:16.113314 I | ignoring member attribute update on /0/members/2d2e457c6a1a76cb/attributes2019-12-04 10:25:16.113319 I | ignoring member attribute update on /0/members/d2d2e9fc758e6790/attributes2019-12-04 10:25:16.113384 I | ignoring member attribute update on /0/members/56e0b6dad4c53d42/attributes# 使用v3版本[root@etcd-0-14 ~]# export ETCDCTL_API=3[root@etcd-0-14 ~]# etcdctl --endpoints=&#34;http://172.16.0.8:2379,http://172.16.0.14:2379,http://172.16.0.17:2379&#34; snapshot save mysnapshot.dbSnapshot saved at mysnapshot.db[root@etcd-0-14 ~]# etcdctl snapshot status mysnapshot.db -w json{&#34;hash&#34;:928285884,&#34;revision&#34;:0,&#34;totalKey&#34;:5,&#34;totalSize&#34;:20480}
</code></pre></td></tr></table>
</div>
</div><h2 id="六总结">六、总结</h2>
<ul>
<li>
<p>etcd 默认只保存 1000 个历史事件，所以不适合有大量更新操作的场景，这样会导致数据的丢失。etcd 典型的应用场景是配置管理和服务发现，这些场景都是读多写少的。</p>
</li>
<li>
<p>相比于 zookeeper，etcd 使用起来要简单很多。不过要实现真正的服务发现功能，etcd 还需要和其他工具（比如 registrator、confd 等）一起使用来实现服务的自动注册和更新。</p>
</li>
<li>
<p>目前 etcd 还没有图形化的工具。</p>
</li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title"></span>
    <span class="item-content">gzxb0712</span>
  </p>
  <p class="copyright-item">
    <span class="item-title"></span>
    <span class="item-content">
        2020-03-28 22:03
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title"></span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/gzxb0712/blog/blob/master/LICENSE">MIT</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward"></label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/wechat.png">
        <span></span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/alipay.jpg">
        <span></span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/etcd/">etcd</a>
          <a href="/tags/center/">center</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/center/zookeeper_ops_doc/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">ZooKeeper 入门指引</span>
            <span class="prev-text nav-mobile"></span>
          </a>
        <a class="next" href="/post/apm/skywalking8_ops/">
            <span class="next-text nav-default">skywalking8.1部署及使用教程</span>
            <span class="next-text nav-mobile"></span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://www.cnblogs.com/gzxb0712" class="iconfont icon-cnblogs" title="cnblogs"></a>
      <a href="mailto:gzxb0712@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/gzxb0712" class="iconfont icon-github" title="github"></a>
      <a href="https://juejin.im/user/59aeb829f265da249960595a" class="iconfont icon-juejin" title="juejin"></a>
      <a href="https://www.v2ex.com/member/gzxb0712" class="iconfont icon-v2ex" title="v2ex"></a>
  <a href="https://xiebiao.top/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    %!(EXTRA string=<a class="hexo-link" href="https://gohugo.io">Hugo</a>)
  </span>
  <span class="division">|</span>
  <span class="theme-info">
     - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> %!(EXTRA string=<span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span>) </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> %!(EXTRA string=<span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span>) </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">gzxb0712</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-CN".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138883536-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>

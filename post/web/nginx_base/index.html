<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>nginx从入门到实战 - Bill World</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="gzxb0712" /><meta name="description" content="前言 Nginx 现在几乎是众多大型网站的必用技术，大家应该都知道 Nginx 被 F5 收购 的大事件，章亦春也在专心维护 OpenResty 项目构建和谐家园，无论你选择 Nginx 还是 OpenRe" /><meta name="keywords" content="Mac, Github, Vue, React, Front End" />






<meta name="generator" content="Hugo 0.93.0-DEV with theme even" />


<link rel="canonical" href="https://gzxb0712.gitee.io/blog/post/web/nginx_base/" />
<link rel="apple-touch-icon" sizes="180x180" href="/blog/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/blog/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/blog/favicon-16x16.png">
<link rel="manifest" href="/blog/manifest.json">
<link rel="mask-icon" href="/blog/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/blog/sass/main.min.32d4dc642fec98c34c80bebb9c784c50771712b4a8a25d9f4dd9cce3534b426e.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/blog/css/reset-even.css">


<meta property="og:title" content="nginx从入门到实战" />
<meta property="og:description" content="前言 Nginx 现在几乎是众多大型网站的必用技术，大家应该都知道 Nginx 被 F5 收购 的大事件，章亦春也在专心维护 OpenResty 项目构建和谐家园，无论你选择 Nginx 还是 OpenRe" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://gzxb0712.gitee.io/blog/post/web/nginx_base/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-03-01T19:18:30+00:00" />
<meta property="article:modified_time" content="2020-03-01T19:18:30+00:00" />

<meta itemprop="name" content="nginx从入门到实战">
<meta itemprop="description" content="前言 Nginx 现在几乎是众多大型网站的必用技术，大家应该都知道 Nginx 被 F5 收购 的大事件，章亦春也在专心维护 OpenResty 项目构建和谐家园，无论你选择 Nginx 还是 OpenRe"><meta itemprop="datePublished" content="2020-03-01T19:18:30+00:00" />
<meta itemprop="dateModified" content="2020-03-01T19:18:30+00:00" />
<meta itemprop="wordCount" content="8292">
<meta itemprop="keywords" content="nginx,web," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="nginx从入门到实战"/>
<meta name="twitter:description" content="前言 Nginx 现在几乎是众多大型网站的必用技术，大家应该都知道 Nginx 被 F5 收购 的大事件，章亦春也在专心维护 OpenResty 项目构建和谐家园，无论你选择 Nginx 还是 OpenRe"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/blog/" class="logo">Bill World</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/blog/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/blog/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/blog/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/blog/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/blog/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/blog/" class="logo">Bill World</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/blog/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/blog/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/blog/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/blog/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/blog/about/">关于我</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">nginx从入门到实战</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-03-01 19:18 </span>
        <div class="post-category">
            <a href="/blog/categories/web/"> web </a>
            </div>
          <span class="more-meta"> 约 8292 字 </span>
          <span class="more-meta"> 预计阅读 17 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/blog/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#nginx-基础知识-nginx-基础知识nginx-基础知识"><a href="#Nginx-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86" title="Nginx 基础知识"></a>Nginx 基础知识</a></li>
    <li><a href="#nginx-正向代理与反向代理-nginx-正向代理与反向代理nginx-正向代理与反向代理"><a href="#nginx-%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86" title="nginx 正向代理与反向代理"></a>nginx 正向代理与反向代理</a></li>
    <li><a href="#nginx-基本配置-nginx-基本配置nginx-基本配置"><a href="#nginx-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE" title="nginx 基本配置"></a>nginx 基本配置</a></li>
    <li><a href="#location-匹配规则-location-匹配规则location-匹配规则"><a href="#location-%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99" title="location 匹配规则"></a>location 匹配规则</a></li>
    <li><a href="#nginx-日志-nginx-日志nginx-日志"><a href="#nginx-%E6%97%A5%E5%BF%97" title="nginx 日志"></a>nginx 日志</a>
      <ul>
        <li><a href="#access-log-访问日志-access_log-访问日志access_log-访问日志"><a href="#access-log-%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97" title="access_log 访问日志"></a>access_log 访问日志</a></li>
        <li><a href="#error-log-错误日志-error_log-错误日志error_log-错误日志"><a href="#error-log-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97" title="error_log 错误日志"></a>error_log 错误日志</a></li>
      </ul>
    </li>
    <li><a href="#nginx-负载均衡-nginx-负载均衡nginx-负载均衡"><a href="#nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" title="nginx 负载均衡"></a>nginx 负载均衡</a></li>
    <li><a href="#nginx-常用命令-nginx-常用命令nginx-常用命令"><a href="#nginx-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4" title="nginx 常用命令"></a>nginx 常用命令</a></li>
    <li><a href="#nginx-配置-nginx-配置nginx-配置"><a href="#nginx-%E9%85%8D%E7%BD%AE" title="nginx 配置"></a>nginx 配置</a>
      <ul>
        <li><a href="#第一部分全局块">第一部分：全局块</a></li>
        <li><a href="#第二部分events-块">第二部分：events 块：</a></li>
        <li><a href="#第三部分http块">第三部分：http块：</a></li>
      </ul>
    </li>
    <li><a href="#nginx配置实战">Nginx配置实战:</a>
      <ul>
        <li><a href="#nginx配置反向代理">nginx配置反向代理：</a></li>
        <li><a href="#nginx配置负载均衡">nginx配置负载均衡：</a></li>
        <li><a href="#nginx配置动静分离">nginx配置动静分离：</a></li>
      </ul>
    </li>
    <li><a href="#参考文章-参考文章参考文章"><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0" title="参考文章"></a>参考文章</a></li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="hint">
      <p>【注意】最后更新于 <span class="timeago" datetime="2020-03-01T19:18:30" title="March 1, 2020">March 1, 2020</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
    <div class="post-content">
      <!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h2 id="前言">前言</h2>
<p>Nginx 现在几乎是众多大型网站的必用技术，大家应该都知道 <a href="https://www.nginx.com/blog/nginx-joins-f5/">Nginx 被 F5 收购</a> 的大事件，章亦春也在专心维护 OpenResty 项目构建和谐家园，无论你选择 Nginx 还是 OpenResty，都需要对 Nginx 有一个比较全面的了解，日后才能做到事半功倍。本文以开发者必备的 Nginx 基础知识为主，在参考文章中罗列了目前比较优秀的 Nginx 和 OpenResty 参考教程，希望对大家有帮助。</p>
<blockquote>
<p>Nginx 基础知识从小白到入门</p>
</blockquote>
<p><strong>扩展阅读</strong></p>
<p><a href="https://nginx.org/">nginx.org</a></p>
<p><a href="https://www.nginx.com/">NGINX Plus</a></p>
<p><a href="https://openresty.org/">OpenResty</a></p>
<hr>
<h2 id="nginx-基础知识-nginx-基础知识nginx-基础知识"><a href="#Nginx-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86" title="Nginx 基础知识"></a>Nginx 基础知识</h2>
<blockquote>
<p>Nginx 是什么？</p>
</blockquote>
<p>Nginx 是一个 web 服务器，主要处理客户端和服务器的请求分发。</p>
<blockquote>
<p>特点和优势</p>
</blockquote>
<ol>
<li>高并发</li>
<li>热部署</li>
<li>快</li>
<li>低功耗</li>
<li>热部署</li>
</ol>
<blockquote>
<p>使用和扩展</p>
</blockquote>
<p>开源免费的 Nginx 与商业版 Nginx Plus，与之对应的是免费 OpenResty 与商业版 OpenResty</p>
<ul>
<li>开源版 <a href="https://nginx.org/">nginx.org</a></li>
<li>商业版 <a href="https://www.nginx.com/">NGINX Plus</a></li>
<li>阿里巴巴 <a href="https://tengine.taobao.org/">Tengine</a></li>
<li>开源版 <a href="https://openresty.org/">OpenResty</a></li>
<li>商业版 <a href="https://openresty.com/">OpenResty</a></li>
</ul>
<blockquote>
<p>陶辉《深入理解 Nginx》作者在极客时间上的讲义 PDF 已经介绍的非常详细了，如果觉得课程不错可以选择购买尽量少走弯路</p>
</blockquote>
<p><a href="https://github.com/russelltao/geektime-nginx">极客时间：nginx 核心知识 100 讲配置文件与代码分享</a></p>
<h2 id="nginx-正向代理与反向代理-nginx-正向代理与反向代理nginx-正向代理与反向代理"><a href="#nginx-%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86" title="nginx 正向代理与反向代理"></a>nginx 正向代理与反向代理</h2>
<blockquote>
<p>为了便于理解，首先先来了解一下一些基础知识，nginx 是一个高性能的反向代理服务器那么什么是反向代理呢？</p>
</blockquote>
<p>代理是在服务器和客户端之间假设的一层服务器，代理将接收客户端的请求并将它转发给服务器，然后将服务端的响应转发给客户端。</p>
<p>不管是正向代理还是反向代理，实现的都是上面的功能。</p>
<p>如果你对 <a href="https://wsgzao.github.io/post/osi/">OSI 七层模型与 TCP/IP 四层模型</a> 不是很熟悉可以再回顾下</p>
<p><a href="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191113180648.png"><img src="https://raw.githubusercontent.com/wsgzao/storage-public/master/img/20191113180648.png" alt=""></a></p>
<blockquote>
<p>正向代理</p>
</blockquote>
<p>正向代理（forward）意思是一个位于客户端和原始服务器 (origin server) 之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标 (原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。</p>
<p>正向代理是为我们服务的，即为客户端服务的，客户端可以根据正向代理访问到它本身无法访问到的服务器资源。</p>
<p>正向代理对我们是透明的，对服务端是非透明的，即服务端并不知道自己收到的是来自代理的访问还是来自真实客户端的访问。</p>
<blockquote>
<p>反向代理</p>
</blockquote>
<p>反向代理（Reverse Proxy）方式是指以代理服务器来接受 internet 上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。</p>
<p>反向代理是为服务端服务的，反向代理可以帮助服务器接收来自客户端的请求，帮助服务器做请求转发，负载均衡等。</p>
<p>反向代理对服务端是透明的，对我们是非透明的，即我们并不知道自己访问的是代理服务器，而服务器知道反向代理在为他服务。</p>
<h2 id="nginx-基本配置-nginx-基本配置nginx-基本配置"><a href="#nginx-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE" title="nginx 基本配置"></a>nginx 基本配置</h2>
<p>安装 nginx 时通常需要编译自己需要的模块，可以<a href="https://wsgzao.github.io/post/rpmbuild/">使用 rpmbuild 制作 Nginx 的 RPM 包</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">main                                # 全局配置

events {                            # nginx 工作模式配置
}

http {                                # http 设置
 ....

 server {                        # 服务器主机配置
 ....
 location {                    # 路由配置
 ....
 }

 location path {
 ....
 }

 location otherpath {
 ....
 }
 }

 server {
 ....

 location {
 ....
 }
 }

 upstream name {                    # 负载均衡配置
 ....
 }
}
</code></pre></td></tr></table>
</div>
</div><p>如果想要生成 nginx 规范配置，可以参考<a href="https://nginxconfig.io/">nginxconfig.io</a></p>
<p>下面是 <code>nginx</code> 一些配置中常用的内置全局变量，你可以在配置的任何位置使用它们。</p>
<table>
<thead>
<tr>
<th>变量名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$host</code></td>
<td>请求信息中的 <code>Host</code>，如果请求中没有 <code>Host</code> 行，则等于设置的服务器名</td>
</tr>
<tr>
<td><code>$request_method</code></td>
<td>客户端请求类型，如 <code>GET</code>、<code>POST</code></td>
</tr>
<tr>
<td><code>$remote_addr</code></td>
<td>客户端的 <code>IP</code> 地址</td>
</tr>
<tr>
<td><code>$args</code></td>
<td>请求中的参数</td>
</tr>
<tr>
<td><code>$content_length</code></td>
<td>请求头中的 <code>Content-length</code> 字段</td>
</tr>
<tr>
<td><code>$http_user_agent</code></td>
<td>客户端 agent 信息</td>
</tr>
<tr>
<td><code>$http_cookie</code></td>
<td>客户端 cookie 信息</td>
</tr>
<tr>
<td><code>$remote_addr</code></td>
<td>客户端的 IP 地址</td>
</tr>
<tr>
<td><code>$remote_port</code></td>
<td>客户端的端口</td>
</tr>
<tr>
<td><code>$server_protocol</code></td>
<td>请求使用的协议，如 <code>HTTP/1.0</code>、<code>HTTP/1.1</code></td>
</tr>
<tr>
<td><code>$server_addr</code></td>
<td>服务器地址</td>
</tr>
<tr>
<td><code>$server_name</code></td>
<td>服务器名称</td>
</tr>
<tr>
<td><code>$server_port</code></td>
<td>服务器的端口号</td>
</tr>
</tbody>
</table>
<h2 id="location-匹配规则-location-匹配规则location-匹配规则"><a href="#location-%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99" title="location 匹配规则"></a>location 匹配规则</h2>
<p>语法规则：<code>location [=|~|~*|^~] /uri/ { … }</code></p>
<table>
<thead>
<tr>
<th>模式</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>location = /uri</td>
<td>= 表示精确匹配，只有完全匹配上才能生效</td>
</tr>
<tr>
<td>location ^~ /uri</td>
<td>^~ 开头对 URL 路径进行前缀匹配，并且在正则之前。</td>
</tr>
<tr>
<td>location ~ pattern</td>
<td>开头表示区分大小写的正则匹配</td>
</tr>
<tr>
<td>location ~* pattern</td>
<td>开头表示不区分大小写的正则匹配</td>
</tr>
<tr>
<td>location /uri</td>
<td>不带任何修饰符，也表示前缀匹配，但是在正则匹配之后</td>
</tr>
<tr>
<td>location /</td>
<td>通用匹配，任何未匹配到其它 location 的请求都会匹配到，相当于 switch 中的 default</td>
</tr>
</tbody>
</table>
<p>前缀匹配时，Nginx 不对 url 做编码，因此请求为 <code>/static/20%/aa</code>，可以被规则 <code>^~ /static/ /aa</code> 匹配到（注意是空格）</p>
<p>多个 location 配置的情况下匹配顺序为:</p>
<ul>
<li>首先精确匹配 <code>=</code></li>
<li>其次前缀匹配 <code>^~</code></li>
<li>其次是按文件中顺序的正则匹配</li>
<li>然后匹配不带任何修饰的前缀匹配。</li>
<li>最后是交给 <code>/</code> 通用匹配</li>
<li>当有匹配成功时候，停止匹配，按当前匹配规则处理请求</li>
</ul>
<p>意：前缀匹配，如果有包含关系时，按最大匹配原则进行匹配。比如在前缀匹配：<code>location /dir01</code> 与 <code>location /dir01/dir02</code>，如有请求 <code>[http://localhost/dir01/dir02/file](http://localhost/dir01/dir02/file)</code> 将最终匹配到 <code>location /dir01/dir02</code></p>
<p>例子，有如下匹配规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">location = / {
 echo &#34;规则 A&#34;;
}
location = /login {
 echo &#34;规则 B&#34;;
}
location ^~ /static/ {
 echo &#34;规则 C&#34;;
}
location ^~ /static/files {
 echo &#34;规则 X&#34;;
}
location ~ .(gif|jpg|png|js|css)$ {
 echo &#34;规则 D&#34;;
}
location ~* .png$ {
 echo &#34;规则 E&#34;;
}
location /img {
 echo &#34;规则 Y&#34;;
}
location / {
 echo &#34;规则 F&#34;;
}
</code></pre></td></tr></table>
</div>
</div><p>那么产生的效果如下：</p>
<ul>
<li>访问根目录 <code>/</code>，比如 <code>[http://localhost/](http://localhost/)</code> 将匹配 <code>规则 A</code></li>
<li>访问 <code>[http://localhost/login](http://localhost/login)</code> 将匹配 <code>规则 B</code>，<code>[http://localhost/register](http://localhost/register)</code> 则匹配 <code>规则 F</code></li>
<li>访问 <code>[http://localhost/static/a.html](http://localhost/static/a.html)</code> 将匹配 <code>规则 C</code></li>
<li>访问 <code>[http://localhost/static/files/a.exe](http://localhost/static/files/a.exe)</code> 将匹配 <code>规则 X</code>，虽然 <code>规则 C</code> 也能匹配到，但因为最大匹配原则，最终选中了 <code>规则 X</code>。你可以测试下，去掉规则 X ，则当前 URL 会匹配上 <code>规则 C</code>。</li>
<li>访问 <code>[http://localhost/a.gif](http://localhost/a.gif)</code>, <code>[http://localhost/b.jpg](http://localhost/b.jpg)</code> 将匹配 <code>规则 D</code> 和 <code>规则 E</code> ，但是 <code>规则 D</code> 顺序优先，<code>规则 E</code> 不起作用，而 <code>[http://localhost/static/c.png](http://localhost/static/c.png)</code> 则优先匹配到 <code>规则 C</code></li>
<li>访问 <code>[http://localhost/a.PNG](http://localhost/a.PNG)</code> 则匹配 <code>规则 E</code> ，而不会匹配 <code>规则 D</code> ，因为 <code>规则 E</code> 不区分大小写。</li>
<li>访问 <code>[http://localhost/img/a.gif](http://localhost/img/a.gif)</code> 会匹配上 <code>规则 D</code>, 虽然 <code>规则 Y</code> 也可以匹配上，但是因为正则匹配优先，而忽略了 <code>规则 Y</code>。</li>
<li>访问 <code>[http://localhost/img/a.tiff](http://localhost/img/a.tiff)</code> 会匹配上 <code>规则 Y</code>。</li>
</ul>
<p>访问 <code>[http://localhost/category/id/1111](http://localhost/category/id/1111)</code> 则最终匹配到规则 F ，因为以上规则都不匹配，这个时候应该是 Nginx 转发请求给后端应用服务器，比如 FastCGI（php），tomcat（jsp），Nginx 作为反向代理服务器存在。</p>
<p><a href="https://juejin.im/post/5c89f96f518825573a5e630b">理解 Nginx 中 Server 和 Location 的匹配逻辑</a></p>
<h2 id="nginx-日志-nginx-日志nginx-日志"><a href="#nginx-%E6%97%A5%E5%BF%97" title="nginx 日志"></a>nginx 日志</h2>
<p>Nginx 日志主要有两种：access_log(访问日志) 和 error_log(错误日志)。</p>
<h3 id="access-log-访问日志-access_log-访问日志access_log-访问日志"><a href="#access-log-%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97" title="access_log 访问日志"></a>access_log 访问日志</h3>
<p>access_log 主要记录客户端访问 Nginx 的每一个请求，格式可以自定义。通过 access_log 你可以得到用户地域来源、跳转来源、使用终端、某个 URL 访问量等相关信息。</p>
<p>log_format 指令用于定义日志的格式，语法: <code>log_format name string;</code> 其中 name 表示格式名称，string 表示定义的格式字符串。log_format 有一个默认的无需设置的组合日志格式。</p>
<p>默认的无需设置的组合日志格式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">
log_format combined &#39;$remote_addr - $remote_user  [$time_local]  &#39;
 &#39; &#34;$request&#34;  $status  $body_bytes_sent  &#39;
 &#39; &#34;$http_referer&#34;  &#34;$http_user_agent&#34; &#39;;

</code></pre></td></tr></table>
</div>
</div><p>access_log 指令用来指定访问日志文件的存放路径（包含日志文件名）、格式和缓存大小，语法：<code>access_log path [format_name [buffer=size | off]];</code> 其中 path 表示访问日志存放路径，format_name 表示访问日志格式名称，buffer 表示缓存大小，off 表示关闭访问日志。</p>
<p>log_format 使用示例：在 access.log 中记录客户端 IP 地址、请求状态和请求时间</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">log_format myformat &#39;$remote_addr  $status  $time_local&#39;;
access_log logs/access.log  myformat;
</code></pre></td></tr></table>
</div>
</div><p>需要注意的是：log_format 配置必须放在 http 内，否则会出现警告。Nginx 进程设置的用户和组必须对日志路径有创建文件的权限，否则，会报错。</p>
<p>定义日志使用的字段及其作用：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>$remote_addr 与 $http_x_forwarded_for</td>
<td>记录客户端 IP 地址</td>
</tr>
<tr>
<td>$remote_user</td>
<td>记录客户端用户名称</td>
</tr>
<tr>
<td>$request</td>
<td>记录请求的 URI 和 HTTP 协议</td>
</tr>
<tr>
<td>$status</td>
<td>记录请求状态</td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>发送给客户端的字节数，不包括响应头的大小</td>
</tr>
<tr>
<td>$bytes_sent</td>
<td>发送给客户端的总字节数</td>
</tr>
<tr>
<td>$connection</td>
<td>连接的序列号</td>
</tr>
<tr>
<td>$connection_requests</td>
<td>当前通过一个连接获得的请求数量</td>
</tr>
<tr>
<td>$msec</td>
<td>日志写入时间。单位为秒，精度是毫秒</td>
</tr>
<tr>
<td>$pipe</td>
<td>如果请求是通过 HTTP 流水线 (pipelined) 发送，pipe 值为“p”，否则为“.”</td>
</tr>
<tr>
<td>$http_referer</td>
<td>记录从哪个页面链接访问过来的</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>记录客户端浏览器相关信息</td>
</tr>
<tr>
<td>$request_length</td>
<td>请求的长度（包括请求行，请求头和请求正文）</td>
</tr>
<tr>
<td>$request_time</td>
<td>请求处理时间，单位为秒，精度毫秒</td>
</tr>
<tr>
<td>$time_iso8601</td>
<td>ISO8601 标准格式下的本地时间</td>
</tr>
<tr>
<td>$time_local</td>
<td>记录访问时间与时区</td>
</tr>
</tbody>
</table>
<h3 id="error-log-错误日志-error_log-错误日志error_log-错误日志"><a href="#error-log-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97" title="error_log 错误日志"></a>error_log 错误日志</h3>
<p>error_log 主要记录客户端访问 Nginx 出错时的日志，格式不支持自定义。通过查看错误日志，你可以得到系统某个服务或 server 的性能瓶颈等。因此，将日志利用好，你可以得到很多有价值的信息。</p>
<p>error_log 指令用来指定错误日志，语法: <code>error_log path [level]</code>; 其中 path 表示错误日志存放路径，level 表示错误日志等级，日志等级包括 debug、info、notice、warn、error、crit、alert、emerg，从左至右，日志详细程度逐级递减，即 debug 最详细，emerg 最少，默认为 error。</p>
<p>注意：<code>error_log off</code> 并不能关闭错误日志记录，此时日志信息会被写入到文件名为 off 的文件当中。如果要关闭错误日志记录，可以使用如下配置：</p>
<p>Linux 系统把存储位置设置为空设备</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">
error_log /dev/null;

http {
 # ...
}
</code></pre></td></tr></table>
</div>
</div><p>Windows 系统把存储位置设置为空设备</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">error_log nul;

http {
 # ...
}

</code></pre></td></tr></table>
</div>
</div><p>另外 Linux 系统可以使用 tail 命令方便的查阅正在改变的文件, tail -f filename 会把 filename 里最尾部的内容显示在屏幕上, 并且不断刷新, 使你看到最新的文件内容。Windows 系统没有这个命令，你可以在网上找到动态查看文件的工具。</p>
<h2 id="nginx-负载均衡-nginx-负载均衡nginx-负载均衡"><a href="#nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" title="nginx 负载均衡"></a>nginx 负载均衡</h2>
<p>Upstream 指定后端服务器地址列表，在 server 中拦截响应请求，并将请求转发到 Upstream 中配置的服务器列表。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">upstream balanceServer {
 server 10.1.22.33:12345;
 server 10.1.22.34:12345;
 server 10.1.22.35:12345;
}

server {
 server_name  [fe.server.com](http://fe.server.com);
 listen 80;
 location /api {
 proxy_pass [http://balanceServer](http://balanceServer);
 }
}

</code></pre></td></tr></table>
</div>
</div><p>上面的配置只是指定了 nginx 需要转发的服务端列表，并没有指定分配策略。</p>
<p>默认情况下采用的是轮询策略，将所有客户端请求轮询分配给服务端。这种策略是可以正常工作的，但是如果其中某一台服务器压力太大，出现延迟，会影响所有分配在这台服务器下的用户。</p>
<h2 id="nginx-常用命令-nginx-常用命令nginx-常用命令"><a href="#nginx-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4" title="nginx 常用命令"></a>nginx 常用命令</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 快速关闭 Nginx，可能不保存相关信息，并迅速终止 web 服务</span>
nginx -s stop
<span class="c1"># 平稳关闭 Nginx，保存相关信息，有安排的结束 web 服务</span>
nginx -s quit
<span class="c1"># 因改变了 Nginx 相关配置，需要重新加载配置而重载</span>
nginx -s reload
<span class="c1"># 重新打开日志文件</span>
nginx -s reopen
<span class="c1"># 为 Nginx 指定一个配置文件，来代替缺省的</span>
nginx -c filename
<span class="c1"># 不运行，而仅仅测试配置文件。nginx 将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件</span>
nginx -t
<span class="c1">#  显示 nginx 的版本</span>
nginx -v
<span class="c1"># 显示 nginx 的版本，编译器版本和配置参数</span>
nginx -V
<span class="c1"># 格式换显示 nginx 配置参数</span>
2&gt;<span class="p">&amp;</span><span class="m">1</span> nginx -V <span class="p">|</span> xargs -n1
2&gt;<span class="p">&amp;</span><span class="m">1</span> nginx -V <span class="p">|</span> xargs -n1 <span class="p">|</span> grep lua

</code></pre></td></tr></table>
</div>
</div><h2 id="nginx-配置-nginx-配置nginx-配置"><a href="#nginx-%E9%85%8D%E7%BD%AE" title="nginx 配置"></a>nginx 配置</h2>
<p>使用vim打开该配置文件，我们一探究竟，不同版本的配置文件可能稍有不同，我的配置文件内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"># For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

http {
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
                      &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
                      &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  _;
        root         /usr/share/nginx/html;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }

}


</code></pre></td></tr></table>
</div>
</div><p>? ？ ?</p>
<p>这一堆都是啥玩意er，完全没有头绪啊</p>
<p>没关系，下面我们就来详细分析一下nginx.conf这个文件中的内容。</p>
<p>按照功能划分，我们通常将nginx配置文件分为三大块，<strong>全局块，events块，http块</strong>。</p>
<h3 id="第一部分全局块">第一部分：全局块</h3>
<p>首先映入眼帘的这一堆：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

</code></pre></td></tr></table>
</div>
</div><p>我们称之为<strong>全局块</strong>，知识点呐朋友们，要记住，这里呢，主要会设置一些影响 nginx 服务器整体运行的配置指令，主要包括配 置运行 Nginx 服务器的用户（组）、允许生成的 worker process 数，进程 PID 存放路径、日志存放路径和类型以及配置文件的引入等。</p>
<p>比如 worker_processes auto； 这一行，worker_processes 值越大，我们nginx可支持的并发数量就越多，很多人想这不就爽了吗，我设置成正无穷，无限并发flag达成，秒杀问题轻松解决，这个，受自己服务器硬件限制的，不能乱来。</p>
<h3 id="第二部分events-块">第二部分：events 块：</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">events {
    worker_connections 1024;
}

</code></pre></td></tr></table>
</div>
</div><p>这一堆，就是我们配置文件的第二部分，<strong>events 块</strong></p>
<p>起名字这么随意的么，那第三部分是不是叫http块？</p>
<p>wc，这你都知道，是的</p>
<p>events 块涉及的指令主要影响 Nginx 服务器与用户的网络连接，常用的设置包括是否开启对多 work process 下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型来处理连接请求，每个 word process 可以同时支持的最大连接数等。</p>
<h3 id="第三部分http块">第三部分：http块：</h3>
<p>内容太多，略</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">http {
    server {
        }
}

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意：</p>
<p>http是一个大块，里面也可以包括很多小块，比如http全局块，server块等。</p>
</blockquote>
<p>http 全局块配置的指令包括文件引入、MIME-TYPE 定义、日志自定义、连接超时时间、单链接请求数上限等。</p>
<p>而http块中的server块则相当于一个虚拟主机，一个http块可以拥有多个server块。</p>
<p>server块又包括<strong>全局server</strong>块，和<strong>location</strong>块。</p>
<p>全局server块主要包括了本虚拟机主机的监听配置和本虚拟主机的名称或 IP 配置</p>
<p>location块则用来对虚拟主机名称之外的字符串进行匹配，对特定的请求进行处理。地址定向、数据缓 存和应答控制等功能，还有许多第三方模块的配置也在这里进行。比如，对/usr相关的请求交给8080来处理，/admin则较给8081处理。</p>
<p>说了这么多，我还是不是特别理解咋办，问题不大，接下来我们通过几个实例来帮助大家更好的理解这些配置在实际中所发挥的作用。</p>
<h2 id="nginx配置实战">Nginx配置实战:</h2>
<p>接下来我们将通过对nginx配置文件的修改来完成反向代理，负载均衡，动静分离的简单配置。</p>
<h3 id="nginx配置反向代理">nginx配置反向代理：</h3>
<p>我发现很多教程说nginx配置反向代理的时候上来就改host文件，这里的话，因为上一篇文章我们有总结过反向代理的精髓，也就是：</p>
<p><strong>反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器 IP 地址。</strong></p>
<p>所以接下来我们通过一个小栗子，当我们访问服务器的时候，由于我的服务器没备案，阿里云默认80端口没开，所以这里我们设置对外服务的端口为8888，<strong>当我们访问8888端口的时候，实际上是跳转到8080端口的。</strong></p>
<p>首先我们用docker启动一个tomcat容器，然后配置端口映射为8080。</p>
<p>等等，不会docker怎么办？不会docker的话，可以看韩数<strong>最新的docker初级入门教程（滑稽）</strong></p>
<p>如果对docker不是很了解的话，可以使用传统的linux下运行tomcat，道理是一样的。</p>
<p>然后修改我们的配置文件nginx.conf里面的server块，修改之后的内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">    server {
        listen       8888 ; ##设置我们nginx监听端口为8888
        server_name  [服务器的ip地址];

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
            proxy_pass http://127.0.0.1:8080; ##需要代理的服务器地址
            index index.html;
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }


</code></pre></td></tr></table>
</div>
</div><p>然后在浏览器中输入：服务器ip:8888 发现浏览器显示出来了8080端口tomcat的欢迎界面，从而实现了隐藏真实服务器地址这样一个反向代理的要求。</p>
<p>哦？看着好神奇哦，那，我之前经常有看到那种，就是各种/image /video 不同的链接对应的是不同的网站，那也是这么做的咯？</p>
<p>聪明，这里我们再新建一个tomcat容器，端口为8081，同时把在容器中tomcat webapps目录新建一个我们自己的目录，这里叫hello，里面新建一个hello.html文件，内容为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">&lt;h1&gt;I am Hello&lt;h1&gt;

</code></pre></td></tr></table>
</div>
</div><p>同时我们在端口为8080的tomcat容器中，在webapps新建我们的文件家hi，并新建hi.html文件，内容为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">&lt;h1&gt;I am Hi&lt;h1&gt;

</code></pre></td></tr></table>
</div>
</div><p>啊，这样的话配置是不是很难啊?</p>
<p>你想多了，敲简单的。</p>
<p>修改我们配置文件中的server快，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">    server {
        listen       8888 ; ##设置我们nginx监听端口为8888
        server_name  [服务器的ip地址];

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location /hi/ {
            proxy_pass http://127.0.0.1:8080; ##需要代理的服务器地址
            index index.html;
        }

        location /hello/ {
            proxy_pass http://127.0.0.1:8081; ##需要代理的服务器地址
            index index.html;
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }

</code></pre></td></tr></table>
</div>
</div><p>在浏览器中输入：服务器ip:8888/hi/hi.html</p>
<p>浏览器显示 <strong>I am hi</strong> 对应服务器端口为 8080</p>
<p>在浏览器中输入：服务器ip:8888/hello/hello.html</p>
<p>浏览器显示 <strong>I am hello</strong> 对应服务器端口为 8081</p>
<p>从而实现了针对不同url请求分发给不同服务器的功能配置。</p>
<p>少侠，且慢，你是不是忘了什么东西，location /hello/ 是什么意思，只能这么写么？</p>
<p>当然不是。学会location指令匹配路径，随便换姿势</p>
<p><strong>location指令说明:</strong></p>
<p>功能：用于匹配URL</p>
<p>语法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">1、= ：用于不含正则表达式的 uri 前，要求请求字符串与 uri 严格匹配，如果匹配
成功，就停止继续向下搜索并立即处理该请求。
2、~：用于表示 uri 包含正则表达式，并且区分大小写。
3、~*：用于表示 uri 包含正则表达式，并且不区分大小写。
4、^~：用于不含正则表达式的 uri 前，要求 Nginx 服务器找到标识 uri 和请求字
符串匹配度最高的 location 后，立即使用此 location 处理请求，而不再使用 location
块中的正则 uri 和请求字符串做匹配。

</code></pre></td></tr></table>
</div>
</div><p>注意:</p>
<blockquote>
<p>如果 uri 包含正则表达式，则必须要有 ~ 或者 ~* 标识。</p>
</blockquote>
<p>到这里，关于nginx如何简单的配置一个反向代理服务器就大功告成了，下面我们来说一下怎么实现负载均衡的简单配置。</p>
<h3 id="nginx配置负载均衡">nginx配置负载均衡：</h3>
<p>在nginx中配置负载均衡也是十分容易的，同时还支持了多种负载均衡策略供我们灵活选择。首先依旧是准备两个tomcat服务器，一个端口为8080，一个端口为8081，这里呢，推荐大家用docker部署，太方便了，什么，不会docker，可以移步我的面向后端的docker初级入门教程，真的挺好用，省了很多工作量。</p>
<p>然后修改我们的http块如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">http {

###此处省略一大堆没有改的配置

    ##自定义我们的服务列表
    upstream myserver{
       server 127.0.0.1:8080;
       server 127.0.0.1:8090;
     }

   server {
       listen       8888 ; ##设置我们nginx监听端口为8888
       server_name  [服务器的ip地址];

       # Load configuration files for the default server block.
       include /etc/nginx/default.d/*.conf;

       location / {
           proxy_pass http://myserver; ##叮，核心配置在这里
           proxy_connect_timeout 10; #超时时间，单位秒
       }

       error_page 404 /404.html;
           location = /40x.html {
       }

       error_page 500 502 503 504 /50x.html;
           location = /50x.html {
       }
   }

}


</code></pre></td></tr></table>
</div>
</div><p>这就完了?当然还没有，之前就有说过，nginx提供了三种不同的负载均衡策略供我们灵活选择，分别是：</p>
<ul>
<li>
<p><strong>轮询(默认方式):</strong> 每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器 down 掉，能自动剔除。</p>
<p>用法：啥也不加，上文实例就是默认的方式，就是默认的</p>
</li>
<li>
<p><strong>权重(weight):</strong> weight 代表权重,默认为 1,权重越高被分配的客户端越多,权重越大，能力越大，责任越大，处理的请求就越多。</p>
<p>用法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">     upstream myserver{
        server 127.0.0.1:8080 weight =1;
        server 127.0.0.1:8090 weight =2;
      }

</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ip_hash</strong>：每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决 session 的问题。</p>
<p>用法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"> upstream myserver{
       ip_hash;#可与weight配合使用
       server 127.0.0.1:8080 weight =1;
       server 127.0.0.1:8090 weight =2;
     }

</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="nginx配置动静分离">nginx配置动静分离：</h3>
<p>接下来说最后一个实例，动静分离的简单配置。</p>
<p>等等，我记得明明是四个，明明还有一个正向代理呢？</p>
<p>这个，爱国守法，人人有责，有需要访问某些国内不能访问的网站需求的同学，可以自行下去查阅资料。</p>
<p>至于怎么配置正向代理，咱也不知道，咱也不敢说，咱也不敢问。</p>
<p><strong>基础篇回顾：</strong></p>
<blockquote>
<p>动静分离就是把很少会发生修改的诸如图像，视频，css样式等静态资源文件放置在单独的服务器上，而动态请求则由另外一台服务器上进行，这样一来，负责动态请求的服务器则可以专注在动态请求的处理上，从而提高了我们程序的运行效率，与此同时，我们也可以针对我们的静态资源服务器做专属的优化，增加我们静态请求的响应速度。</p>
</blockquote>
<p>具体的动静分离配置也不是十分的复杂，和负载均衡，反向代理差不多。</p>
<p>为了演示动静分离呢，首先我们需要准备两个文件夹，一个是data文件夹，用来存放我们js，css这些静态资源文件，一个是html文件夹，用来存放我们的html文件。</p>
<p>在html文件夹新建一个html文件，index.html，内容如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&#34;UTF-8&#34;&gt;
    &lt;title&gt;我是一个静态界面&lt;/title&gt;
&lt;/head&gt;
&lt;script type=&#34;text/javascript&#34; src=&#34;jquery.js&#34;&gt;&lt;/script&gt;
&lt;body&gt;
&lt;h1&gt;我是一个静态界面&lt;/h1&gt;
&lt;div id=&#34;test_div&#34;&gt;&lt;/div&gt;
&lt;/body
&lt;/html&gt;


</code></pre></td></tr></table>
</div>
</div><p>注意，这里我们并没有将jquery.js 这个文件放在html目录下，而是将它放在了另外一个目录data里面，当服务器接需要请求jquery.js这个文件时，并不会去index.html所在的那个服务器去请求这个文件，而是会直接去我们配置好的服务器或者路径去寻找这个js文件，在本实例中，会去data文件夹下面去找这个jquery.js这个文件。</p>
<p>修改server的配置如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"> server {
        listen      8886 ;
        server_name [你的服务器ip地址];

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;

        location / {
            root /html/;
            index index.html;
        }

         #拦截静态资源，static里面存放的我们图片什么的静态资源
        location ~ .*\.(gif|jpg|jpeg|bmp|png|ico|js|css)$ {
        root /data/;
       }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }


</code></pre></td></tr></table>
</div>
</div><p>测试:</p>
<p>在浏览器中输入ip地址:8888/index.html,屏幕上显示我是一个静态界面，同时打开浏览器自带的开发者工具</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/10/30/16e1a8f4fbc01928?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p>
<p>会发现jquery.js已经被正常请求到了。</p>
<h2 id="参考文章-参考文章参考文章"><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0" title="参考文章"></a>参考文章</h2>
<blockquote>
<p>以上内容只是 nginx 的冰山一角，我个人推荐大家跟着官方文档或者类似极客时间的教程学习，可以少走很多弯路</p>
</blockquote>
<p><a href="https://nginx.org/en/docs/">nginx documentation</a></p>
<p><a href="http://www.conardli.top/blog/article/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E8%80%85%E5%BF%85%E5%A4%87%E7%9A%84nginx%E7%9F%A5%E8%AF%86.html">前端开发者必备的 nginx 知识</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA4Nzg5Nzc5OA==&amp;mid=2651674303&amp;idx=1&amp;sn=b34cbf009aac5f901ce81a65df06359f&amp;chksm=8bcb9516bcbc1c006ff36cd7a8a83d40c7b24143d0c76fc15f61bbb2c210355615125aa95d94&amp;mpshare=1&amp;scene=1&amp;srcid=1031DJIgeaaQj5fafJbAc3mg#rd">百万并发下 Nginx 的优化之道</a></p>
<p><a href="http://openresty.org/download/agentzh-nginx-tutorials-zhcn.html">agentzh 的 Nginx 教程</a></p>
<p><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/content/index.html">OpenResty 最佳实践</a></p>
<blockquote>
<p>以下为极客时间专栏</p>
</blockquote>
<p><a href="https://time.geekbang.org/course/intro/138">Nginx 核心知识 100 讲</a></p>
<p><a href="https://github.com/russelltao/geektime-nginx">极客时间：nginx 核心知识 100 讲配置文件与代码分享</a></p>
<p><a href="https://time.geekbang.org/column/intro/186">OpenResty 从入门到实战</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">gzxb0712</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-03-01 19:18
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/gzxb0712/blog/blob/master/LICENSE">MIT</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/wechat.png">
        <span>微信佛系打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/alipay.jpg">
        <span>支付宝佛系打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/blog/tags/nginx/">nginx</a>
          <a href="/blog/tags/web/">web</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/blog/post/web/tomcat_centos_install/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Centos部署tomcat9</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/blog/post/web/apache_centos_install/">
            <span class="next-text nav-default">Centos部署apache2&#43;mysql8&#43;php7</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://www.cnblogs.com/gzxb0712" class="iconfont icon-cnblogs" title="cnblogs"></a>
      <a href="mailto:gzxb0712@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/gzxb0712" class="iconfont icon-github" title="github"></a>
      <a href="https://juejin.im/user/59aeb829f265da249960595a" class="iconfont icon-juejin" title="juejin"></a>
      <a href="https://www.v2ex.com/member/gzxb0712" class="iconfont icon-v2ex" title="v2ex"></a>
  <a href="https://gzxb0712.gitee.io/blog/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/blog/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/blog/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2019 - 
    2022
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">gzxb0712</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-CN".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>



<script type="text/javascript" src="/blog/js/main.min.2517c0eb67172a0bae917de4af59b10ca2531411a009d4c0b82f5685259e5771.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138883536-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
